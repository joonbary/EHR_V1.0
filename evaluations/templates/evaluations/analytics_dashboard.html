{% extends 'base_revolutionary.html' %}
{% load static %}

{% block title %}í‰ê°€ ë¶„ì„ ëŒ€ì‹œë³´ë“œ | OK Financial Group{% endblock %}

{% block extra_css %}
<style>
    .analytics-container {
        padding: 2rem;
    }
    
    .chart-card {
        background: var(--bg-card);
        border: 1px solid var(--border-default);
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: var(--shadow-card);
    }
    
    .chart-title {
        color: var(--primary-color);
        font-size: 1.3rem;
        font-weight: 600;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .stat-card {
        background: linear-gradient(135deg, var(--bg-card), var(--bg-card-hover));
        border: 1px solid var(--border-feature);
        border-radius: 12px;
        padding: 1.5rem;
        text-align: center;
        transition: all 0.3s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-feature);
    }
    
    .stat-value {
        font-size: 2.5rem;
        font-weight: 700;
        background: var(--text-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    
    .stat-label {
        color: var(--text-secondary);
        margin-top: 0.5rem;
    }
    
    .chart-container {
        position: relative;
        height: 400px;
        margin: 1rem 0;
    }
    
    .filter-bar {
        background: var(--bg-card);
        border: 1px solid var(--border-default);
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 2rem;
        display: flex;
        gap: 1rem;
        align-items: center;
    }
    
    .filter-select {
        background: var(--bg-card-hover);
        border: 1px solid var(--border-default);
        color: var(--text-primary);
        padding: 0.5rem 1rem;
        border-radius: 6px;
        cursor: pointer;
    }
</style>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="analytics-container">
    <!-- Header -->
    <div class="mb-5">
        <h1 style="color: var(--primary-color); font-size: 2.5rem; font-weight: 700;">
            ğŸ“Š í‰ê°€ ë¶„ì„ ëŒ€ì‹œë³´ë“œ
        </h1>
        <p style="color: var(--text-secondary); margin-top: 0.5rem;">
            ì‹¤ì‹œê°„ í‰ê°€ ë°ì´í„° ë¶„ì„ ë° ì¸ì‚¬ì´íŠ¸
        </p>
    </div>
    
    <!-- Filter Bar -->
    <div class="filter-bar">
        <select id="periodFilter" class="filter-select">
            <option value="2024">2024ë…„</option>
            <option value="Q4">2024 4ë¶„ê¸°</option>
            <option value="Q3">2024 3ë¶„ê¸°</option>
        </select>
        <select id="departmentFilter" class="filter-select">
            <option value="all">ì „ì²´ ë¶€ì„œ</option>
            <option value="ê°œë°œíŒ€">ê°œë°œíŒ€</option>
            <option value="ë§ˆì¼€íŒ…íŒ€">ë§ˆì¼€íŒ…íŒ€</option>
            <option value="ì˜ì—…íŒ€">ì˜ì—…íŒ€</option>
        </select>
        <button onclick="refreshCharts()" class="btn-primary-ai">
            <i class="fas fa-sync-alt me-2"></i>ìƒˆë¡œê³ ì¹¨
        </button>
    </div>
    
    <!-- Statistics Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value" id="totalEmployees">0</div>
            <div class="stat-label">ì´ í‰ê°€ ëŒ€ìƒì</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="completionRate">0%</div>
            <div class="stat-label">í‰ê°€ ì™„ë£Œìœ¨</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="avgScore">0.0</div>
            <div class="stat-label">í‰ê·  ì ìˆ˜</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="topPerformers">0</div>
            <div class="stat-label">ìš°ìˆ˜ ì„±ê³¼ì</div>
        </div>
    </div>
    
    <!-- Charts Grid -->
    <div class="row">
        <!-- ë¶€ì„œë³„ í‰ê·  ì ìˆ˜ -->
        <div class="col-md-6">
            <div class="chart-card">
                <h3 class="chart-title">
                    <i class="fas fa-chart-bar"></i>
                    ë¶€ì„œë³„ í‰ê·  ì ìˆ˜
                </h3>
                <div class="chart-container">
                    <canvas id="departmentChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- í‰ê°€ ìœ í˜•ë³„ ë¶„í¬ -->
        <div class="col-md-6">
            <div class="chart-card">
                <h3 class="chart-title">
                    <i class="fas fa-chart-pie"></i>
                    í‰ê°€ ìœ í˜•ë³„ ë¶„í¬
                </h3>
                <div class="chart-container">
                    <canvas id="typeDistributionChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- ì›”ë³„ í‰ê°€ ì¶”ì´ -->
        <div class="col-md-12">
            <div class="chart-card">
                <h3 class="chart-title">
                    <i class="fas fa-chart-line"></i>
                    ì›”ë³„ í‰ê°€ ì¶”ì´
                </h3>
                <div class="chart-container" style="height: 300px;">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- ì„±ì¥ ë ˆë²¨ ë¶„í¬ -->
        <div class="col-md-6">
            <div class="chart-card">
                <h3 class="chart-title">
                    <i class="fas fa-layer-group"></i>
                    ì„±ì¥ ë ˆë²¨ ë¶„í¬
                </h3>
                <div class="chart-container">
                    <canvas id="growthLevelChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- í‰ê°€ ì ìˆ˜ íˆíŠ¸ë§µ -->
        <div class="col-md-6">
            <div class="chart-card">
                <h3 class="chart-title">
                    <i class="fas fa-th"></i>
                    í‰ê°€ ì ìˆ˜ ë¶„í¬
                </h3>
                <div class="chart-container">
                    <canvas id="scoreHeatmap"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Chart.js ê¸°ë³¸ ì„¤ì •
Chart.defaults.color = '#ffffff';
Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';

// ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ì €ì¥
let charts = {};

// ë°ì´í„° ë¡œë“œ ë° ì°¨íŠ¸ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    loadAnalyticsData();
});

function initializeCharts() {
    // ë¶€ì„œë³„ í‰ê·  ì ìˆ˜ ì°¨íŠ¸
    const deptCtx = document.getElementById('departmentChart').getContext('2d');
    charts.department = new Chart(deptCtx, {
        type: 'bar',
        data: {
            labels: ['ê°œë°œíŒ€', 'ë§ˆì¼€íŒ…íŒ€', 'ì˜ì—…íŒ€', 'ì¸ì‚¬íŒ€', 'ì¬ë¬´íŒ€'],
            datasets: [{
                label: 'ê¸°ì—¬ë„',
                data: [3.5, 3.2, 3.8, 3.3, 3.6],
                backgroundColor: 'rgba(0, 212, 255, 0.6)',
                borderColor: 'rgba(0, 212, 255, 1)',
                borderWidth: 1
            }, {
                label: 'ì „ë¬¸ì„±',
                data: [85, 78, 82, 80, 88],
                backgroundColor: 'rgba(0, 255, 136, 0.6)',
                borderColor: 'rgba(0, 255, 136, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
    
    // í‰ê°€ ìœ í˜•ë³„ ë¶„í¬ ì°¨íŠ¸
    const typeCtx = document.getElementById('typeDistributionChart').getContext('2d');
    charts.typeDistribution = new Chart(typeCtx, {
        type: 'doughnut',
        data: {
            labels: ['ê¸°ì—¬ë„ í‰ê°€', 'ì „ë¬¸ì„± í‰ê°€', 'ì˜í–¥ë ¥ í‰ê°€'],
            datasets: [{
                data: [45, 30, 25],
                backgroundColor: [
                    'rgba(0, 212, 255, 0.8)',
                    'rgba(0, 255, 136, 0.8)',
                    'rgba(255, 187, 51, 0.8)'
                ],
                borderColor: [
                    'rgba(0, 212, 255, 1)',
                    'rgba(0, 255, 136, 1)',
                    'rgba(255, 187, 51, 1)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right'
                }
            }
        }
    });
    
    // ì›”ë³„ í‰ê°€ ì¶”ì´ ì°¨íŠ¸
    const trendCtx = document.getElementById('trendChart').getContext('2d');
    charts.trend = new Chart(trendCtx, {
        type: 'line',
        data: {
            labels: ['1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”', '7ì›”', '8ì›”'],
            datasets: [{
                label: 'ì™„ë£Œëœ í‰ê°€',
                data: [12, 19, 23, 25, 32, 35, 41, 45],
                borderColor: 'rgba(0, 212, 255, 1)',
                backgroundColor: 'rgba(0, 212, 255, 0.1)',
                tension: 0.4
            }, {
                label: 'í‰ê·  ì ìˆ˜',
                data: [3.2, 3.3, 3.5, 3.4, 3.6, 3.7, 3.8, 3.9],
                borderColor: 'rgba(0, 255, 136, 1)',
                backgroundColor: 'rgba(0, 255, 136, 0.1)',
                tension: 0.4,
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    position: 'top'
                }
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    grid: {
                        drawOnChartArea: false
                    }
                },
                x: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.05)'
                    }
                }
            }
        }
    });
    
    // ì„±ì¥ ë ˆë²¨ ë¶„í¬ ì°¨íŠ¸
    const growthCtx = document.getElementById('growthLevelChart').getContext('2d');
    charts.growthLevel = new Chart(growthCtx, {
        type: 'polarArea',
        data: {
            labels: ['Lv.1 ì‹ ì…', 'Lv.2 ì¼ë°˜', 'Lv.3 ì „ë¬¸ê°€', 'Lv.4 ë¦¬ë”', 'Lv.5 ì„ì›'],
            datasets: [{
                data: [15, 35, 30, 15, 5],
                backgroundColor: [
                    'rgba(107, 114, 128, 0.8)',
                    'rgba(59, 130, 246, 0.8)',
                    'rgba(0, 212, 255, 0.8)',
                    'rgba(255, 187, 51, 0.8)',
                    'rgba(0, 255, 136, 0.8)'
                ],
                borderColor: [
                    'rgba(107, 114, 128, 1)',
                    'rgba(59, 130, 246, 1)',
                    'rgba(0, 212, 255, 1)',
                    'rgba(255, 187, 51, 1)',
                    'rgba(0, 255, 136, 1)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function loadAnalyticsData() {
    // API í˜¸ì¶œí•˜ì—¬ ì‹¤ì œ ë°ì´í„° ë¡œë“œ
    fetch('/evaluations/api/analytics/')
        .then(response => response.json())
        .then(data => {
            updateStatistics(data);
            updateCharts(data);
        })
        .catch(error => {
            console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            // ë”ë¯¸ ë°ì´í„°ë¡œ í‘œì‹œ
            updateStatistics({
                total_employees: 127,
                completion_rate: 73.2,
                avg_score: 3.5,
                top_performers: 18
            });
        });
}

function updateStatistics(data) {
    document.getElementById('totalEmployees').textContent = data.total_employees || 127;
    document.getElementById('completionRate').textContent = (data.completion_rate || 73.2) + '%';
    document.getElementById('avgScore').textContent = (data.avg_score || 3.5).toFixed(1);
    document.getElementById('topPerformers').textContent = data.top_performers || 18;
}

function updateCharts(data) {
    // ì°¨íŠ¸ ë°ì´í„° ì—…ë°ì´íŠ¸ ë¡œì§
    if (data.department_scores) {
        // ë¶€ì„œë³„ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
    }
    
    if (data.monthly_trends) {
        // ì›”ë³„ ì¶”ì´ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
    }
}

function refreshCharts() {
    // ì• ë‹ˆë©”ì´ì…˜ê³¼ í•¨ê»˜ ì°¨íŠ¸ ìƒˆë¡œê³ ì¹¨
    const button = event.target;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>ë¡œë”©ì¤‘...';
    
    setTimeout(() => {
        loadAnalyticsData();
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-sync-alt me-2"></i>ìƒˆë¡œê³ ì¹¨';
    }, 1000);
}
</script>
{% endblock %}