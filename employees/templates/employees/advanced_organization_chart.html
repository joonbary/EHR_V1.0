{% extends "base_revolutionary.html" %}
{% load static %}

{% block title %}Advanced Organization Chart - Refactored{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/advanced-org-chart.css' %}">
<style>
    /* Critical inline styles only */
    #chartViewport {
        position: relative;
        width: 100%;
        height: calc(100vh - 180px);
        overflow: auto;
        background: linear-gradient(180deg, #0b1324 0%, #0a0f1e 100%);
    }
    
    #treeContainer {
        position: relative;
        min-width: 100%;
        min-height: 100%;
        transform-origin: 0 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="org-chart-wrapper">
    <!-- Toolbar -->
    <div class="toolbar">
        <div class="toolbar-inner">
            <!-- Search Box -->
            <div class="org-search-box">
                <i class="fas fa-search org-search-icon"></i>
                <input type="text" 
                       id="orgSearch" 
                       class="org-search-input" 
                       placeholder="ì§ì› ë˜ëŠ” ë¶€ì„œ ê²€ìƒ‰..."
                       autocomplete="off">
                <div class="search-autocomplete" id="searchAutocomplete"></div>
            </div>
            
            <!-- View Controls -->
            <div class="view-controls">
                <button class="view-btn active" data-view="vertical">
                    <i class="fas fa-sitemap"></i> ì„¸ë¡œí˜•
                </button>
                <button class="view-btn" data-view="grid">
                    <i class="fas fa-th"></i> ê·¸ë¦¬ë“œ
                </button>
                <button class="view-btn" data-view="radial">
                    <i class="fas fa-circle-notch"></i> ë°©ì‚¬í˜•
                </button>
                <button class="view-btn" data-view="compact">
                    <i class="fas fa-compress"></i> ì••ì¶•í˜•
                </button>
            </div>
            
            <!-- Level Filters -->
            <div class="level-filters">
                <span style="color: #94a3b8; margin-right: 0.5rem;">ë ˆë²¨:</span>
                <button class="level-filter-btn active" data-level="all">ì „ì²´</button>
                <button class="level-filter-btn" data-level="executive">ì„ì›</button>
                <button class="level-filter-btn" data-level="division">ë³¸ë¶€</button>
                <button class="level-filter-btn" data-level="department">ë¶€ì„œ</button>
                <button class="level-filter-btn" data-level="team">íŒ€</button>
            </div>
            
            <!-- Depth Controls -->
            <div class="depth-controls">
                <button class="level-filter-btn" onclick="expandToDepth('OKê¸ˆìœµê·¸ë£¹', 2)" title="ë ˆë²¨ 2ê¹Œì§€ í¼ì¹¨">
                    ë ˆë²¨ 2ê¹Œì§€
                </button>
                <button class="level-filter-btn" onclick="expandToDepth('OKê¸ˆìœµê·¸ë£¹', 3)" title="ë ˆë²¨ 3ê¹Œì§€ í¼ì¹¨">
                    ë ˆë²¨ 3ê¹Œì§€
                </button>
                <button class="level-filter-btn" onclick="expandToDepth('OKê¸ˆìœµê·¸ë£¹', 4)" title="ë ˆë²¨ 4ê¹Œì§€ í¼ì¹¨">
                    ë ˆë²¨ 4ê¹Œì§€
                </button>
            </div>
            
            <!-- Zoom Controls -->
            <div class="zoom-controls">
                <button id="zoomOut" class="zoom-btn" title="ì¶•ì†Œ">
                    <i class="fas fa-minus"></i>
                </button>
                <span id="zoomLevel" class="zoom-level">100%</span>
                <button id="zoomIn" class="zoom-btn" title="í™•ëŒ€">
                    <i class="fas fa-plus"></i>
                </button>
                <button id="zoomReset" class="zoom-btn" title="ì´ˆê¸°í™”">
                    <i class="fas fa-undo"></i>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Breadcrumb Navigation -->
    <nav class="breadcrumb-nav" id="breadcrumbNav">
        <span class="breadcrumb-item active">OKê¸ˆìœµê·¸ë£¹</span>
    </nav>
    
    <!-- Main Chart Container -->
    <div id="chartViewport" class="chart-viewport">
        <div id="treeContainer"></div>
    </div>
    
    <!-- Minimap -->
    <div class="minimap" id="minimap">
        <canvas id="minimapCanvas"></canvas>
        <div class="minimap-viewport" id="minimapViewport"></div>
    </div>
    
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- External JavaScript Files - ë¡œë”© ìˆœì„œ ì¤‘ìš”! -->
<script src="{% static 'js/api-utils.js' %}"></script>
<script src="{% static 'js/org-chart-minimap.js' %}"></script>
<script src="{% static 'js/org-chart-api.js' %}"></script>
<script src="{% static 'js/advanced-org-chart.js' %}"></script>

<script>
// Minimal initialization code only
// ëª¨ë“  ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ í›„ ì´ˆê¸°í™”
function initializeOrgChart() {
    // Initialize with API endpoint
    const chartConfig = {
        container: 'treeContainer',
        apiEndpoint: '{% url "employees:org_tree_api" %}',
        csrfToken: '{{ csrf_token }}',
        initialZoom: 100,
        enableMinimap: true,
        enableSearch: true
    };
    
    // Debug logging
    console.log('ğŸ” Advanced Org Chart Debug Info:');
    console.log('- AdvancedOrgChart available:', typeof window.AdvancedOrgChart);
    console.log('- API endpoint:', chartConfig.apiEndpoint);
    console.log('- Container element:', document.getElementById(chartConfig.container));
    console.log('- Static files loaded:', {
        'advanced-org-chart.js': typeof window.AdvancedOrgChart,
        'org-chart-api.js': typeof window.OrgChartAPI,
        'org-chart-minimap.js': typeof window.OrgChartMinimap
    });
    
    // Initialize the chart
    if (window.AdvancedOrgChart) {
        try {
            window.orgChart = new AdvancedOrgChart(chartConfig);
            console.log('âœ… Advanced Organization Chart Initialized - Refactored Version');
        } catch (error) {
            console.error('âŒ Error initializing AdvancedOrgChart:', error);
        }
    } else {
        console.error('âŒ AdvancedOrgChart class not found - checking script loading...');
        console.log('- Document readyState:', document.readyState);
        console.log('- Scripts in head:', document.querySelectorAll('script[src*="advanced-org-chart"]').length);
    }
}

// ëª¨ë“  ìŠ¤í¬ë¦½íŠ¸ê°€ ë¡œë“œë  ë•Œê¹Œì§€ ëŒ€ê¸°
window.addEventListener('load', function() {
    // window.load ì´ë²¤íŠ¸ëŠ” ëª¨ë“  ë¦¬ì†ŒìŠ¤ê°€ ë¡œë“œëœ í›„ ë°œìƒ
    console.log('ğŸ”„ Starting org chart initialization...');
    initializeOrgChart();
});
</script>
{% endblock %}