{% extends "base_revolutionary.html" %}
{% load static %}

{% block title %}ì°¨ì„¸ëŒ€ ì¡°ì§ë„ | AI HRM{% endblock %}

{% block extra_css %}
<style>
    /* ê¸°ë³¸ ë ˆì´ì•„ì›ƒ - ê°€ë¡œ ìŠ¤í¬ë¡¤ ì°¨ë‹¨ */
    .org-chart-container {
        background: linear-gradient(180deg, #0b1324, #0a0f1e);
        min-height: calc(100vh - 70px);
        position: relative;
        display: flex;
        flex-direction: column;
        overflow-x: hidden; /* ê°€ë¡œ ìŠ¤í¬ë¡¤ ì°¨ë‹¨ */
    }

    /* íˆ´ë°” ìŠ¤íƒ€ì¼ */
    .org-toolbar {
        background: rgba(26, 31, 46, 0.95);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(0, 212, 255, 0.2);
        padding: 1rem;
        position: sticky;
        top: 0;
        z-index: 1000;
    }

    .toolbar-inner {
        display: flex;
        align-items: center;
        gap: 1.5rem;
        max-width: 1600px;
        margin: 0 auto;
    }

    /* ë·° ëª¨ë“œ ì„ íƒ */
    .view-modes {
        display: flex;
        gap: 0.5rem;
        background: rgba(10, 15, 27, 0.6);
        padding: 0.25rem;
        border-radius: 0.5rem;
        border: 1px solid rgba(0, 212, 255, 0.2);
    }

    .view-mode-btn {
        padding: 0.5rem 1rem;
        background: transparent;
        color: #94a3b8;
        border: none;
        border-radius: 0.375rem;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .view-mode-btn.active {
        background: linear-gradient(135deg, #00d4ff, #0099cc);
        color: white;
        box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
    }

    .view-mode-btn:hover:not(.active) {
        background: rgba(0, 212, 255, 0.1);
        color: #00d4ff;
    }

    /* ë ˆë²¨ í•„í„° */
    .level-filters {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    .level-filter-btn {
        padding: 0.375rem 0.75rem;
        background: rgba(0, 212, 255, 0.1);
        color: #00d4ff;
        border: 1px solid rgba(0, 212, 255, 0.3);
        border-radius: 0.375rem;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.813rem;
    }

    .level-filter-btn.active {
        background: rgba(0, 212, 255, 0.2);
        border-color: #00d4ff;
        box-shadow: 0 0 10px rgba(0, 212, 255, 0.2);
    }

    /* ê²€ìƒ‰ ë°•ìŠ¤ */
    .org-search-box {
        position: relative;
        flex: 1;
        max-width: 400px;
    }

    .org-search-input {
        width: 100%;
        padding: 0.625rem 1rem 0.625rem 2.5rem;
        background: rgba(10, 15, 27, 0.6);
        border: 1px solid rgba(0, 212, 255, 0.2);
        border-radius: 0.5rem;
        color: white;
        font-size: 0.875rem;
        transition: all 0.3s ease;
    }

    .org-search-input:focus {
        border-color: #00d4ff;
        box-shadow: 0 0 20px rgba(0, 212, 255, 0.2);
        outline: none;
    }

    .org-search-icon {
        position: absolute;
        left: 0.875rem;
        top: 50%;
        transform: translateY(-50%);
        color: #94a3b8;
    }

    /* ìë™ì™„ì„± ë“œë¡­ë‹¤ìš´ */
    .search-autocomplete {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        margin-top: 0.5rem;
        background: rgba(26, 31, 46, 0.98);
        border: 1px solid rgba(0, 212, 255, 0.2);
        border-radius: 0.5rem;
        max-height: 300px;
        overflow-y: auto;
        display: none;
        z-index: 1001;
    }

    .search-autocomplete.active {
        display: block;
    }

    .autocomplete-item {
        padding: 0.75rem 1rem;
        color: #cbd5e1;
        cursor: pointer;
        transition: all 0.2s ease;
        border-bottom: 1px solid rgba(0, 212, 255, 0.1);
    }

    .autocomplete-item:hover {
        background: rgba(0, 212, 255, 0.1);
        color: white;
    }

    .autocomplete-item-name {
        font-weight: 500;
        color: white;
    }

    .autocomplete-item-path {
        font-size: 0.75rem;
        color: #64748b;
        margin-top: 0.25rem;
    }

    /* ì¤Œ ì»¨íŠ¸ë¡¤ */
    .zoom-controls {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: rgba(10, 15, 27, 0.6);
        padding: 0.25rem;
        border-radius: 0.5rem;
        border: 1px solid rgba(0, 212, 255, 0.2);
    }

    .zoom-btn {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: transparent;
        color: #94a3b8;
        border: none;
        border-radius: 0.375rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .zoom-btn:hover {
        background: rgba(0, 212, 255, 0.1);
        color: #00d4ff;
    }

    .zoom-level {
        color: #00d4ff;
        font-size: 0.813rem;
        min-width: 50px;
        text-align: center;
    }

    /* ë©”ì¸ ì°¨íŠ¸ ì˜ì—­ - ê°€ë¡œ ìŠ¤í¬ë¡¤ ê¸ˆì§€ */
    .chart-viewport {
        flex: 1;
        position: relative;
        overflow-y: auto;
        overflow-x: hidden; /* ê°€ë¡œ ìŠ¤í¬ë¡¤ ê¸ˆì§€ */
        padding: 1rem;
        background: linear-gradient(to bottom, 
            rgba(10, 15, 27, 0.9),
            rgba(26, 31, 46, 0.95));
    }

    /* íŠ¸ë¦¬ ì»¨í…Œì´ë„ˆ - í™•ëŒ€ ê¸°ì¤€ ìƒë‹¨ ì¤‘ì•™ */
    .tree-container {
        min-height: 100%;
        position: relative;
        transition: transform 0.3s ease;
        transform-origin: top center; /* í™•ëŒ€ ê¸°ì¤€ì  */
        padding: 50px;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    /* TallNode ìŠ¤íƒ€ì¼ - ì„¸ë¡œ ê¸¸ì­‰í•œ ì¹´ë“œ (180Ã—300) */
    .org-node {
        position: absolute;
        background: rgba(14, 23, 40, 0.8); /* #0e1728/80 */
        border: 1px solid rgba(0, 212, 255, 0.3);
        border-radius: 1rem; /* rounded-2xl */
        width: 180px;
        min-height: 300px;
        max-height: 420px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.875rem;
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    
    /* ë…¸ë“œ ì™¼ìª½ ì„¸ë¡œ spine (íƒ€ì… í‘œì‹œ) */
    .node-spine {
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        width: 24px; /* w-6 */
        opacity: 0.7;
        border-radius: 1rem 0 0 1rem;
    }
    
    .node-spine.company {
        background: linear-gradient(to bottom, #06b6d4, transparent); /* cyan-500 */
    }
    
    .node-spine.division {
        background: linear-gradient(to bottom, #d946ef, transparent); /* fuchsia-500 */
    }
    
    .node-spine.department {
        background: linear-gradient(to bottom, #14b8a6, transparent); /* teal-500 */
    }
    
    .node-spine.team {
        background: linear-gradient(to bottom, #64748b, transparent); /* slate-500 */
    }
    
    .node-spine.person {
        background: linear-gradient(to bottom, #f59e0b, transparent); /* amber-500 */
    }

    .org-node:hover {
        border-color: #00d4ff;
        box-shadow: 0 0 30px rgba(0, 212, 255, 0.3);
        transform: translateY(-2px);
    }

    .org-node.focused {
        border-color: #00d4ff;
        box-shadow: 0 0 40px rgba(0, 212, 255, 0.5);
        background: rgba(0, 212, 255, 0.05);
    }

    .org-node.collapsed .node-children-info {
        display: block;
    }

    /* ë…¸ë“œ í—¤ë” */
    .node-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 0.5rem;
    }

    .node-type-badge {
        display: inline-block;
        padding: 0.125rem 0.5rem;
        background: rgba(0, 212, 255, 0.2);
        color: #00d4ff;
        border-radius: 0.25rem;
        font-size: 0.688rem;
        font-weight: 500;
        text-transform: uppercase;
    }

    .node-type-badge.company {
        background: rgba(168, 85, 247, 0.2);
        color: #a855f7;
    }

    .node-type-badge.division {
        background: rgba(236, 72, 153, 0.2);
        color: #ec4899;
    }

    .node-type-badge.department {
        background: rgba(34, 197, 94, 0.2);
        color: #22c55e;
    }

    .node-type-badge.team {
        background: rgba(251, 146, 60, 0.2);
        color: #fb923c;
    }

    /* ë…¸ë“œ ì½˜í…ì¸  - TallNode ë ˆì´ì•„ì›ƒ */
    .node-content {
        color: white;
        padding: 0.75rem;
        padding-left: 2rem; /* spine ê³µê°„ í™•ë³´ */
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        flex: 1;
    }

    .node-name {
        font-size: 0.75rem; /* text-[12px] */
        font-weight: 600;
        line-height: 1.2;
        color: rgba(255, 255, 255, 0.9);
        /* 3ì¤„ í´ë¨í”„ */
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .node-title {
        font-size: 0.688rem; /* text-[11px] */
        color: rgba(255, 255, 255, 0.6);
        line-height: 1.4;
        /* 2ì¤„ í´ë¨í”„ */
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* ë…¸ë“œ í†µê³„ ê·¸ë¦¬ë“œ */
    .node-stats {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.25rem;
        margin-top: 0.25rem;
    }

    .node-stat {
        background: rgba(255, 255, 255, 0.05);
        color: rgba(255, 255, 255, 0.7);
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.625rem; /* text-[10px] */
        text-align: center;
    }

    /* ë…¸ë“œ ë°°ì§€ */
    .node-badges {
        display: flex;
        flex-wrap: wrap;
        gap: 0.25rem;
        margin-top: 0.25rem;
    }
    
    .node-badge {
        padding: 0.125rem 0.375rem;
        background: rgba(16, 185, 129, 0.1); /* emerald-400/10 */
        color: #10b981; /* emerald-300 */
        border-radius: 0.25rem;
        font-size: 0.625rem; /* text-[10px] */
    }

    /* ì ‘ê¸°/í¼ì¹˜ê¸° ë²„íŠ¼ */
    .node-toggle {
        position: absolute;
        bottom: -12px;
        left: 50%;
        transform: translateX(-50%);
        width: 24px;
        height: 24px;
        background: rgba(26, 31, 46, 0.95);
        border: 1px solid rgba(0, 212, 255, 0.3);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: #00d4ff;
        transition: all 0.2s ease;
    }

    .node-toggle:hover {
        background: rgba(0, 212, 255, 0.2);
        border-color: #00d4ff;
    }

    /* í•˜ìœ„ ë…¸ë“œ ì •ë³´ (ì ‘íŒ ìƒíƒœ) */
    .node-children-info {
        display: none;
        margin-top: 0.5rem;
        padding-top: 0.5rem;
        border-top: 1px solid rgba(0, 212, 255, 0.1);
        font-size: 0.813rem;
        color: #00d4ff;
    }

    /* ì˜¤ë²„í”Œë¡œìš° í´ëŸ¬ìŠ¤í„° */
    .overflow-cluster {
        background: rgba(0, 212, 255, 0.05);
        border: 1px solid rgba(0, 212, 255, 0.2);
        border-radius: 0.5rem;
        padding: 0.75rem;
        margin-top: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
    }

    .overflow-cluster:hover {
        background: rgba(0, 212, 255, 0.1);
        border-color: #00d4ff;
    }

    .overflow-cluster-text {
        color: #00d4ff;
        font-size: 0.875rem;
    }

    /* ì—°ê²°ì„  */
    .org-edge {
        position: absolute;
        background: linear-gradient(to bottom, rgba(0, 212, 255, 0.3), transparent);
        width: 2px;
        transition: all 0.3s ease;
        pointer-events: none;
    }

    .org-edge.horizontal {
        height: 2px;
        width: auto;
        background: linear-gradient(to right, transparent, rgba(0, 212, 255, 0.3), transparent);
    }

    /* ë¯¸ë‹ˆë§µ */
    .minimap {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 200px;
        height: 120px;
        background: rgba(26, 31, 46, 0.95);
        border: 1px solid rgba(0, 212, 255, 0.3);
        border-radius: 0.5rem;
        padding: 0.5rem;
        z-index: 900;
    }

    .minimap-viewport {
        position: absolute;
        background: rgba(0, 212, 255, 0.2);
        border: 1px solid #00d4ff;
        pointer-events: none;
    }

    /* ë¸Œë ˆë“œí¬ëŸ¼ */
    .breadcrumb-nav {
        background: rgba(10, 15, 27, 0.6);
        padding: 0.75rem 1rem;
        border-bottom: 1px solid rgba(0, 212, 255, 0.1);
        display: flex;
        align-items: center;
        gap: 0.5rem;
        overflow-x: auto;
    }

    .breadcrumb-item {
        color: #64748b;
        font-size: 0.875rem;
        white-space: nowrap;
        cursor: pointer;
        transition: color 0.2s ease;
    }

    .breadcrumb-item:hover {
        color: #00d4ff;
    }

    .breadcrumb-separator {
        color: #475569;
    }

    .breadcrumb-item.active {
        color: white;
        font-weight: 500;
    }

    /* ë¡œë”© ìƒíƒœ */
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(10, 15, 27, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
    }

    .loading-spinner {
        width: 50px;
        height: 50px;
        border: 3px solid rgba(0, 212, 255, 0.2);
        border-top-color: #00d4ff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* ë°˜ì‘í˜• ë””ìì¸ */
    @media (max-width: 768px) {
        .toolbar-inner {
            flex-direction: column;
            gap: 1rem;
        }

        .org-search-box {
            max-width: 100%;
        }

        .minimap {
            width: 150px;
            height: 90px;
        }
    }

    /* ì‹œë§¨í‹± ì¤Œ ë ˆë²¨ */
    .tree-container.zoom-small .node-title,
    .tree-container.zoom-small .node-stats {
        display: none;
    }

    .tree-container.zoom-small .org-node {
        padding: 0.5rem;
        min-width: 150px;
    }

    .tree-container.zoom-large .org-node {
        padding: 1.25rem;
        min-width: 250px;
    }

    /* í‚¤ë³´ë“œ ë‚´ë¹„ê²Œì´ì…˜ í¬ì»¤ìŠ¤ */
    .org-node:focus {
        outline: 2px solid #00d4ff;
        outline-offset: 2px;
    }

    /* ì ‘ê·¼ì„± */
    .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
    }
    
    /* ì„¸ë¡œ ê¸€ì ìœ í‹¸ë¦¬í‹° (DenseTallNodeìš©) - CJK ìµœì í™” - ì‘ì—…ì§€ì‹œì„œ ì‚¬ì–‘ */
    .vertical-cjk {
        writing-mode: vertical-rl !important;
        text-orientation: upright !important; /* CJK ë¬¸ì ì§ë¦½ */
    }
    
    .vertical-mixed {
        writing-mode: vertical-rl !important;
        text-orientation: mixed !important; /* ì˜ë¬¸/ìˆ«ì ì„ì¼ ë•Œ */
    }
    
    .v-chip {
        writing-mode: vertical-rl !important;
        text-orientation: mixed !important;
        font-size: 10px !important;
        line-height: 1 !important;
    }
    
    /* DenseTallNode ìŠ¤íƒ€ì¼ - ì´ˆìŠ¬ë¦¼ ì„¸ë¡œ ì¹´ë“œ (40px í­ìœ¼ë¡œ ë” ì¶•ì†Œ) */
    .dense-node {
        width: 40px !important;
        min-height: 200px !important;
        max-height: 280px !important;
        padding: 0.25rem !important;
        background: rgba(14, 23, 40, 0.9) !important;
        border: 1px solid rgba(0, 212, 255, 0.3) !important;
    }
    
    .dense-node .node-content {
        padding: 0.5rem !important;
        padding-left: 1rem !important;
        display: flex !important;
        flex-direction: column !important;
        align-items: center !important;
        gap: 0.75rem !important;
        height: 100% !important;
    }
    
    /* Dense ë…¸ë“œ ì´ë¦„ - ì„¸ë¡œì“°ê¸° ê°•ì œ ì ìš© */
    .dense-node .node-name,
    .dense-node .vertical-cjk {
        writing-mode: vertical-rl !important;
        text-orientation: upright !important; /* ì‘ì—…ì§€ì‹œì„œ: CJK upright */
        max-height: 220px !important;
        overflow: hidden !important;
        flex: 1 !important;
        display: flex !important;
        align-items: center !important;
    }
    
    .dense-node .node-stats {
        display: flex !important;
        flex-direction: column !important;
        gap: 0.25rem !important;
    }
    
    /* Dense ë…¸ë“œ í†µê³„ ì¹© - ì„¸ë¡œì“°ê¸° ê°•ì œ ì ìš© */
    .dense-node .node-stat,
    .dense-node .v-chip {
        writing-mode: vertical-rl !important;
        text-orientation: mixed !important;
        font-size: 10px !important;
        padding: 0.25rem !important;
        background: rgba(255, 255, 255, 0.05) !important;
        color: rgba(255, 255, 255, 0.7) !important;
        border-radius: 0.25rem !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="org-chart-container">
    <!-- íˆ´ë°” -->
    <div class="org-toolbar">
        <div class="toolbar-inner">
            <!-- ë·° ëª¨ë“œ ì„ íƒ -->
            <div class="view-modes">
                <button class="view-mode-btn active" data-mode="vertical">
                    <i class="fas fa-sitemap"></i>
                    <span>ì„¸ë¡œí˜•</span>
                </button>
                <button class="view-mode-btn" data-mode="grid">
                    <i class="fas fa-th"></i>
                    <span>ê·¸ë¦¬ë“œ</span>
                </button>
                <button class="view-mode-btn" data-mode="radial">
                    <i class="fas fa-circle-notch"></i>
                    <span>ë°©ì‚¬í˜•</span>
                </button>
                <button class="view-mode-btn" data-mode="compact">
                    <i class="fas fa-list"></i>
                    <span>ì»´íŒ©íŠ¸</span>
                </button>
            </div>

            <!-- ë ˆë²¨ í•„í„° -->
            <div class="level-filters">
                <span style="color: #94a3b8; font-size: 0.875rem;">ë ˆë²¨:</span>
                <button class="level-filter-btn active" data-level="all">ì „ì²´</button>
                <button class="level-filter-btn" data-level="executive">ì„ì›</button>
                <button class="level-filter-btn" data-level="division">ë³¸ë¶€</button>
                <button class="level-filter-btn" data-level="department">ë¶€ì„œ</button>
                <button class="level-filter-btn" data-level="team">íŒ€</button>
            </div>

            <!-- ê²€ìƒ‰ -->
            <div class="org-search-box">
                <i class="fas fa-search org-search-icon"></i>
                <input type="text" class="org-search-input" placeholder="ì´ë¦„, ë¶€ì„œ, ì§ê¸‰ìœ¼ë¡œ ê²€ìƒ‰..." id="orgSearch">
                <div class="search-autocomplete" id="searchAutocomplete"></div>
            </div>

            <!-- ì¤Œ ì»¨íŠ¸ë¡¤ -->
            <div class="zoom-controls">
                <button class="zoom-btn" id="zoomOut">
                    <i class="fas fa-minus"></i>
                </button>
                <span class="zoom-level" id="zoomLevel">100%</span>
                <button class="zoom-btn" id="zoomIn">
                    <i class="fas fa-plus"></i>
                </button>
                <button class="zoom-btn" id="zoomReset">
                    <i class="fas fa-expand"></i>
                </button>
            </div>
            
            <!-- ê¹Šì´ í™•ì¥ ë²„íŠ¼ -->
            <div class="depth-controls" style="display: flex; gap: 0.5rem;">
                <button class="level-filter-btn" onclick="expandToDepth('OKê¸ˆìœµê·¸ë£¹', 2)" title="ë ˆë²¨ 2ê¹Œì§€ í¼ì¹¨">
                    <i class="fas fa-layer-group"></i> L2
                </button>
                <button class="level-filter-btn" onclick="expandToDepth('OKê¸ˆìœµê·¸ë£¹', 3)" title="ë ˆë²¨ 3ê¹Œì§€ í¼ì¹¨">
                    <i class="fas fa-layer-group"></i> L3
                </button>
                <button class="level-filter-btn" onclick="expandToDepth('OKê¸ˆìœµê·¸ë£¹', 4)" title="ë ˆë²¨ 4ê¹Œì§€ í¼ì¹¨">
                    <i class="fas fa-layer-group"></i> L4
                </button>
            </div>
        </div>
    </div>

    <!-- ë¸Œë ˆë“œí¬ëŸ¼ ë„¤ë¹„ê²Œì´ì…˜ -->
    <div class="breadcrumb-nav" id="breadcrumbNav">
        <span class="breadcrumb-item active">ì „ì²´ ì¡°ì§</span>
    </div>

    <!-- ë©”ì¸ ì°¨íŠ¸ ì˜ì—­ -->
    <div class="chart-viewport" id="chartViewport">
        <div class="tree-container" id="treeContainer">
            <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë  ì¡°ì§ë„ ë…¸ë“œë“¤ -->
        </div>

        <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-spinner"></div>
        </div>
    </div>

    <!-- ë¯¸ë‹ˆë§µ -->
    <div class="minimap" id="minimap">
        <div class="minimap-viewport"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// ì „ì—­ ìƒíƒœ ê´€ë¦¬
const OrgChartState = {
    currentView: 'vertical',
    currentLevel: 'all',
    zoomLevel: 100,
    focusedNode: null,
    expandedNodes: new Set(['OKê¸ˆìœµê·¸ë£¹']), // ë£¨íŠ¸ ë…¸ë“œë§Œ ì´ˆê¸° í¼ì¹¨
    searchQuery: '',
    nodes: new Map(),
    edges: [],
    clusteredSiblings: new Map(), // ì˜¤ë²„í”Œë¡œìš° í´ëŸ¬ìŠ¤í„°ë§ ìƒíƒœ
};

// ìƒìˆ˜ ì •ì˜ - ELK ë ˆì´ì•„ì›ƒìš© íŒŒë¼ë¯¸í„° ê°•í™”
const CONFIG = {
    MAX_VISIBLE_SIBLINGS: 12, // ìµœëŒ€ í‘œì‹œ í˜•ì œ ë…¸ë“œ ìˆ˜ (ì´ˆê³¼ì‹œ ë²„í‚· ê·¸ë£¹í™”)
    NODE_WIDTH: 120,  // TallNode ë„ˆë¹„ (ì¼ë°˜ ëª¨ë“œ) - ë” ì¶•ì†Œ
    NODE_WIDTH_DENSE: 40, // DenseTallNode ë„ˆë¹„ (ì´ˆìŠ¬ë¦¼ ëª¨ë“œ) - 40pxë¡œ ì¶•ì†Œ
    NODE_HEIGHT: 300, // ë…¸ë“œ ë†’ì´ (ì„¸ë¡œ ê¸¸ì­‰í•œ í˜•íƒœ)
    NODE_HEIGHT_DENSE: 300, // Dense ëª¨ë“œì—ì„œë„ ë™ì¼ ë†’ì´
    LEVEL_SPACING: 120,  // ë ˆë²¨ ê°„ê²© (ë ˆì´ì–´ ê°„ ê±°ë¦¬) - ì¶•ì†Œ
    SIBLING_SPACING: 30, // í˜•ì œ ê°„ê²© (ì¼ë°˜ ëª¨ë“œ) - ì¶•ì†Œ
    SIBLING_SPACING_DENSE: 15, // í˜•ì œ ê°„ê²© (Dense ëª¨ë“œ) - ë” ì¶•ì†Œ
    ZOOM_MIN: 30,  // ë” ì‘ê²Œ ì¶•ì†Œ ê°€ëŠ¥
    ZOOM_MAX: 200,
    ZOOM_STEP: 10,
    ZOOM_DENSE_THRESHOLD: 95, // 95% ë¯¸ë§Œì¼ ë•Œ DenseTallNode ì‚¬ìš©
    SEARCH_DELAY: 300,
    ANIMATION_DURATION: 300,
    MAX_WIDTH_PER_LEVEL: 2400, // ë ˆë²¨ë‹¹ ìµœëŒ€ ë„ˆë¹„ ì¦ê°€
    MIN_SPACING_RATIO: 0.6, // ìµœì†Œ ê°„ê²© ë¹„ìœ¨ (ìì‹ì´ ë§ì„ ë•Œ)
    COLLISION_PADDING: 20, // ì¶©ëŒ ê°ì§€ ì—¬ë°±
    BUCKET_THRESHOLD: 12, // ë²„í‚· ê·¸ë£¹í™” ì„ê³„ê°’ (>12 í˜•ì œ)
};

// ê·¸ë˜í”„ ê²€ì¦ ìœ í‹¸ë¦¬í‹° - ì²´ì¸(ì§ë ¬) ì—£ì§€ ê²€ì¶œ
function validateGraph(edges) {
    const childCount = new Map();
    edges.forEach(e => {
        childCount.set(e.source.id || e.source, 
            (childCount.get(e.source.id || e.source) || 0) + 1);
    });
    
    // ë¶€ëª¨ê°€ ê³„ì† 1ëª… ìì‹ë§Œ ê°€ì§€ëŠ” êµ¬ê°„ì€ ì²´ì¸ ì˜ì‹¬
    const singleChildParents = [];
    childCount.forEach((count, id) => {
        if (count === 1) {
            singleChildParents.push(id);
        }
    });
    
    // ì²´ì¸ ê¸¸ì´ ê³„ì‚°
    const chainLength = singleChildParents.length;
    const hasLongChain = chainLength > 3; // 3ê°œ ì´ìƒ ì—°ì†ì´ë©´ ê²½ê³ 
    
    if (hasLongChain) {
        console.warn(`Graph validation warning: Found chain of ${chainLength} single-child parents`, singleChildParents);
    }
    
    return { 
        singleChildParents, 
        chainLength,
        hasLongChain,
        isValid: !hasLongChain
    };
}

// ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
    console.log('Advanced Org Chart: DOM loaded, initializing...');
    
    try {
        initializeChart();
        setupEventListeners();
        setupKeyboardNavigation();
        
        // API ë°ì´í„° ë¡œë“œë¥¼ ì‹œë„í•˜ê³ , ì‹¤íŒ¨í•˜ë©´ ìƒ˜í”Œ ë°ì´í„° ì‚¬ìš©
        loadInitialData().catch((error) => {
            console.log('API failed, using sample data...', error);
            useSampleData();
        });
    } catch (error) {
        console.error('Initialization error:', error);
        // ì´ˆê¸°í™” ì‹¤íŒ¨ ì‹œ ìƒ˜í”Œ ë°ì´í„°ë¡œ ë°±ì—…
        useSampleData();
    }
});

// ì°¨íŠ¸ ì´ˆê¸°í™”
function initializeChart() {
    // ì´ˆê¸° ë·° ì„¤ì • (ì ì ˆí•œ ê· í˜•ì„ ìœ„í•´ 70% ì¤Œìœ¼ë¡œ ì‹œì‘)
    updateViewMode('vertical');
    updateZoom(70); // Dense ëª¨ë“œ í™œì„±í™”í•˜ë˜ ë” ì‘ì€ ì¤Œìœ¼ë¡œ ì „ì²´ ë·° ì œê³µ
    
    console.log('ğŸ’¡ ê³ ê¸‰ ì¡°ì§ë„ ì´ˆê¸°í™” ì™„ë£Œ - Dense ëª¨ë“œ í™œì„±í™” (70% ì¤Œ)');
}

// ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
function setupEventListeners() {
    console.log('Setting up event listeners...');
    
    // ë·° ëª¨ë“œ ë³€ê²½
    const viewModeBtns = document.querySelectorAll('.view-mode-btn');
    console.log(`Found ${viewModeBtns.length} view mode buttons`);
    viewModeBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            console.log('View mode clicked:', this.dataset.mode);
            const mode = this.dataset.mode;
            updateViewMode(mode);
        });
    });

    // ë ˆë²¨ í•„í„°
    const levelFilterBtns = document.querySelectorAll('.level-filter-btn');
    console.log(`Found ${levelFilterBtns.length} level filter buttons`);
    levelFilterBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            console.log('Level filter clicked:', this.dataset.level);
            const level = this.dataset.level;
            updateLevelFilter(level);
        });
    });

    // ê²€ìƒ‰
    const searchInput = document.getElementById('orgSearch');
    let searchTimeout;
    searchInput.addEventListener('input', function(e) {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            performSearch(e.target.value);
        }, CONFIG.SEARCH_DELAY);
    });

    // ì¤Œ ì»¨íŠ¸ë¡¤
    document.getElementById('zoomIn').addEventListener('click', () => {
        updateZoom(Math.min(OrgChartState.zoomLevel + CONFIG.ZOOM_STEP, CONFIG.ZOOM_MAX));
    });

    document.getElementById('zoomOut').addEventListener('click', () => {
        updateZoom(Math.max(OrgChartState.zoomLevel - CONFIG.ZOOM_STEP, CONFIG.ZOOM_MIN));
    });

    document.getElementById('zoomReset').addEventListener('click', () => {
        updateZoom(100);
    });

    // ë§ˆìš°ìŠ¤ íœ  ì¤Œ - ë¶€ë“œëŸ¬ìš´ ì „í™˜
    document.getElementById('chartViewport').addEventListener('wheel', function(e) {
        if (e.ctrlKey) {
            e.preventDefault();
            const delta = e.deltaY > 0 ? -CONFIG.ZOOM_STEP : CONFIG.ZOOM_STEP;
            const newZoom = Math.max(CONFIG.ZOOM_MIN, Math.min(CONFIG.ZOOM_MAX, OrgChartState.zoomLevel + delta));
            
            // Dense ëª¨ë“œ ì „í™˜ ì„ê³„ê°’ ê·¼ì²˜ì—ì„œ ë¶€ë“œëŸ¬ìš´ ì „í™˜
            const wasInDenseMode = OrgChartState.zoomLevel < CONFIG.ZOOM_DENSE_THRESHOLD;
            const willBeInDenseMode = newZoom < CONFIG.ZOOM_DENSE_THRESHOLD;
            
            if (wasInDenseMode !== willBeInDenseMode) {
                console.log(`Switching node mode: ${willBeInDenseMode ? 'Dense' : 'Normal'} at zoom ${newZoom}%`);
            }
            
            updateZoom(newZoom);
        }
    });
}

// í‚¤ë³´ë“œ ë‚´ë¹„ê²Œì´ì…˜ ì„¤ì •
function setupKeyboardNavigation() {
    document.addEventListener('keydown', function(e) {
        if (OrgChartState.focusedNode) {
            const node = OrgChartState.nodes.get(OrgChartState.focusedNode);
            if (!node) return;

            switch(e.key) {
                case 'ArrowUp':
                    e.preventDefault();
                    navigateToSibling(node, -1);
                    break;
                case 'ArrowDown':
                    e.preventDefault();
                    navigateToSibling(node, 1);
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    if (node.hasChildren && !OrgChartState.expandedNodes.has(node.id)) {
                        toggleNode(node.id);
                    } else if (node.children && node.children.length > 0) {
                        focusNode(node.children[0]);
                    }
                    break;
                case 'ArrowLeft':
                    e.preventDefault();
                    if (OrgChartState.expandedNodes.has(node.id)) {
                        toggleNode(node.id);
                    } else if (node.parentId) {
                        focusNode(node.parentId);
                    }
                    break;
                case 'Enter':
                    e.preventDefault();
                    if (node.hasChildren) {
                        toggleNode(node.id);
                    }
                    break;
                case '/':
                    e.preventDefault();
                    document.getElementById('orgSearch').focus();
                    break;
            }
        }
    });
}

// ì´ˆê¸° ë°ì´í„° ë¡œë“œ
async function loadInitialData() {
    showLoading(true);
    
    try {
        // APIì—ì„œ ì´ˆê¸° 2ë ˆë²¨ ë°ì´í„° ë¡œë“œ
        const response = await fetch('/employees/api/org/root?depth=5');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        
        console.log('Loaded org data:', data); // ë””ë²„ê¹…ìš©
        
        // ë…¸ë“œ ìƒì„± ë° ë Œë”ë§
        processOrgData(data);
        calculateLayout();  // ë ˆì´ì•„ì›ƒ ê³„ì‚° ì¶”ê°€
        renderChart();
        
    } catch (error) {
        console.error('Failed to load organization data:', error);
        showError('ì¡°ì§ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    } finally {
        showLoading(false);
    }
}

// ì¡°ì§ ë°ì´í„° ì²˜ë¦¬ (ë²„í‚· í´ëŸ¬ìŠ¤í„°ë§ ì ìš©)
function processOrgData(data) {
    // í˜•ì œ ë…¸ë“œ ë²„í‚· ì²˜ë¦¬ í•¨ìˆ˜
    function bucketSiblings(children, parentId, level) {
        if (!children || children.length === 0) return [];
        
        // BUCKET_THRESHOLDë¥¼ ì´ˆê³¼í•˜ë©´ ë²„í‚· ê·¸ë£¹í™”
        if (children.length > CONFIG.BUCKET_THRESHOLD) {
            const visibleChildren = children.slice(0, CONFIG.BUCKET_THRESHOLD);
            const hiddenChildren = children.slice(CONFIG.BUCKET_THRESHOLD);
            const hiddenCount = hiddenChildren.length;
            
            // í´ëŸ¬ìŠ¤í„° ID ìƒì„±
            const clusterId = `${parentId}-bucket-${Date.now()}`;
            
            // ìˆ¨ê²¨ì§„ ë…¸ë“œë“¤ ì €ì¥
            OrgChartState.clusteredSiblings.set(clusterId, hiddenChildren);
            
            // ë²„í‚· ë…¸ë“œ ìƒì„±
            const bucketNode = {
                id: clusterId,
                name: `+${hiddenCount} ë”ë³´ê¸°`,
                type: 'bucket',
                parentId: parentId,
                level: level,
                isCluster: true,
                hiddenChildren: hiddenChildren,
                hasChildren: false,
            };
            
            return [...visibleChildren, bucketNode];
        }
        
        return children;
    }
    
    // ì¬ê·€ì ìœ¼ë¡œ ë…¸ë“œ ì²˜ë¦¬
    function processNode(node, parentId = null, level = 0) {
        const processedNode = {
            ...node,
            parentId,
            level,
            x: 0,
            y: level * CONFIG.LEVEL_SPACING,
        };
        
        OrgChartState.nodes.set(node.id, processedNode);
        
        if (node.children && node.children.length > 0) {
            // ë²„í‚· í´ëŸ¬ìŠ¤í„°ë§ ì ìš©
            const bucketedChildren = bucketSiblings(node.children, node.id, level + 1);
            
            bucketedChildren.forEach(child => {
                if (child.isCluster) {
                    // ë²„í‚· ë…¸ë“œ ì²˜ë¦¬
                    OrgChartState.nodes.set(child.id, child);
                } else {
                    // ì¼ë°˜ ë…¸ë“œ ì²˜ë¦¬
                    processNode(child, node.id, level + 1);
                }
            });
        }
    }
    
    processNode(data);
    
    // ë ˆì´ì•„ì›ƒ ê³„ì‚°
    calculateLayout();
}

// PDF ìŠ¤íƒ€ì¼ ìˆ˜í‰ í™•ì¥ ë ˆì´ì•„ì›ƒ ê³„ì‚° (OKì €ì¶•ì€í–‰ ì¡°ì§ë„ í˜•íƒœ)
function calculateLayout() {
    const levelMap = new Map();
    let maxDepth = 0;
    
    // Dense ëª¨ë“œ íŒë³„ - ì¤Œ ë ˆë²¨ê³¼ ë·°ëª¨ë“œì— ë”°ë¼ ê²°ì •
    const isDenseMode = OrgChartState.zoomLevel < CONFIG.ZOOM_DENSE_THRESHOLD || 
                       OrgChartState.currentView === 'compact';
    
    // ë…¸ë“œ í¬ê¸° ì„¤ì • (Dense ëª¨ë“œì¼ ë•Œ ì´ˆìŠ¬ë¦¼ ì¹´ë“œ)
    const nodeWidth = isDenseMode ? CONFIG.NODE_WIDTH_DENSE : CONFIG.NODE_WIDTH;
    const nodeHeight = isDenseMode ? CONFIG.NODE_HEIGHT_DENSE : CONFIG.NODE_HEIGHT;  
    const siblingSpacing = isDenseMode ? CONFIG.SIBLING_SPACING_DENSE : CONFIG.SIBLING_SPACING;
    
    // ë Œë”ë§í•  ë…¸ë“œë§Œ í•„í„°ë§
    const visibleNodes = Array.from(OrgChartState.nodes.values()).filter(shouldRenderNode);
    console.log(`Layout calculation for ${visibleNodes.length} visible nodes`);
    
    // ì‹¤ì œ íŠ¸ë¦¬ ê¹Šì´ ê³„ì‚° ë° ë ˆë²¨ë³„ë¡œ ë…¸ë“œ ê·¸ë£¹í™”
    function calculateDepth(node, depth = 0) {
        if (!shouldRenderNode(node)) return; // ë Œë”ë§í•˜ì§€ ì•Šì„ ë…¸ë“œëŠ” ìŠ¤í‚µ
        
        node.treeDepth = depth;
        maxDepth = Math.max(maxDepth, depth);
        
        if (!levelMap.has(depth)) {
            levelMap.set(depth, []);
        }
        levelMap.get(depth).push(node);
        
        // ìì‹ ë…¸ë“œë“¤ì˜ ê¹Šì´ ê³„ì‚°
        visibleNodes.forEach(childNode => {
            if (childNode.parentId === node.id) {
                calculateDepth(childNode, depth + 1);
            }
        });
    }
    
    // ë£¨íŠ¸ ë…¸ë“œë¶€í„° ì‹œì‘
    visibleNodes.forEach(node => {
        if (!node.parentId) {
            calculateDepth(node, 0);
        }
    });
    
    // PDF ìŠ¤íƒ€ì¼ì˜ ìˆ˜í‰ í™•ì¥ ë ˆì´ì•„ì›ƒ (ì¶©ëŒ ë°©ì§€ í¬í•¨)
    levelMap.forEach((nodes, depth) => {
        if (depth === 0) {
            // ë£¨íŠ¸ ë…¸ë“œ(ëŒ€í‘œì´ì‚¬)ëŠ” ìƒë‹¨ ì¤‘ì•™ì—
            nodes.forEach(node => {
                node.x = 0;
                node.y = 50;
            });
        } else {
            // ê° ë ˆë²¨ì˜ ë…¸ë“œë“¤ì„ ìˆ˜í‰ìœ¼ë¡œ ë°°ì¹˜ (ë¶€ëª¨ ì¤‘ì‹¬ìœ¼ë¡œ)
            const levelY = 50 + depth * (nodeHeight + CONFIG.LEVEL_SPACING);
            
            // ë¶€ëª¨ë³„ë¡œ ê·¸ë£¹í™”
            const parentGroups = new Map();
            nodes.forEach(node => {
                const parentId = node.parentId;
                if (!parentGroups.has(parentId)) {
                    parentGroups.set(parentId, []);
                }
                parentGroups.get(parentId).push(node);
            });
            
            // ê° ë¶€ëª¨ ê·¸ë£¹ì˜ ìì‹ë“¤ì„ ë°°ì¹˜
            parentGroups.forEach((children, parentId) => {
                const parent = OrgChartState.nodes.get(parentId);
                if (!parent) return;
                
                // ìì‹ë“¤ì˜ ì´ ë„ˆë¹„ ê³„ì‚°
                const totalWidth = children.length * (nodeWidth + siblingSpacing) - siblingSpacing;
                const startX = parent.x - (totalWidth / 2);
                
                // ê° ìì‹ ë…¸ë“œ ë°°ì¹˜
                children.forEach((child, index) => {
                    child.x = startX + index * (nodeWidth + siblingSpacing) + (nodeWidth / 2);
                    child.y = levelY;
                    console.log(`Placed ${child.name} at x=${child.x}, y=${child.y} (parent: ${parent.name} at x=${parent.x})`);
                });
            });
            
            // ê²¹ì¹¨ ë°©ì§€ë¥¼ ìœ„í•œ ì¶©ëŒ ê°ì§€ ë° ì¡°ì •
            // ê°™ì€ Y ë ˆë²¨ì˜ ë…¸ë“œë“¤ì„ ê·¸ë£¹í™”
            const sameLevelNodes = nodes.filter(n => Math.abs(n.y - levelY) < 1);
            
            if (sameLevelNodes.length > 1) {
                // X ì¢Œí‘œ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬
                sameLevelNodes.sort((a, b) => a.x - b.x);
                
                // ê²¹ì¹¨ í•´ê²°
                for (let i = 1; i < sameLevelNodes.length; i++) {
                    const prev = sameLevelNodes[i - 1];
                    const curr = sameLevelNodes[i];
                    const minDistance = nodeWidth + siblingSpacing;
                    
                    if (curr.x - prev.x < minDistance) {
                        // ê²¹ì¹¨ ë°œìƒ - ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì´ë™
                        const shift = minDistance - (curr.x - prev.x);
                        console.log(`Collision detected: moving ${curr.name} by ${shift}px`);
                        for (let j = i; j < sameLevelNodes.length; j++) {
                            sameLevelNodes[j].x += shift;
                        }
                    }
                }
            }
        }
    });
    
    // ì—£ì§€ ìƒì„± (ì§ì„  ì—°ê²°)
    OrgChartState.edges = [];
    OrgChartState.nodes.forEach(node => {
        if (node.parentId) {
            const parent = OrgChartState.nodes.get(node.parentId);
            if (parent) {
                OrgChartState.edges.push({
                    source: parent,
                    target: node,
                    type: 'straight' // PDFì²˜ëŸ¼ ì§ì„  ì—°ê²°
                });
            }
        }
    });
}

// ì°¨íŠ¸ ë Œë”ë§
function renderChart() {
    console.log('Rendering chart. Current view:', OrgChartState.currentView, 'Current level:', OrgChartState.currentLevel);
    
    const container = document.getElementById('treeContainer');
    if (!container) {
        console.error('Tree container not found!');
        return;
    }
    
    container.innerHTML = '';
    
    // ë Œë”ë§í•  ë…¸ë“œ ìˆ˜ í™•ì¸
    const visibleNodes = Array.from(OrgChartState.nodes.values()).filter(shouldRenderNode);
    console.log(`Rendering ${visibleNodes.length} visible nodes out of ${OrgChartState.nodes.size} total nodes`);
    
    // ë·° ëª¨ë“œì— ë”°ë¥¸ íŠ¹í™”ëœ ë Œë”ë§
    if (OrgChartState.currentView === 'grid') {
        renderGridView();
    } else if (OrgChartState.currentView === 'radial') {
        renderRadialView();
    } else if (OrgChartState.currentView === 'compact') {
        renderCompactView();
    } else {
        // ê¸°ë³¸ ì„¸ë¡œí˜• ë·°
        renderVerticalView();
    }
}

// ì„¸ë¡œí˜• ë·° ë Œë”ë§
function renderVerticalView() {
    const container = document.getElementById('treeContainer');
    const viewport = document.getElementById('chartViewport');
    const viewportWidth = viewport.offsetWidth;
    
    // Dense ëª¨ë“œ íŒë³„ (ì¤Œ < 95% ë˜ëŠ” Compact Dense ë·°)
    const isDenseMode = OrgChartState.zoomLevel < CONFIG.ZOOM_DENSE_THRESHOLD || 
                        OrgChartState.currentView === 'compact';
    const nodeWidth = isDenseMode ? CONFIG.NODE_WIDTH_DENSE : CONFIG.NODE_WIDTH;
    const nodeHeight = isDenseMode ? CONFIG.NODE_HEIGHT_DENSE : CONFIG.NODE_HEIGHT;
    
    // ì»¨í…Œì´ë„ˆ ìµœì†Œ í¬ê¸° ì„¤ì •
    let minX = 0, maxX = 0, maxY = 0;
    
    // ë…¸ë“œ ìœ„ì¹˜ ë²”ìœ„ ê³„ì‚°
    OrgChartState.nodes.forEach(node => {
        if (shouldRenderNode(node)) {
            minX = Math.min(minX, node.x);
            maxX = Math.max(maxX, node.x);
            maxY = Math.max(maxY, node.y);
        }
    });
    
    // ì»¨í…Œì´ë„ˆ í¬ê¸° ì„¤ì •
    const containerWidth = Math.max(viewportWidth, (maxX - minX) + nodeWidth + 200);
    const containerHeight = maxY + nodeHeight + 200;
    
    container.style.width = `${containerWidth}px`;
    container.style.height = `${containerHeight}px`;
    
    // ì¤‘ì•™ ì •ë ¬ ì˜¤í”„ì…‹
    const offsetX = containerWidth / 2;
    
    // ë…¸ë“œ ë Œë”ë§ (Dense ë˜ëŠ” Normal ëª¨ë“œ)
    OrgChartState.nodes.forEach(node => {
        if (shouldRenderNode(node)) {
            // Dense ëª¨ë“œì¼ ë•ŒëŠ” createDenseNodeElement ì‚¬ìš©
            const nodeElement = isDenseMode ? 
                createDenseNodeElement(node) : 
                createNodeElement(node);
            
            nodeElement.style.left = `${offsetX + node.x - nodeWidth / 2}px`;
            nodeElement.style.top = `${node.y + 50}px`; // ìƒë‹¨ ì—¬ë°±
            container.appendChild(nodeElement);
        }
    });
    
    // ì—£ì§€ ë Œë”ë§
    OrgChartState.edges.forEach(edge => {
        if (shouldRenderEdge(edge)) {
            const edgeElement = createEdgeElement(edge, offsetX);
            container.appendChild(edgeElement);
        }
    });
    
    // ì´ˆê¸° ì¤Œ ì„¤ì • - íŒ€ ë ˆë²¨ì¼ ë•Œ ìë™ ì¶•ì†Œ
    if (OrgChartState.currentLevel === 'team') {
        updateZoom(50); // 50% ë¡œ ìë™ ì¶•ì†Œ
    }
}

// ê·¸ë¦¬ë“œ ë·° ë Œë”ë§
function renderGridView() {
    const container = document.getElementById('treeContainer');
    const nodes = Array.from(OrgChartState.nodes.values()).filter(shouldRenderNode);
    const cols = 4;
    
    nodes.forEach((node, index) => {
        const row = Math.floor(index / cols);
        const col = index % cols;
        const nodeElement = createGridNodeElement(node);
        nodeElement.style.left = `${col * 250 + 50}px`;
        nodeElement.style.top = `${row * 180 + 50}px`;
        container.appendChild(nodeElement);
    });
}

// ë°©ì‚¬í˜• ë·° ë Œë”ë§
function renderRadialView() {
    const container = document.getElementById('treeContainer');
    const viewportWidth = document.getElementById('chartViewport').offsetWidth;
    const viewportHeight = document.getElementById('chartViewport').offsetHeight;
    const centerX = viewportWidth / 2;
    const centerY = viewportHeight / 2;
    
    // ì¤‘ì•™ì— ë£¨íŠ¸ ë…¸ë“œ
    const rootNode = OrgChartState.nodes.get('root');
    if (rootNode && shouldRenderNode(rootNode)) {
        const rootElement = createNodeElement(rootNode);
        rootElement.style.left = `${centerX - CONFIG.NODE_WIDTH / 2}px`;
        rootElement.style.top = `${centerY - CONFIG.NODE_HEIGHT / 2}px`;
        container.appendChild(rootElement);
        
        // ìì‹ ë…¸ë“œë“¤ì„ ì›í˜•ìœ¼ë¡œ ë°°ì¹˜
        const children = Array.from(OrgChartState.nodes.values())
            .filter(n => n.parentId === 'root' && shouldRenderNode(n));
        
        const angleStep = (2 * Math.PI) / children.length;
        const radius = 250;
        
        children.forEach((child, index) => {
            const angle = index * angleStep - Math.PI / 2;
            const x = centerX + radius * Math.cos(angle) - CONFIG.NODE_WIDTH / 2;
            const y = centerY + radius * Math.sin(angle) - CONFIG.NODE_HEIGHT / 2;
            
            const childElement = createNodeElement(child);
            childElement.style.left = `${x}px`;
            childElement.style.top = `${y}px`;
            container.appendChild(childElement);
        });
    }
}

// ì»´íŒ©íŠ¸ ë·° ë Œë”ë§
function renderCompactView() {
    const container = document.getElementById('treeContainer');
    const nodes = Array.from(OrgChartState.nodes.values()).filter(shouldRenderNode);
    
    let y = 20;
    nodes.forEach(node => {
        const nodeElement = createCompactNodeElement(node);
        nodeElement.style.left = `20px`;
        nodeElement.style.top = `${y}px`;
        nodeElement.style.width = 'calc(100% - 40px)';
        container.appendChild(nodeElement);
        y += 50;
    });
}

// ë…¸ë“œ ë Œë”ë§ ì—¬ë¶€ í™•ì¸
function shouldRenderNode(node) {
    // ë ˆë²¨ í•„í„°ê°€ í™œì„±í™”ëœ ê²½ìš° ë¨¼ì € í™•ì¸
    if (OrgChartState.currentLevel !== 'all') {
        console.log(`Filtering node ${node.name} (type: ${node.type}) with filter: ${OrgChartState.currentLevel}`);
        
        let shouldShow = false;
        switch(OrgChartState.currentLevel) {
            case 'executive':
                // ì„ì›ê¸‰ë§Œ í‘œì‹œ (íšŒì‚¬, ë³¸ë¶€)
                shouldShow = node.type === 'company' || node.type === 'division';
                break;
            case 'division':
                // ë³¸ë¶€ê¸‰ê¹Œì§€ë§Œ í‘œì‹œ
                shouldShow = node.type === 'company' || node.type === 'division';
                break;
            case 'department':
                // ë¶€ì„œê¸‰ê¹Œì§€ í‘œì‹œ
                shouldShow = node.type === 'company' || node.type === 'division' || node.type === 'department';
                break;
            case 'team':
                // íŒ€ê¸‰ê¹Œì§€ í‘œì‹œ - ëª¨ë“  ìƒìœ„ ì¡°ì§ í¬í•¨
                shouldShow = true; // ëª¨ë“  ë…¸ë“œë¥¼ í‘œì‹œ
                break;
            default:
                shouldShow = true;
        }
        
        console.log(`Node ${node.name} - Level Filter Show: ${shouldShow}`);
        
        // ë ˆë²¨ í•„í„°ì—ì„œ ë³´ì—¬ì•¼ í•˜ëŠ” ë…¸ë“œë©´ ë¶€ëª¨ ì²´ì¸ë„ ìë™ í™•ì¥
        if (shouldShow) {
            ensureParentChainExpanded(node);
            return true;
        } else {
            return false;
        }
    }
    
    // Progressive Disclosure: í¼ì³ì§„ ë¶€ëª¨ì˜ ìì‹ë§Œ í‘œì‹œ
    if (node.parentId) {
        const parent = OrgChartState.nodes.get(node.parentId);
        if (!parent) {
            console.log(`Node ${node.name} hidden - parent ${node.parentId} not found`);
            return false;
        }
        
        // ìƒìœ„ ë…¸ë“œê°€ í™•ì¥ë˜ì§€ ì•Šì€ ê²½ìš°ì—ë§Œ ìˆ¨ê¹€
        if (!OrgChartState.expandedNodes.has(node.parentId)) {
            console.log(`Node ${node.name} hidden - parent ${node.parentId} not expanded`);
            return false;
        }
    }
    
    // ë…¸ë“œê°€ í™”ë©´ ë²”ìœ„ë¥¼ ë²—ì–´ë‚¬ëŠ”ì§€ ì²´í¬ (ë””ë²„ê¹…ìš©)
    if (node.x !== undefined && node.y !== undefined) {
        if (Math.abs(node.x) > 5000 || node.y > 5000) {
            console.warn(`Node ${node.name} is out of bounds: x=${node.x}, y=${node.y}`);
        }
    }
    
    return true;
}

// ë¶€ëª¨ ì²´ì¸ì„ ìë™ìœ¼ë¡œ í™•ì¥
function ensureParentChainExpanded(node) {
    let currentNode = node;
    const nodesToExpand = [];
    
    // ë£¨íŠ¸ê¹Œì§€ ë¶€ëª¨ ì²´ì¸ì„ ì¶”ì 
    while (currentNode.parentId) {
        const parent = OrgChartState.nodes.get(currentNode.parentId);
        if (parent) {
            nodesToExpand.push(parent.id);
            currentNode = parent;
        } else {
            break;
        }
    }
    
    // ëª¨ë“  ë¶€ëª¨ ë…¸ë“œë¥¼ í™•ì¥ëœ ìƒíƒœë¡œ ì„¤ì •
    nodesToExpand.forEach(nodeId => {
        OrgChartState.expandedNodes.add(nodeId);
        console.log(`Auto-expanded parent node: ${nodeId}`);
    });
}

// ì—£ì§€ ë Œë”ë§ ì—¬ë¶€ í™•ì¸
function shouldRenderEdge(edge) {
    return shouldRenderNode(edge.source) && shouldRenderNode(edge.target);
}

// ê·¸ë¦¬ë“œ ë·°ìš© ë…¸ë“œ ì—˜ë¦¬ë¨¼íŠ¸
function createGridNodeElement(node) {
    const div = document.createElement('div');
    div.className = 'org-node grid-node';
    div.id = `node-grid-${node.id}`;
    
    const badgeClass = `node-type-badge ${node.type}`;
    div.innerHTML = `
        <div class="node-header">
            <span class="${badgeClass}">${getNodeTypeLabel(node.type)}</span>
        </div>
        <div class="node-content">
            <div class="node-name">${node.name}</div>
            <div class="node-stats">
                <div class="node-stat">
                    <i class="fas fa-users node-stat-icon"></i>
                    <span>${node.headcount || 0}ëª…</span>
                </div>
            </div>
        </div>
    `;
    
    div.addEventListener('click', () => focusNode(node.id));
    return div;
}

// ì»´íŒ©íŠ¸ ë·°ìš© ë…¸ë“œ ì—˜ë¦¬ë¨¼íŠ¸
function createCompactNodeElement(node) {
    const div = document.createElement('div');
    div.className = 'org-node compact-node';
    div.id = `node-compact-${node.id}`;
    div.style.cssText = 'display: flex; align-items: center; padding: 0.5rem 1rem; min-width: auto;';
    
    div.innerHTML = `
        <span class="node-type-badge ${node.type}" style="margin-right: 1rem;">${getNodeTypeLabel(node.type)}</span>
        <span style="flex: 1; color: white; font-weight: 500;">${node.name}</span>
        <span style="color: #94a3b8; font-size: 0.875rem;">${node.headcount || 0}ëª…</span>
    `;
    
    div.addEventListener('click', () => focusNode(node.id));
    return div;
}

// DenseTallNode ì—˜ë¦¬ë¨¼íŠ¸ ìƒì„± (ì´ˆìŠ¬ë¦¼ ì„¸ë¡œ ì¹´ë“œ)
function createDenseNodeElement(node) {
    const div = document.createElement('div');
    div.className = 'org-node dense-node';
    div.id = `node-${node.id}`;
    div.setAttribute('role', 'treeitem');
    div.setAttribute('aria-expanded', OrgChartState.expandedNodes.has(node.id));
    div.setAttribute('aria-level', node.level);
    div.tabIndex = 0;
    
    if (node.id === OrgChartState.focusedNode) {
        div.classList.add('focused');
    }
    
    if (!OrgChartState.expandedNodes.has(node.id) && node.hasChildren) {
        div.classList.add('collapsed');
    }
    
    // Dense ëª¨ë“œì—ì„œëŠ” 40px ì´ˆìŠ¬ë¦¼ ì¹´ë“œë¡œ ê³ ì •
    div.style.cssText = `
        position: absolute;
        left: ${node.x}px;
        top: ${node.y}px;
        width: ${CONFIG.NODE_WIDTH_DENSE}px;
        height: auto;
        min-height: 160px;
        max-height: 240px;
        padding: 0.125rem;
        background: rgba(14, 23, 40, 0.95);
        backdrop-filter: blur(8px);
        border: 1px solid rgba(0, 212, 255, 0.4);
        border-radius: 0.375rem;
        transition: all 0.2s ease;
        cursor: pointer;
        z-index: ${node.type === 'company' ? '100' : '10'};
        overflow: hidden;
    `;
    
    // ë²„í‚· ë…¸ë“œ íŠ¹ë³„ ì²˜ë¦¬
    if (node.isCluster || node.type === 'bucket') {
        // í´ëŸ¬ìŠ¤í„°ëŠ” ë” ì‘ì€ í¬ê¸°ë¡œ ì¬ì„¤ì •
        div.style.width = '80px';
        div.style.height = '80px';
        div.style.minHeight = '80px';
        div.innerHTML = `
            <div style="
                width: 100%;
                height: 100%;
                background: rgba(255, 255, 255, 0.05);
                border: 1px solid rgba(0, 212, 255, 0.4);
                border-radius: 0.75rem;
                display: flex;
                align-items: center;
                justify-content: center;
                color: #00d4ff;
                font-size: 0.75rem;
                cursor: pointer;
                transition: all 0.3s ease;
                writing-mode: vertical-rl;
                text-orientation: mixed;
            " onmouseover="this.style.borderColor='#00d4ff'; this.style.background='rgba(0, 212, 255, 0.1)'"
               onmouseout="this.style.borderColor='rgba(0, 212, 255, 0.4)'; this.style.background='rgba(255, 255, 255, 0.05)'">
                ${node.name}
            </div>
        `;
        div.addEventListener('click', () => expandCluster(node.id));
    } else {
        // DenseTallNode ì½˜í…ì¸  (ì„¸ë¡œ ê¸€ì)
        const headcount = node.headcount || 0;
        const childrenCount = node.childrenCount || 0;
        const typeColor = {
            'company': 'from-cyan-500',
            'division': 'from-fuchsia-500',
            'department': 'from-teal-500',
            'team': 'from-slate-500',
            'person': 'from-amber-500'
        }[node.type] || 'from-cyan-500';
        
        div.innerHTML = `
            <!-- íƒ€ì… í‘œì‹œ ë¼ì¸ -->
            <div class="node-spine ${node.type}" style="
                position: absolute;
                left: 0;
                top: 0;
                height: 100%;
                width: 6px;
                background: linear-gradient(to bottom, ${typeColor}, transparent);
                opacity: 0.7;
                border-radius: 1rem 0 0 1rem;
            "></div>
            
            <!-- ë…¸ë“œ ì½˜í…ì¸  (ì„¸ë¡œ ê¸€ì) - ì´ˆìŠ¬ë¦¼ ìŠ¤í™ -->
            <div class="node-content" style="
                margin-left: 4px;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 0.5rem;
                height: 100%;
                padding: 0.25rem 0.125rem;
            ">
                <!-- ì´ë¦„ (ì„¸ë¡œ ê¸€ì - CJK ìµœì í™”) -->
                <div class="vertical-cjk" style="
                    font-size: 11px;
                    font-weight: 600;
                    color: rgba(255, 255, 255, 0.9);
                    line-height: 1.1;
                    flex: 1;
                    max-height: 200px;
                    overflow: hidden;
                ">${node.name}</div>
                
                <!-- í†µê³„ (ì„¸ë¡œ) - ë¯¸ë‹ˆë§ -->
                <div style="display: flex; flex-direction: column; gap: 0.1rem;">
                    <div class="v-chip" style="padding: 0.1rem; font-size: 9px;">${headcount}</div>
                    <div class="v-chip" style="padding: 0.1rem; font-size: 9px;">${childrenCount}</div>
                </div>
            </div>
            
            <!-- ì ‘ê¸°/í¼ì¹˜ê¸° ë²„íŠ¼ -->
            ${node.hasChildren ? `
                <button class="node-toggle" aria-label="${OrgChartState.expandedNodes.has(node.id) ? 'ì ‘ê¸°' : 'í¼ì¹˜ê¸°'}" style="
                    position: absolute;
                    bottom: -12px;
                    left: 50%;
                    transform: translateX(-50%);
                ">
                    <i class="fas fa-chevron-${OrgChartState.expandedNodes.has(node.id) ? 'up' : 'down'}"></i>
                </button>
            ` : ''}
        `;
        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        div.addEventListener('click', () => focusNode(node.id));
        
        const toggleBtn = div.querySelector('.node-toggle');
        if (toggleBtn) {
            toggleBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleNode(node.id);
            });
        }
    }
    
    return div;
}

// TallNode ì—˜ë¦¬ë¨¼íŠ¸ ìƒì„± (ì„¸ë¡œ ê¸¸ì­‰í•œ ì¹´ë“œ)
function createNodeElement(node) {
    const div = document.createElement('div');
    div.className = 'org-node';
    div.id = `node-${node.id}`;
    div.setAttribute('role', 'treeitem');
    div.setAttribute('aria-expanded', OrgChartState.expandedNodes.has(node.id));
    div.setAttribute('aria-level', node.level);
    div.tabIndex = 0;
    
    if (node.id === OrgChartState.focusedNode) {
        div.classList.add('focused');
    }
    
    if (!OrgChartState.expandedNodes.has(node.id) && node.hasChildren) {
        div.classList.add('collapsed');
    }
    
    // ë²„í‚· ë…¸ë“œ íŠ¹ë³„ ì²˜ë¦¬
    if (node.isCluster || node.type === 'bucket') {
        div.style.cssText = 'width: 120px; height: 80px; min-height: 80px;';
        div.innerHTML = `
            <div style="
                width: 100%;
                height: 100%;
                background: rgba(255, 255, 255, 0.05);
                border: 1px solid rgba(0, 212, 255, 0.4);
                border-radius: 0.75rem;
                display: flex;
                align-items: center;
                justify-content: center;
                color: #00d4ff;
                font-size: 0.875rem;
                cursor: pointer;
                transition: all 0.3s ease;
            " onmouseover="this.style.borderColor='#00d4ff'; this.style.background='rgba(0, 212, 255, 0.1)'"
               onmouseout="this.style.borderColor='rgba(0, 212, 255, 0.4)'; this.style.background='rgba(255, 255, 255, 0.05)'">
                ${node.name}
            </div>
        `;
        div.addEventListener('click', () => expandCluster(node.id));
    } else {
        // TallNode ì½˜í…ì¸  (ì¼ë°˜ ê°€ë¡œ ê¸€ì ë…¸ë“œ) - 180px í­
        const headcount = node.headcount || 0;
        const childrenCount = node.childrenCount || 0;
        const badges = node.badges || [];
        
        div.innerHTML = `
            <!-- ì™¼ìª½ ì„¸ë¡œ spine (íƒ€ì… í‘œì‹œ) -->
            <div class="node-spine ${node.type}"></div>
            
            <!-- ë…¸ë“œ ì½˜í…ì¸  (ê°€ë¡œ ê¸€ì) -->
            <div class="node-content">
                <!-- ì´ë¦„ (3ì¤„ í´ë¨í”„) -->
                <div class="node-name">${node.name}</div>
                
                <!-- ì§ê¸‰/íƒ€ì´í‹€ (2ì¤„ í´ë¨í”„) -->
                ${node.title ? `<div class="node-title">${node.title}</div>` : ''}
                
                <!-- í†µê³„ ê·¸ë¦¬ë“œ -->
                <div class="node-stats">
                    <div class="node-stat">ì¸ì› ${headcount}</div>
                    <div class="node-stat">í•˜ìœ„ ${childrenCount}</div>
                </div>
                
                <!-- ë°°ì§€ (ìµœëŒ€ 3ê°œ í‘œì‹œ) -->
                ${badges.length > 0 ? `
                    <div class="node-badges">
                        ${badges.slice(0, 3).map(badge => 
                            `<span class="node-badge">${badge}</span>`
                        ).join('')}
                        ${badges.length > 3 ? 
                            `<span class="node-badge">+${badges.length - 3}</span>` : ''
                        }
                    </div>
                ` : ''}
                
                <!-- ì ‘íŒ ìƒíƒœì—ì„œ í•˜ìœ„ ì¡°ì§ ì •ë³´ -->
                ${!OrgChartState.expandedNodes.has(node.id) && node.hasChildren ? `
                    <div class="node-children-info" style="
                        margin-top: 0.5rem;
                        padding-top: 0.5rem;
                        border-top: 1px solid rgba(0, 212, 255, 0.1);
                        font-size: 0.813rem;
                        color: #00d4ff;
                    ">
                        <i class="fas fa-chevron-down"></i> ${childrenCount}ê°œ í•˜ìœ„ ì¡°ì§
                    </div>
                ` : ''}
            </div>
            
            <!-- ì ‘ê¸°/í¼ì¹˜ê¸° ë²„íŠ¼ -->
            ${node.hasChildren ? `
                <button class="node-toggle" aria-label="${OrgChartState.expandedNodes.has(node.id) ? 'ì ‘ê¸°' : 'í¼ì¹˜ê¸°'}">
                    <i class="fas fa-chevron-${OrgChartState.expandedNodes.has(node.id) ? 'up' : 'down'}"></i>
                </button>
            ` : ''}
        `;
        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        div.addEventListener('click', () => focusNode(node.id));
        
        const toggleBtn = div.querySelector('.node-toggle');
        if (toggleBtn) {
            toggleBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleNode(node.id);
            });
        }
    }
    
    return div;
}

// ì—£ì§€ ì—˜ë¦¬ë¨¼íŠ¸ ìƒì„± (ì§ê° ì—°ê²°ì„  ì§€ì›)
function createEdgeElement(edge, centerX) {
    const container = document.createElement('div');
    container.className = 'edge-container';
    container.style.position = 'absolute';
    container.style.pointerEvents = 'none';
    
    // Dense ëª¨ë“œ íŒë³„
    const isDenseMode = OrgChartState.zoomLevel < CONFIG.ZOOM_DENSE_THRESHOLD || 
                        OrgChartState.currentView === 'compact';
    const nodeHeight = isDenseMode ? CONFIG.NODE_HEIGHT_DENSE : CONFIG.NODE_HEIGHT;
    
    const sourceX = centerX + edge.source.x;
    const sourceY = edge.source.y + nodeHeight - 20; // ë…¸ë“œ í•˜ë‹¨
    const targetX = centerX + edge.target.x;
    const targetY = edge.target.y + 20; // ë…¸ë“œ ìƒë‹¨
    
    if (edge.type === 'orthogonal' && sourceX !== targetX) {
        // ì§ê° ì—°ê²°ì„  (ã„±ì í˜•íƒœ)
        const midY = sourceY + (targetY - sourceY) / 2;
        
        // ìˆ˜ì§ì„  1 (ë¶€ëª¨ì—ì„œ ì•„ë˜ë¡œ)
        const vLine1 = document.createElement('div');
        vLine1.className = 'org-edge';
        vLine1.style.left = `${sourceX - 1}px`;
        vLine1.style.top = `${sourceY}px`;
        vLine1.style.height = `${midY - sourceY}px`;
        vLine1.style.width = '2px';
        container.appendChild(vLine1);
        
        // ìˆ˜í‰ì„  (ì¢Œìš° ì—°ê²°)
        const hLine = document.createElement('div');
        hLine.className = 'org-edge horizontal';
        hLine.style.left = `${Math.min(sourceX, targetX)}px`;
        hLine.style.top = `${midY - 1}px`;
        hLine.style.width = `${Math.abs(targetX - sourceX)}px`;
        hLine.style.height = '2px';
        container.appendChild(hLine);
        
        // ìˆ˜ì§ì„  2 (ìì‹ìœ¼ë¡œ ì—°ê²°)
        const vLine2 = document.createElement('div');
        vLine2.className = 'org-edge';
        vLine2.style.left = `${targetX - 1}px`;
        vLine2.style.top = `${midY}px`;
        vLine2.style.height = `${targetY - midY}px`;
        vLine2.style.width = '2px';
        container.appendChild(vLine2);
    } else {
        // ì¼ì§ì„  ì—°ê²° (ë¶€ëª¨ì™€ ìì‹ì´ ê°™ì€ X ìœ„ì¹˜)
        const vLine = document.createElement('div');
        vLine.className = 'org-edge';
        vLine.style.left = `${sourceX - 1}px`;
        vLine.style.top = `${sourceY}px`;
        vLine.style.height = `${targetY - sourceY}px`;
        vLine.style.width = '2px';
        container.appendChild(vLine);
    }
    
    return container;
}

// ë…¸ë“œ íƒ€ì… ë ˆì´ë¸”
function getNodeTypeLabel(type) {
    const labels = {
        'company': 'íšŒì‚¬',
        'division': 'ë³¸ë¶€',
        'department': 'ë¶€ì„œ',
        'team': 'íŒ€',
        'person': 'ì§ì›',
    };
    return labels[type] || type;
}

// ë…¸ë“œ í† ê¸€
async function toggleNode(nodeId) {
    const node = OrgChartState.nodes.get(nodeId);
    if (!node || !node.hasChildren) return;
    
    if (OrgChartState.expandedNodes.has(nodeId)) {
        // ì ‘ê¸°
        OrgChartState.expandedNodes.delete(nodeId);
        console.log(`Collapsed node: ${nodeId}`);
    } else {
        // í¼ì¹˜ê¸°
        OrgChartState.expandedNodes.add(nodeId);
        console.log(`Expanded node: ${nodeId}`);
        
        // Lazy Load: ìì‹ì´ ì—†ìœ¼ë©´ ì„œë²„ì—ì„œ ë¡œë“œ
        if (!node.children || node.children.length === 0) {
            await loadNodeChildren(nodeId);
        }
    }
    
    // ë ˆì´ì•„ì›ƒ ì¬ê³„ì‚° í•„ìˆ˜ (íŠ¹íˆ íŒ€ ë ˆë²¨)
    calculateLayout();
    renderChart();
}

// ë…¸ë“œ ìì‹ ë¡œë“œ (Lazy Loading)
async function loadNodeChildren(nodeId, depth = 1) {
    try {
        const response = await fetch(`/employees/api/org/node/${nodeId}?depth=${depth}`);
        
        // ì‘ë‹µ ìƒíƒœ í™•ì¸
        if (!response.ok) {
            console.error(`HTTP Error: ${response.status} ${response.statusText}`);
            return;
        }
        
        const data = await response.json();
        
        // ì—ëŸ¬ ì‘ë‹µ í™•ì¸
        if (data.error) {
            console.error('API Error:', data.error);
            return;
        }
        
        const node = OrgChartState.nodes.get(nodeId);
        if (node && data.children) {
            node.children = data.children;
            processOrgData({ ...node, children: data.children });
            calculateLayout();
            console.log(`Successfully loaded ${data.children.length} children for node ${nodeId} with depth ${depth}`);
        } else {
            console.log(`No children found for node ${nodeId}`);
        }
    } catch (error) {
        console.error('Failed to load node children:', error);
        console.error('Node ID:', nodeId);
    }
}

// íŠ¹ì • ê¹Šì´ê¹Œì§€ ë…¸ë“œ í™•ì¥ (expandToDepth) - í ê¸°ë°˜ BFS ìµœì í™”
async function expandToDepth(rootId, targetDepth = 3) {
    console.log(`ğŸ”„ Expanding node ${rootId} to depth ${targetDepth} - Dense mode test`);
    
    showLoading(true);
    
    // BFS í ë°©ì‹ìœ¼ë¡œ ìµœì í™”
    const queue = [{ id: rootId, depth: 0 }];
    const seen = new Set([rootId]);
    const pagesToLoad = [];
    
    while (queue.length > 0) {
        const { id, depth } = queue.shift();
        
        if (depth >= targetDepth) continue;
        
        const node = OrgChartState.nodes.get(id);
        if (!node) continue;
        
        // ë…¸ë“œ í™•ì¥ ìƒíƒœ ì„¤ì •
        if (node.hasChildren) {
            OrgChartState.expandedNodes.add(id);
        }
        
        // ìì‹ì´ ì—†ìœ¼ë©´ ë¡œë“œ ì˜ˆì•½
        if (node.hasChildren && (!node.children || node.children.length === 0)) {
            pagesToLoad.push({ id, depth });
        }
        
        // ì´ë¯¸ ë¡œë“œëœ ìì‹ë“¤ì„ íì— ì¶”ê°€
        OrgChartState.nodes.forEach(childNode => {
            if (childNode.parentId === id && !seen.has(childNode.id)) {
                seen.add(childNode.id);
                queue.push({ id: childNode.id, depth: depth + 1 });
            }
        });
    }
    
    // ë³‘ë ¬ë¡œ í•„ìš”í•œ ë…¸ë“œë“¤ ë¡œë“œ
    if (pagesToLoad.length > 0) {
        const loadPromises = pagesToLoad.map(({ id }) => loadNodeChildren(id, 1));
        await Promise.all(loadPromises);
        
        // ë¡œë“œëœ ë…¸ë“œë“¤ë„ í™•ì¥ ìƒíƒœë¡œ ì„¤ì •
        pagesToLoad.forEach(({ id, depth }) => {
            if (depth < targetDepth - 1) {
                const node = OrgChartState.nodes.get(id);
                if (node && node.children) {
                    // ìƒˆë¡œ ë¡œë“œëœ ìì‹ë“¤ë„ í™•ì¥
                    OrgChartState.nodes.forEach(childNode => {
                        if (childNode.parentId === id && childNode.hasChildren) {
                            OrgChartState.expandedNodes.add(childNode.id);
                        }
                    });
                }
            }
        });
    }
    
    showLoading(false);
    
    // í™•ì¥ í›„ ìƒíƒœ ì²´í¬
    console.log(`ğŸ“Š Current zoom: ${OrgChartState.zoomLevel}% (Dense mode: ${OrgChartState.zoomLevel < CONFIG.ZOOM_DENSE_THRESHOLD})`);
    
    // í™•ì¥ í›„ Dense ëª¨ë“œ ê°•ì œ í™•ì¸ (ì´ˆìŠ¬ë¦¼ ì¹´ë“œ í…ŒìŠ¤íŠ¸ìš©)
    if (OrgChartState.zoomLevel >= CONFIG.ZOOM_DENSE_THRESHOLD) {
        console.log('ğŸ”¥ Forcing Dense mode for ultra-slim cards verification');
        updateZoom(80); // Dense ëª¨ë“œ ê°•ì œ í™œì„±í™”
        return; // updateZoomì—ì„œ ì´ë¯¸ ë Œë”ë§ë¨
    }
    
    // ë ˆì´ì•„ì›ƒ ì¬ê³„ì‚° ë° ë Œë”ë§
    calculateLayout();
    
    // ê·¸ë˜í”„ ê²€ì¦
    const validation = validateGraph(OrgChartState.edges);
    if (!validation.isValid) {
        console.warn('Graph validation issues detected:', validation);
    }
    
    renderChart();
}

// ë…¸ë“œ í¬ì»¤ìŠ¤
function focusNode(nodeId) {
    OrgChartState.focusedNode = nodeId;
    
    // ëª¨ë“  ë…¸ë“œì—ì„œ í¬ì»¤ìŠ¤ í´ë˜ìŠ¤ ì œê±°
    document.querySelectorAll('.org-node').forEach(el => {
        el.classList.remove('focused');
    });
    
    // ìƒˆ ë…¸ë“œì— í¬ì»¤ìŠ¤ í´ë˜ìŠ¤ ì¶”ê°€
    const nodeElement = document.getElementById(`node-${nodeId}`);
    if (nodeElement) {
        nodeElement.classList.add('focused');
        nodeElement.focus();
        
        // ë¸Œë ˆë“œí¬ëŸ¼ ì—…ë°ì´íŠ¸
        updateBreadcrumb(nodeId);
        
        // í¬ì»¤ìŠ¤ ê²½ë¡œ í¼ì¹˜ê¸°
        expandPath(nodeId);
        
        // ìŠ¤í¬ë¡¤ ì¡°ì •
        nodeElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
}

// ê²½ë¡œ í¼ì¹˜ê¸° (í¬ì»¤ìŠ¤ëœ ë…¸ë“œê¹Œì§€)
function expandPath(nodeId) {
    const node = OrgChartState.nodes.get(nodeId);
    if (!node) return;
    
    const path = [];
    let current = node;
    while (current) {
        path.unshift(current.id);
        current = current.parentId ? OrgChartState.nodes.get(current.parentId) : null;
    }
    
    // ê²½ë¡œìƒì˜ ëª¨ë“  ë…¸ë“œ í¼ì¹˜ê¸°
    path.forEach(id => {
        if (!OrgChartState.expandedNodes.has(id)) {
            const n = OrgChartState.nodes.get(id);
            if (n && n.hasChildren) {
                OrgChartState.expandedNodes.add(id);
            }
        }
    });
    
    renderChart();
}

// ë¸Œë ˆë“œí¬ëŸ¼ ì—…ë°ì´íŠ¸
function updateBreadcrumb(nodeId) {
    const breadcrumb = document.getElementById('breadcrumbNav');
    const node = OrgChartState.nodes.get(nodeId);
    if (!node) return;
    
    const path = [];
    let current = node;
    while (current) {
        path.unshift(current);
        current = current.parentId ? OrgChartState.nodes.get(current.parentId) : null;
    }
    
    breadcrumb.innerHTML = path.map((n, index) => `
        <span class="breadcrumb-item ${index === path.length - 1 ? 'active' : ''}" 
              onclick="focusNode('${n.id}')">
            ${n.name}
        </span>
        ${index < path.length - 1 ? '<span class="breadcrumb-separator">â€º</span>' : ''}
    `).join('');
}

// í˜•ì œ ë…¸ë“œ íƒìƒ‰
function navigateToSibling(node, direction) {
    if (!node.parentId) return;
    
    const parent = OrgChartState.nodes.get(node.parentId);
    if (!parent || !parent.children) return;
    
    const currentIndex = parent.children.findIndex(c => c.id === node.id);
    if (currentIndex === -1) return;
    
    const newIndex = currentIndex + direction;
    if (newIndex >= 0 && newIndex < parent.children.length) {
        focusNode(parent.children[newIndex].id);
    }
}

// ê²€ìƒ‰ ìˆ˜í–‰
async function performSearch(query) {
    OrgChartState.searchQuery = query;
    
    if (!query || query.length < 2) {
        document.getElementById('searchAutocomplete').classList.remove('active');
        return;
    }
    
    try {
        const response = await fetch(`/employees/api/org/search?q=${encodeURIComponent(query)}`);
        const results = await response.json();
        
        showSearchResults(results);
    } catch (error) {
        console.error('Search failed:', error);
    }
}

// ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
function showSearchResults(data) {
    const autocomplete = document.getElementById('searchAutocomplete');
    
    // API ì‘ë‹µì—ì„œ results ë°°ì—´ ì¶”ì¶œ
    const results = data.results || data;
    
    if (!results || results.length === 0) {
        autocomplete.classList.remove('active');
        return;
    }
    
    autocomplete.innerHTML = results.slice(0, 10).map(result => `
        <div class="autocomplete-item" onclick="selectSearchResult('${result.id}')">
            <div class="autocomplete-item-name">${result.name}</div>
            <div class="autocomplete-item-path">${result.path.join(' â€º ')}</div>
        </div>
    `).join('');
    
    autocomplete.classList.add('active');
}

// ê²€ìƒ‰ ê²°ê³¼ ì„ íƒ
function selectSearchResult(nodeId) {
    document.getElementById('searchAutocomplete').classList.remove('active');
    document.getElementById('orgSearch').value = '';
    
    // ê²½ë¡œ í¼ì¹˜ê³  í¬ì»¤ìŠ¤
    expandPath(nodeId);
    focusNode(nodeId);
}

// ë·° ëª¨ë“œ ë³€ê²½
function updateViewMode(mode) {
    console.log('Updating view mode to:', mode);
    OrgChartState.currentView = mode;
    
    // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
    document.querySelectorAll('.view-mode-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.mode === mode);
    });
    
    // ë·°ì— ë”°ë¥¸ ë ˆì´ì•„ì›ƒ ì¬ê³„ì‚°
    if (mode === 'vertical') {
        calculateLayout();
    } else if (mode === 'radial') {
        calculateRadialLayout();
    } else if (mode === 'grid') {
        calculateGridLayout();
    } else if (mode === 'compact') {
        calculateCompactLayout();
    }
    
    console.log('Rendering chart with view mode:', mode);
    renderChart();
}

// ë ˆë²¨ í•„í„° ì—…ë°ì´íŠ¸
function updateLevelFilter(level) {
    console.log('Updating level filter to:', level);
    OrgChartState.currentLevel = level;
    
    // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
    document.querySelectorAll('.level-filter-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.level === level);
    });
    
    // ë ˆë²¨ í•„í„° ë³€ê²½ ì‹œ expandedNodes ì´ˆê¸°í™”í•˜ê³  í•„ìš”í•œ ë…¸ë“œë“¤ë§Œ í™•ì¥
    if (level !== 'all') {
        OrgChartState.expandedNodes.clear();
        console.log('Cleared expandedNodes for level filtering');
        
        // í•„í„°ì— ë§ëŠ” ëª¨ë“  ë…¸ë“œë“¤ì˜ ë¶€ëª¨ ì²´ì¸ì„ ë¯¸ë¦¬ í™•ì¥
        OrgChartState.nodes.forEach(node => {
            let shouldShow = false;
            switch(level) {
                case 'executive':
                    shouldShow = node.type === 'company' || node.type === 'division';
                    break;
                case 'division':
                    shouldShow = node.type === 'company' || node.type === 'division';
                    break;
                case 'department':
                    shouldShow = node.type === 'company' || node.type === 'division' || node.type === 'department';
                    break;
                case 'team':
                    shouldShow = node.type !== 'person';
                    break;
            }
            
            if (shouldShow) {
                ensureParentChainExpanded(node);
            }
        });
    } else {
        // 'all' ë ˆë²¨ì¸ ê²½ìš° ë£¨íŠ¸ ë…¸ë“œë§Œ í™•ì¥ëœ ìƒíƒœë¡œ ì´ˆê¸°í™”
        OrgChartState.expandedNodes.clear();
        OrgChartState.expandedNodes.add('OKê¸ˆìœµê·¸ë£¹');
        console.log('Reset to default Progressive Disclosure mode');
    }
    
    console.log('Current state after level filter update:', OrgChartState.currentLevel);
    console.log('Expanded nodes:', Array.from(OrgChartState.expandedNodes));
    
    // ë ˆë²¨ì— ë”°ë¥¸ ìë™ ì¤Œ ì¡°ì • (Dense ëª¨ë“œ í™œì„±í™”ë¥¼ ìœ„í•´ 95% ë¯¸ë§Œìœ¼ë¡œ ì„¤ì •)
    let autoZoom = 80;
    switch(level) {
        case 'executive':
            autoZoom = 90;   // ì„ì›ê¸‰ì€ 90% (Dense ëª¨ë“œ)
            break;
        case 'division':
            autoZoom = 85;   // ë³¸ë¶€ê¸‰ì€ 85% (Dense ëª¨ë“œ)
            break;
        case 'department':
            autoZoom = 70;   // ë¶€ì„œê¸‰ì€ 70% (Dense ëª¨ë“œ)
            break;
        case 'team':
            autoZoom = 50;   // íŒ€ê¸‰ì€ 50%ë¡œ ì¶•ì†Œ (Dense ëª¨ë“œ)
            break;
        default:
            autoZoom = 80;   // ì „ì²´ëŠ” 80% (Dense ëª¨ë“œ)
    }
    
    updateZoom(autoZoom);
    renderChart();
}

// ì¤Œ ì—…ë°ì´íŠ¸
function updateZoom(level) {
    OrgChartState.zoomLevel = level;
    document.getElementById('zoomLevel').textContent = `${level}%`;
    
    const container = document.getElementById('treeContainer');
    container.style.transform = `scale(${level / 100})`;
    
    // ì‹œë§¨í‹± ì¤Œ í´ë˜ìŠ¤ ì ìš©
    container.classList.remove('zoom-small', 'zoom-large');
    if (level < 80) {
        container.classList.add('zoom-small');
    } else if (level > 120) {
        container.classList.add('zoom-large');
    }
}

// ë²„í‚· í´ëŸ¬ìŠ¤í„° í™•ì¥ (ë²„í‚· í´ë¦­ ì‹œ ìˆ¨ê²¨ì§„ ë…¸ë“œ í‘œì‹œ)
function expandCluster(clusterId) {
    const clusterNode = OrgChartState.nodes.get(clusterId);
    if (!clusterNode || !clusterNode.isCluster) return;
    
    const hiddenNodes = OrgChartState.clusteredSiblings.get(clusterId);
    if (!hiddenNodes || hiddenNodes.length === 0) return;
    
    console.log(`Expanding cluster ${clusterId} with ${hiddenNodes.length} hidden nodes`);
    
    // ë¶€ëª¨ ë…¸ë“œ ì°¾ê¸°
    const parentNode = OrgChartState.nodes.get(clusterNode.parentId);
    if (!parentNode) return;
    
    // í´ëŸ¬ìŠ¤í„° ë…¸ë“œ ì œê±°
    OrgChartState.nodes.delete(clusterId);
    OrgChartState.clusteredSiblings.delete(clusterId);
    
    // ìˆ¨ê²¨ì§„ ë…¸ë“œë“¤ì„ ë…¸ë“œ ë§µì— ì¶”ê°€
    hiddenNodes.forEach(node => {
        const processedNode = {
            ...node,
            parentId: clusterNode.parentId,
            level: clusterNode.level,
            x: 0,
            y: clusterNode.level * CONFIG.LEVEL_SPACING,
        };
        OrgChartState.nodes.set(node.id, processedNode);
        
        // ìì‹ ë…¸ë“œë“¤ë„ ì¬ê·€ì ìœ¼ë¡œ ì²˜ë¦¬
        if (node.children && node.children.length > 0) {
            function processChildren(children, parentId, level) {
                children.forEach(child => {
                    const childNode = {
                        ...child,
                        parentId: parentId,
                        level: level,
                        x: 0,
                        y: level * CONFIG.LEVEL_SPACING,
                    };
                    OrgChartState.nodes.set(child.id, childNode);
                    
                    if (child.children) {
                        processChildren(child.children, child.id, level + 1);
                    }
                });
            }
            processChildren(node.children, node.id, clusterNode.level + 1);
        }
    });
    
    // ë¶€ëª¨ ë…¸ë“œê°€ í™•ì¥ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ê³  ì„¤ì •
    if (!OrgChartState.expandedNodes.has(clusterNode.parentId)) {
        OrgChartState.expandedNodes.add(clusterNode.parentId);
    }
    
    // ë ˆì´ì•„ì›ƒ ì¬ê³„ì‚° ë° ë Œë”ë§
    calculateLayout();
    renderChart();
    
    // ìŠ¤í¬ë¡¤ ì¡°ì • (ì„ íƒì )
    const parentElement = document.getElementById(`node-${clusterNode.parentId}`);
    if (parentElement) {
        parentElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
}

// ë¡œë”© í‘œì‹œ
function showLoading(show) {
    const overlay = document.getElementById('loadingOverlay');
    overlay.style.display = show ? 'flex' : 'none';
}

// ì—ëŸ¬ í‘œì‹œ
function showError(message) {
    console.error(message);
    // ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ í™”ë©´ì— í‘œì‹œ
    const viewport = document.getElementById('chartViewport');
    if (viewport && !document.getElementById('errorMessage')) {
        const errorDiv = document.createElement('div');
        errorDiv.id = 'errorMessage';
        errorDiv.style.cssText = 'position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255, 0, 0, 0.1); color: #ff6b6b; padding: 1rem 2rem; border-radius: 0.5rem; border: 1px solid #ff6b6b;';
        errorDiv.textContent = message;
        viewport.appendChild(errorDiv);
        
        // 3ì´ˆ í›„ ì—ëŸ¬ ë©”ì‹œì§€ ì œê±°
        setTimeout(() => {
            errorDiv.remove();
        }, 3000);
    }
}

// ìƒ˜í”Œ ë°ì´í„° ì‚¬ìš© (API ì‹¤íŒ¨ ì‹œ ë°±ì—…)
function useSampleData() {
    const sampleData = {
        id: 'OKê¸ˆìœµê·¸ë£¹',
        name: 'OKê¸ˆìœµê·¸ë£¹',
        type: 'company',
        title: 'CEO',
        headcount: 1700,
        childrenCount: 5,
        hasChildren: true,
        parentId: null,
        path: ['OKê¸ˆìœµê·¸ë£¹'],
        children: [
            {
                id: 'division-1',
                name: 'ê²½ì˜ì§€ì›ë³¸ë¶€',
                type: 'division',
                headcount: 320,
                childrenCount: 8,
                hasChildren: true,
                parentId: 'root',
                path: ['OKê¸ˆìœµê·¸ë£¹', 'ê²½ì˜ì§€ì›ë³¸ë¶€'],
                children: [
                    {
                        id: 'dept-1-1',
                        name: 'ì¸ì‚¬ë¶€',
                        type: 'department',
                        headcount: 45,
                        childrenCount: 2,
                        hasChildren: true,
                        parentId: 'division-1',
                        path: ['OKê¸ˆìœµê·¸ë£¹', 'ê²½ì˜ì§€ì›ë³¸ë¶€', 'ì¸ì‚¬ë¶€'],
                        children: [
                            {
                                id: 'team-1-1-1',
                                name: 'ì±„ìš©íŒ€',
                                type: 'team',
                                headcount: 12,
                                childrenCount: 0,
                                hasChildren: false,
                                parentId: 'dept-1-1',
                                path: ['OKê¸ˆìœµê·¸ë£¹', 'ê²½ì˜ì§€ì›ë³¸ë¶€', 'ì¸ì‚¬ë¶€', 'ì±„ìš©íŒ€']
                            },
                            {
                                id: 'team-1-1-2',
                                name: 'êµìœ¡íŒ€',
                                type: 'team',
                                headcount: 8,
                                childrenCount: 0,
                                hasChildren: false,
                                parentId: 'dept-1-1',
                                path: ['OKê¸ˆìœµê·¸ë£¹', 'ê²½ì˜ì§€ì›ë³¸ë¶€', 'ì¸ì‚¬ë¶€', 'êµìœ¡íŒ€']
                            }
                        ]
                    },
                    {
                        id: 'dept-1-2',
                        name: 'ì¬ë¬´ë¶€',
                        type: 'department',
                        headcount: 38,
                        childrenCount: 1,
                        hasChildren: true,
                        parentId: 'division-1',
                        path: ['OKê¸ˆìœµê·¸ë£¹', 'ê²½ì˜ì§€ì›ë³¸ë¶€', 'ì¬ë¬´ë¶€'],
                        children: [
                            {
                                id: 'team-1-2-1',
                                name: 'íšŒê³„íŒ€',
                                type: 'team',
                                headcount: 15,
                                childrenCount: 0,
                                hasChildren: false,
                                parentId: 'dept-1-2',
                                path: ['OKê¸ˆìœµê·¸ë£¹', 'ê²½ì˜ì§€ì›ë³¸ë¶€', 'ì¬ë¬´ë¶€', 'íšŒê³„íŒ€']
                            }
                        ]
                    }
                ]
            },
            {
                id: 'division-2',
                name: 'ITë³¸ë¶€',
                type: 'division',
                headcount: 450,
                childrenCount: 10,
                hasChildren: true,
                parentId: 'root',
                path: ['OKê¸ˆìœµê·¸ë£¹', 'ITë³¸ë¶€'],
                children: [
                    {
                        id: 'dept-2-1',
                        name: 'ê°œë°œë¶€',
                        type: 'department',
                        headcount: 62,
                        childrenCount: 2,
                        hasChildren: true,
                        parentId: 'division-2',
                        path: ['OKê¸ˆìœµê·¸ë£¹', 'ITë³¸ë¶€', 'ê°œë°œë¶€'],
                        children: [
                            {
                                id: 'team-2-1-1',
                                name: 'í”„ë¡ íŠ¸ì—”ë“œíŒ€',
                                type: 'team',
                                headcount: 18,
                                childrenCount: 0,
                                hasChildren: false,
                                parentId: 'dept-2-1',
                                path: ['OKê¸ˆìœµê·¸ë£¹', 'ITë³¸ë¶€', 'ê°œë°œë¶€', 'í”„ë¡ íŠ¸ì—”ë“œíŒ€']
                            },
                            {
                                id: 'team-2-1-2',
                                name: 'ë°±ì—”ë“œíŒ€',
                                type: 'team',
                                headcount: 25,
                                childrenCount: 0,
                                hasChildren: false,
                                parentId: 'dept-2-1',
                                path: ['OKê¸ˆìœµê·¸ë£¹', 'ITë³¸ë¶€', 'ê°œë°œë¶€', 'ë°±ì—”ë“œíŒ€']
                            }
                        ]
                    },
                    {
                        id: 'dept-2-2',
                        name: 'ì¸í”„ë¼ë¶€',
                        type: 'department',
                        headcount: 35,
                        childrenCount: 1,
                        hasChildren: true,
                        parentId: 'division-2',
                        path: ['OKê¸ˆìœµê·¸ë£¹', 'ITë³¸ë¶€', 'ì¸í”„ë¼ë¶€'],
                        children: [
                            {
                                id: 'team-2-2-1',
                                name: 'í´ë¼ìš°ë“œíŒ€',
                                type: 'team',
                                headcount: 12,
                                childrenCount: 0,
                                hasChildren: false,
                                parentId: 'dept-2-2',
                                path: ['OKê¸ˆìœµê·¸ë£¹', 'ITë³¸ë¶€', 'ì¸í”„ë¼ë¶€', 'í´ë¼ìš°ë“œíŒ€']
                            }
                        ]
                    }
                ]
            },
            {
                id: 'division-3',
                name: 'ì˜ì—…ë³¸ë¶€',
                type: 'division',
                headcount: 580,
                childrenCount: 15,
                hasChildren: true,
                parentId: 'root',
                path: ['OKê¸ˆìœµê·¸ë£¹', 'ì˜ì—…ë³¸ë¶€'],
                children: []
            }
        ]
    };
    
    showLoading(false);
    processOrgData(sampleData);
    calculateLayout();  // ë ˆì´ì•„ì›ƒ ê³„ì‚° ì¶”ê°€
    renderChart();
}

// ê¸°íƒ€ ë ˆì´ì•„ì›ƒ ê³„ì‚° í•¨ìˆ˜ë“¤ (ê°„ë‹¨í•œ êµ¬í˜„)
function calculateRadialLayout() {
    console.log('Calculating radial layout...');
    // ë°©ì‚¬í˜• ë ˆì´ì•„ì›ƒ ê³„ì‚° ë¡œì§
    // ì„ì‹œë¡œ ê¸°ë³¸ ë ˆì´ì•„ì›ƒ ì‚¬ìš©
    calculateLayout();
}

function calculateGridLayout() {
    console.log('Calculating grid layout...');
    // ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ ê³„ì‚° ë¡œì§
    const nodes = Array.from(OrgChartState.nodes.values());
    const cols = 4;
    let row = 0, col = 0;
    
    nodes.forEach((node, index) => {
        node.x = col * (CONFIG.NODE_WIDTH + CONFIG.SIBLING_SPACING) - (cols * CONFIG.NODE_WIDTH) / 2;
        node.y = row * (CONFIG.NODE_HEIGHT + 40);
        
        col++;
        if (col >= cols) {
            col = 0;
            row++;
        }
    });
}

function calculateCompactLayout() {
    console.log('Calculating compact layout...');
    // ì»´íŒ©íŠ¸ ë ˆì´ì•„ì›ƒ ê³„ì‚° ë¡œì§
    // ì„ì‹œë¡œ ê¸°ë³¸ ë ˆì´ì•„ì›ƒ ì‚¬ìš©
    calculateLayout();
}
</script>
{% endblock %}