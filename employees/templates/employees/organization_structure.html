{% extends 'base_revolutionary.html' %}
{% load static %}

{% block title %}ì¡°ì§ êµ¬ì¡° ê´€ë¦¬{% endblock %}

{% block extra_css %}
<style>
    .upload-container {
        background: #1a1a2e;
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 2rem;
    }

    .upload-area {
        border: 2px dashed #00d4ff;
        border-radius: 8px;
        padding: 3rem;
        text-align: center;
        transition: all 0.3s;
        cursor: pointer;
    }

    .upload-area:hover {
        background: rgba(0, 212, 255, 0.05);
        border-color: #00ff88;
    }

    .upload-area.dragging {
        background: rgba(0, 212, 255, 0.1);
        border-color: #00ff88;
    }

    .preview-table {
        margin-top: 2rem;
        overflow-x: auto;
    }

    .preview-table table {
        width: 100%;
        border-collapse: collapse;
    }

    .preview-table th {
        background: #0f0f23;
        color: #00d4ff;
        padding: 0.75rem;
        text-align: left;
        border: 1px solid #2a2a3e;
    }

    .preview-table td {
        padding: 0.75rem;
        border: 1px solid #2a2a3e;
        color: #e0e0e0;
    }

    .preview-table tr:hover {
        background: rgba(0, 212, 255, 0.05);
    }

    .validation-success {
        color: #00ff88;
    }

    .validation-error {
        color: #ff4444;
    }

    .btn-upload {
        background: linear-gradient(135deg, #00d4ff, #00ff88);
        color: #0a0a1f;
        border: none;
        padding: 0.75rem 2rem;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        margin-top: 1rem;
    }

    .btn-upload:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .stats-card {
        background: #1a1a2e;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1rem;
    }

    .stats-card h3 {
        color: #00d4ff;
        margin-bottom: 1rem;
    }

    .stat-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
        color: #e0e0e0;
    }

    .stat-value {
        color: #00ff88;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1><i class="fas fa-sitemap"></i> ì¡°ì§ êµ¬ì¡° ê´€ë¦¬</h1>
</div>

<!-- í†µê³„ ì¹´ë“œ -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="stats-card">
            <h3>ì „ì²´ ì¡°ì§</h3>
            <div class="stat-value" id="total-orgs">0</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <h3>í™œì„± ì¡°ì§</h3>
            <div class="stat-value" id="active-orgs">0</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <h3>ì „ì²´ ì§ì›</h3>
            <div class="stat-value" id="total-employees">0</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <h3>ìµœì¢… ì—…ë°ì´íŠ¸</h3>
            <div class="stat-value" id="last-update">-</div>
        </div>
    </div>
</div>

<!-- ì—…ë¡œë“œ ì„¹ì…˜ -->
<div class="upload-container">
    <h2><i class="fas fa-upload"></i> Excel íŒŒì¼ ì—…ë¡œë“œ</h2>
    
    <div class="upload-area" id="uploadArea">
        <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: #00d4ff; margin-bottom: 1rem;"></i>
        <p>Excel íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒ</p>
        <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">
    </div>

    <div class="mt-3">
        <a href="{% url 'employees:download_org_sample' %}" class="btn btn-secondary">
            <i class="fas fa-download"></i> ìƒ˜í”Œ ë‹¤ìš´ë¡œë“œ
        </a>
    </div>
</div>

<!-- ë¯¸ë¦¬ë³´ê¸° í…Œì´ë¸” -->
<div id="previewSection" style="display: none;">
    <div class="upload-container">
        <h3><i class="fas fa-table"></i> ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°</h3>
        <div class="preview-table" id="previewTable"></div>
        
        <div class="mt-3">
            <button class="btn-upload" id="uploadBtn" disabled>
                <i class="fas fa-check"></i> ì—…ë¡œë“œ ì™„ë£Œ
            </button>
            <button class="btn btn-secondary" id="cancelBtn">
                <i class="fas fa-times"></i> ì·¨ì†Œ
            </button>
        </div>
    </div>
</div>

<!-- ì¡°ì§ íŠ¸ë¦¬ ë·° -->
<div class="upload-container">
    <h2><i class="fas fa-network-wired"></i> ì¡°ì§ êµ¬ì¡°</h2>
    <div id="orgTree"></div>
</div>

<script>
// CSRF í† í° ê°€ì ¸ì˜¤ê¸°
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

// íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
const uploadArea = document.getElementById('uploadArea');
const fileInput = document.getElementById('fileInput');
const previewSection = document.getElementById('previewSection');
const uploadBtn = document.getElementById('uploadBtn');
const cancelBtn = document.getElementById('cancelBtn');

let uploadData = null;

// í´ë¦­ìœ¼ë¡œ íŒŒì¼ ì„ íƒ
uploadArea.addEventListener('click', () => {
    fileInput.click();
});

// íŒŒì¼ ì„ íƒ ì‹œ
fileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        handleFile(file);
    }
});

// ë“œë˜ê·¸ ì•¤ ë“œë¡­
uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('dragging');
});

uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('dragging');
});

uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragging');
    
    const file = e.dataTransfer.files[0];
    if (file) {
        handleFile(file);
    }
});

// íŒŒì¼ ì²˜ë¦¬
function handleFile(file) {
    if (!file.name.match(/\.(xlsx|xls)$/)) {
        alert('Excel íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(firstSheet);
        
        uploadData = jsonData;
        showPreview(jsonData);
    };
    reader.readAsArrayBuffer(file);
}

// ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
function showPreview(data) {
    if (!data || data.length === 0) {
        alert('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    const headers = Object.keys(data[0]);
    let tableHTML = '<table><thead><tr>';
    
    // í—¤ë”
    headers.forEach(header => {
        tableHTML += `<th>${header}</th>`;
    });
    tableHTML += '<th>ê²€ì¦</th></tr></thead><tbody>';
    
    // ë°ì´í„° (ìµœëŒ€ 10ê°œ)
    const previewData = data.slice(0, 10);
    let allValid = true;
    
    previewData.forEach((row, index) => {
        tableHTML += '<tr>';
        headers.forEach(header => {
            tableHTML += `<td>${row[header] || ''}</td>`;
        });
        
        // ê²€ì¦
        const validation = validateRow(row);
        if (validation.valid) {
            tableHTML += '<td class="validation-success"><i class="fas fa-check"></i></td>';
        } else {
            tableHTML += `<td class="validation-error" title="${validation.errors.join(', ')}"><i class="fas fa-times"></i></td>`;
            allValid = false;
        }
        
        tableHTML += '</tr>';
    });
    
    if (data.length > 10) {
        tableHTML += `<tr><td colspan="${headers.length + 1}" style="text-align: center;">... ì™¸ ${data.length - 10}ê°œ ë°ì´í„°</td></tr>`;
    }
    
    tableHTML += '</tbody></table>';
    
    document.getElementById('previewTable').innerHTML = tableHTML;
    previewSection.style.display = 'block';
    uploadBtn.disabled = !allValid;
}

// ë°ì´í„° ê²€ì¦
function validateRow(row) {
    const errors = [];
    
    if (!row['ì¡°ì§ì½”ë“œ']) errors.push('ì¡°ì§ì½”ë“œ í•„ìˆ˜');
    if (!row['ì¡°ì§ëª…']) errors.push('ì¡°ì§ëª… í•„ìˆ˜');
    if (!row['ì¡°ì§ë ˆë²¨']) errors.push('ì¡°ì§ë ˆë²¨ í•„ìˆ˜');
    
    // ì¡°ì§ë ˆë²¨ì´ ìˆ«ìì¸ì§€ í™•ì¸
    if (row['ì¡°ì§ë ˆë²¨'] && isNaN(parseInt(row['ì¡°ì§ë ˆë²¨']))) {
        errors.push('ì¡°ì§ë ˆë²¨ì€ ìˆ«ìì—¬ì•¼ í•¨');
    }
    
    return {
        valid: errors.length === 0,
        errors: errors
    };
}

// ì—…ë¡œë“œ ì™„ë£Œ
uploadBtn.addEventListener('click', async () => {
    if (!uploadData) return;
    
    uploadBtn.disabled = true;
    uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ì—…ë¡œë“œ ì¤‘...';
    
    try {
        const response = await fetch('{% url "employees:upload_organization_structure" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({ data: uploadData })
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            alert(`ì—…ë¡œë“œ ì™„ë£Œ!\nìƒì„±: ${result.created}ê°œ\nì—…ë°ì´íŠ¸: ${result.updated}ê°œ`);
            resetUpload();
            loadStatistics();
            loadOrganizationTree();
        } else {
            alert(result.message || 'ì—…ë¡œë“œ ì‹¤íŒ¨');
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = '<i class="fas fa-check"></i> ì—…ë¡œë“œ ì™„ë£Œ';
        }
    } catch (error) {
        console.error('Upload error:', error);
        alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        uploadBtn.disabled = false;
        uploadBtn.innerHTML = '<i class="fas fa-check"></i> ì—…ë¡œë“œ ì™„ë£Œ';
    }
});

// ì·¨ì†Œ
cancelBtn.addEventListener('click', () => {
    resetUpload();
});

// ì´ˆê¸°í™”
function resetUpload() {
    fileInput.value = '';
    uploadData = null;
    previewSection.style.display = 'none';
    uploadBtn.disabled = true;
    uploadBtn.innerHTML = '<i class="fas fa-check"></i> ì—…ë¡œë“œ ì™„ë£Œ';
}

// í†µê³„ ë¡œë“œ
async function loadStatistics() {
    try {
        const response = await fetch('{% url "employees:get_organization_stats" %}');
        const stats = await response.json();
        
        document.getElementById('total-orgs').textContent = stats.total_orgs || 0;
        document.getElementById('active-orgs').textContent = stats.active_orgs || 0;
        document.getElementById('total-employees').textContent = stats.total_employees || 0;
        document.getElementById('last-update').textContent = stats.last_update || '-';
    } catch (error) {
        console.error('Failed to load statistics:', error);
    }
}

// ì¡°ì§ íŠ¸ë¦¬ ë¡œë“œ
async function loadOrganizationTree() {
    try {
        const response = await fetch('{% url "employees:get_organization_tree" %}');
        const data = await response.json();
        
        if (data.success) {
            renderTree(data.tree);
        }
    } catch (error) {
        console.error('Failed to load organization tree:', error);
    }
}

// íŠ¸ë¦¬ ë Œë”ë§
function renderTree(tree) {
    const container = document.getElementById('orgTree');
    if (!tree || tree.length === 0) {
        container.innerHTML = '<p style="color: #999;">ì¡°ì§ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
    }
    
    container.innerHTML = renderTreeNodes(tree, 0);
}

function renderTreeNodes(nodes, level) {
    let html = '';
    
    nodes.forEach(node => {
        const icon = getNodeIcon(node.level);
        const marginLeft = level * 30;
        
        html += `
            <div class="tree-node" style="margin-left: ${marginLeft}px; margin-bottom: 0.5rem;">
                <div style="display: flex; align-items: center; padding: 0.5rem; background: rgba(0,212,255,0.05); border-radius: 4px;">
                    <span style="margin-right: 0.5rem;">${icon}</span>
                    <span style="color: #00d4ff; font-weight: bold;">${node.code}</span>
                    <span style="margin-left: 0.5rem; color: #e0e0e0;">${node.name}</span>
                    <span style="margin-left: auto; color: #00ff88;">${node.employee_count || 0}ëª…</span>
                </div>
                ${node.children ? renderTreeNodes(node.children, level + 1) : ''}
            </div>
        `;
    });
    
    return html;
}

function getNodeIcon(level) {
    const icons = {
        1: 'ğŸ¢',  // ê·¸ë£¹
        2: 'ğŸ›ï¸',  // ê³„ì—´ì‚¬
        3: 'ğŸ—ï¸',  // ë³¸ë¶€
        4: 'ğŸ“',  // ë¶€
        5: 'ğŸ‘¥'   // íŒ€
    };
    return icons[level] || 'ğŸ“„';
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', () => {
    loadStatistics();
    loadOrganizationTree();
});
</script>

<!-- SheetJS ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
{% endblock %}