{% extends "base.html" %}
{% load static %}

{% block title %}직무기술서 편집 - {{ job.name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/job_tree_unified.css' %}">
{% endblock %}

{% block content %}
<div class="edit-container">
    <header class="edit-header">
        <button class="btn-back" onclick="history.back()">
            <i class="fas fa-arrow-left"></i> 돌아가기
        </button>
        <h1 class="edit-title">
            <i class="fas fa-edit"></i>
            {{ job.name }} 직무기술서 편집
        </h1>
    </header>

    <form id="editForm" method="post" class="edit-form">
        <!-- 기본 정보 (읽기 전용) -->
        <section class="form-section">
            <h2 class="section-title">기본 정보</h2>
            <div class="info-grid readonly">
                <div class="info-item">
                    <label>직군</label>
                    <span>{{ job.category }}</span>
                </div>
                <div class="info-item">
                    <label>직종</label>
                    <span>{{ job.job_type }}</span>
                </div>
                <div class="info-item">
                    <label>직무명</label>
                    <span>{{ job.name }}</span>
                </div>
            </div>
        </section>

        <!-- 직무기술서 내용 -->
        <section class="form-section">
            <h2 class="section-title">
                <i class="fas fa-tasks"></i> 핵심 역할 및 책임
            </h2>
            <textarea name="role_responsibility" 
                      class="form-textarea" 
                      rows="8" 
                      required
                      placeholder="이 직무의 핵심 역할과 책임을 구체적으로 작성해주세요.">{{ profile.role_responsibility }}</textarea>
        </section>

        <section class="form-section">
            <h2 class="section-title">
                <i class="fas fa-check-circle"></i> 자격 요건
            </h2>
            <textarea name="qualification" 
                      class="form-textarea" 
                      rows="6" 
                      required
                      placeholder="필수 자격 요건을 작성해주세요.">{{ profile.qualification }}</textarea>
        </section>

        <section class="form-section">
            <h2 class="section-title">
                <i class="fas fa-star"></i> 역량
            </h2>
            
            <div class="form-group">
                <label>기본 역량</label>
                <input type="text" 
                       name="basic_skills" 
                       class="form-input tags-input" 
                       value="{{ profile.basic_skills|join:', ' }}"
                       placeholder="예: Python, 데이터 분석, 프로젝트 관리 (쉼표로 구분)">
                <small class="form-help">쉼표(,)로 구분하여 입력해주세요.</small>
            </div>
            
            <div class="form-group">
                <label>우대 역량</label>
                <input type="text" 
                       name="applied_skills" 
                       class="form-input tags-input" 
                       value="{{ profile.applied_skills|join:', ' }}"
                       placeholder="예: AWS, Docker, 영어 회화 (쉼표로 구분)">
            </div>
        </section>

        <section class="form-section">
            <h2 class="section-title">
                <i class="fas fa-route"></i> 성장 경로
            </h2>
            <textarea name="growth_path" 
                      class="form-textarea" 
                      rows="5"
                      placeholder="이 직무에서의 경력 개발 및 성장 경로를 작성해주세요.">{{ profile.growth_path }}</textarea>
        </section>

        <section class="form-section">
            <h2 class="section-title">
                <i class="fas fa-certificate"></i> 관련 자격증
            </h2>
            <input type="text" 
                   name="related_certifications" 
                   class="form-input tags-input" 
                   value="{{ profile.related_certifications|join:', ' }}"
                   placeholder="예: 정보처리기사, CPA, PMP (쉼표로 구분)">
        </section>

        <!-- 액션 버튼 -->
        <div class="form-actions">
            <button type="submit" class="btn btn-primary btn-lg">
                <i class="fas fa-save"></i> 저장
            </button>
            <button type="button" class="btn btn-secondary btn-lg" onclick="history.back()">
                취소
            </button>
        </div>
    </form>
</div>

<script>
// 폼 제출 처리
document.getElementById('editForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {};
    
    // FormData를 JSON으로 변환
    for (let [key, value] of formData.entries()) {
        if (key.includes('skills') || key === 'related_certifications') {
            // 태그 입력 필드는 배열로 변환
            data[key] = value.split(',').map(v => v.trim()).filter(v => v);
        } else {
            data[key] = value;
        }
    }
    
    try {
        const response = await fetch('{{ request.path }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('저장되었습니다.');
            window.location.href = '/job-profiles/';
        } else {
            alert('저장에 실패했습니다: ' + (result.error || '알 수 없는 오류'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('서버 오류가 발생했습니다.');
    }
});

// 태그 입력 미리보기
document.querySelectorAll('.tags-input').forEach(input => {
    input.addEventListener('input', function() {
        // 태그 미리보기 로직 추가 가능
    });
});
</script>
{% endblock %}