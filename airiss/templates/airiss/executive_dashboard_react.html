{% extends "airiss/react_base.html" %}
{% load static %}

{% block react_component %}
<script type="text/babel">
const { useState, useEffect } = React;
const { 
    Box, Card, CardContent, Grid, Typography, Paper, List, ListItem,
    ListItemAvatar, ListItemText, Avatar, Chip, Button, IconButton,
    Divider, CircularProgress, Alert
} = MaterialUI;

// Chart Ïª¥Ìè¨ÎÑåÌä∏
const { Bar, Doughnut, Radar } = ReactChartjs2;

// AIRISS Í≤ΩÏòÅÏßÑ ÎåÄÏãúÎ≥¥Îìú Ïª¥Ìè¨ÎÑåÌä∏
const ExecutiveDashboard = () => {
    const [loading, setLoading] = useState(true);
    const [data, setData] = useState(null);
    const [error, setError] = useState(null);

    useEffect(() => {
        fetchDashboardData();
    }, []);

    const fetchDashboardData = async () => {
        try {
            setLoading(true);
            
            // EHR APIÏóêÏÑú ÏßÅÏõê Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
            const response = await fetch('/api/employees/', {
                headers: {
                    'X-CSRFToken': window.AIRISS_CONFIG.CSRF_TOKEN,
                }
            });
            
            if (!response.ok) throw new Error('Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®');
            
            const employees = await response.json();
            
            // Îç∞Ïù¥ÌÑ∞ Î∂ÑÏÑù
            const processedData = processEmployeeData(employees);
            setData(processedData);
            
        } catch (err) {
            setError(err.message);
        } finally {
            setLoading(false);
        }
    };

    const processEmployeeData = (employees) => {
        // Î∂ÄÏÑúÎ≥Ñ ÌÜµÍ≥Ñ
        const departmentStats = {};
        const gradeStats = {};
        const ageGroups = { '20ÎåÄ': 0, '30ÎåÄ': 0, '40ÎåÄ': 0, '50ÎåÄ Ïù¥ÏÉÅ': 0 };
        
        employees.forEach(emp => {
            // Î∂ÄÏÑúÎ≥Ñ
            if (emp.department) {
                departmentStats[emp.department] = (departmentStats[emp.department] || 0) + 1;
            }
            
            // ÏßÅÍ∏âÎ≥Ñ
            if (emp.position) {
                gradeStats[emp.position] = (gradeStats[emp.position] || 0) + 1;
            }
            
            // Ïó∞Î†πÎåÄÎ≥Ñ
            if (emp.age) {
                if (emp.age < 30) ageGroups['20ÎåÄ']++;
                else if (emp.age < 40) ageGroups['30ÎåÄ']++;
                else if (emp.age < 50) ageGroups['40ÎåÄ']++;
                else ageGroups['50ÎåÄ Ïù¥ÏÉÅ']++;
            }
        });

        return {
            totalEmployees: employees.length,
            departmentStats,
            gradeStats,
            ageGroups,
            employees: employees.slice(0, 10) // ÏÉÅÏúÑ 10Î™ÖÎßå
        };
    };

    if (loading) {
        return (
            <Box display="flex" justifyContent="center" alignItems="center" minHeight="400px">
                <CircularProgress />
            </Box>
        );
    }

    if (error) {
        return (
            <Box p={3}>
                <Alert severity="error">{error}</Alert>
            </Box>
        );
    }

    // Ï∞®Ìä∏ Îç∞Ïù¥ÌÑ∞ ÏÑ§Ï†ï
    const departmentChartData = {
        labels: Object.keys(data.departmentStats),
        datasets: [{
            label: 'Ïù∏Ïõê Ïàò',
            data: Object.values(data.departmentStats),
            backgroundColor: [
                'rgba(255, 99, 132, 0.5)',
                'rgba(54, 162, 235, 0.5)',
                'rgba(255, 206, 86, 0.5)',
                'rgba(75, 192, 192, 0.5)',
                'rgba(153, 102, 255, 0.5)',
            ],
        }]
    };

    const ageChartData = {
        labels: Object.keys(data.ageGroups),
        datasets: [{
            label: 'Ïó∞Î†πÎåÄÎ≥Ñ Î∂ÑÌè¨',
            data: Object.values(data.ageGroups),
            backgroundColor: [
                'rgba(255, 99, 132, 0.5)',
                'rgba(54, 162, 235, 0.5)',
                'rgba(255, 206, 86, 0.5)',
                'rgba(75, 192, 192, 0.5)',
            ],
        }]
    };

    return (
        <Box sx={{ p: 3, backgroundColor: '#f5f7fa', minHeight: '100vh' }}>
            {/* Ìó§Îçî */}
            <Paper 
                sx={{ 
                    p: 3, 
                    mb: 3,
                    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    color: 'white'
                }}
            >
                <Typography variant="h4" gutterBottom>
                    Í≤ΩÏòÅÏßÑ ÎåÄÏãúÎ≥¥Îìú
                </Typography>
                <Typography variant="body2" sx={{ opacity: 0.9 }}>
                    ÏµúÏ¢Ö ÏóÖÎç∞Ïù¥Ìä∏: {new Date().toLocaleString('ko-KR')}
                </Typography>
            </Paper>

            {/* Ï£ºÏöî ÏßÄÌëú */}
            <Grid container spacing={3} sx={{ mb: 3 }}>
                <Grid item xs={12} md={3}>
                    <Card>
                        <CardContent>
                            <Typography color="textSecondary" gutterBottom>
                                Ï†ÑÏ≤¥ ÏßÅÏõê Ïàò
                            </Typography>
                            <Typography variant="h3">
                                {data.totalEmployees}
                            </Typography>
                            <Chip 
                                label="+5.2%" 
                                color="success" 
                                size="small" 
                                sx={{ mt: 1 }}
                            />
                        </CardContent>
                    </Card>
                </Grid>
                
                <Grid item xs={12} md={3}>
                    <Card>
                        <CardContent>
                            <Typography color="textSecondary" gutterBottom>
                                ÌèâÍ∑† Í∑ºÏÜçÏó∞Ïàò
                            </Typography>
                            <Typography variant="h3">
                                7.5ÎÖÑ
                            </Typography>
                            <Chip 
                                label="ÏïàÏ†ïÏ†Å" 
                                color="primary" 
                                size="small" 
                                sx={{ mt: 1 }}
                            />
                        </CardContent>
                    </Card>
                </Grid>
                
                <Grid item xs={12} md={3}>
                    <Card>
                        <CardContent>
                            <Typography color="textSecondary" gutterBottom>
                                AI Î∂ÑÏÑù Ï†êÏàò
                            </Typography>
                            <Typography variant="h3">
                                85.3
                            </Typography>
                            <Chip 
                                label="Ïö∞Ïàò" 
                                color="success" 
                                size="small" 
                                sx={{ mt: 1 }}
                            />
                        </CardContent>
                    </Card>
                </Grid>
                
                <Grid item xs={12} md={3}>
                    <Card>
                        <CardContent>
                            <Typography color="textSecondary" gutterBottom>
                                Ïù¥ÏßÅÎ•†
                            </Typography>
                            <Typography variant="h3">
                                3.2%
                            </Typography>
                            <Chip 
                                label="-0.8%" 
                                color="success" 
                                size="small" 
                                sx={{ mt: 1 }}
                            />
                        </CardContent>
                    </Card>
                </Grid>
            </Grid>

            {/* Ï∞®Ìä∏ ÏòÅÏó≠ */}
            <Grid container spacing={3}>
                <Grid item xs={12} md={6}>
                    <Card>
                        <CardContent>
                            <Typography variant="h6" gutterBottom>
                                Î∂ÄÏÑúÎ≥Ñ Ïù∏Ïõê Î∂ÑÌè¨
                            </Typography>
                            <Box sx={{ height: 300 }}>
                                <Bar 
                                    data={departmentChartData}
                                    options={{
                                        responsive: true,
                                        maintainAspectRatio: false,
                                        plugins: {
                                            legend: {
                                                display: false
                                            }
                                        }
                                    }}
                                />
                            </Box>
                        </CardContent>
                    </Card>
                </Grid>
                
                <Grid item xs={12} md={6}>
                    <Card>
                        <CardContent>
                            <Typography variant="h6" gutterBottom>
                                Ïó∞Î†πÎåÄÎ≥Ñ Î∂ÑÌè¨
                            </Typography>
                            <Box sx={{ height: 300 }}>
                                <Doughnut 
                                    data={ageChartData}
                                    options={{
                                        responsive: true,
                                        maintainAspectRatio: false
                                    }}
                                />
                            </Box>
                        </CardContent>
                    </Card>
                </Grid>
            </Grid>

            {/* AI Ïù∏ÏÇ¨Ïù¥Ìä∏ */}
            <Card sx={{ mt: 3 }}>
                <CardContent>
                    <Typography variant="h6" gutterBottom>
                        AI Ïù∏ÏÇ¨Ïù¥Ìä∏
                    </Typography>
                    <List>
                        <ListItem>
                            <ListItemAvatar>
                                <Avatar sx={{ bgcolor: 'success.main' }}>
                                    <span>üìà</span>
                                </Avatar>
                            </ListItemAvatar>
                            <ListItemText 
                                primary="Ï°∞ÏßÅ ÏïàÏ†ïÏÑ± Ïö∞Ïàò"
                                secondary="ÌèâÍ∑† Í∑ºÏÜçÏó∞ÏàòÍ∞Ä ÏóÖÍ≥Ñ ÌèâÍ∑† ÎåÄÎπÑ 20% ÎÜíÏäµÎãàÎã§."
                            />
                        </ListItem>
                        <Divider variant="inset" component="li" />
                        <ListItem>
                            <ListItemAvatar>
                                <Avatar sx={{ bgcolor: 'warning.main' }}>
                                    <span>‚ö†Ô∏è</span>
                                </Avatar>
                            </ListItemAvatar>
                            <ListItemText 
                                primary="Ïó∞Î†πÎåÄ Î∂àÍ∑†Ìòï Ï£ºÏùò"
                                secondary="30ÎåÄ ÏßÅÏõê ÎπÑÏ§ëÏù¥ Í≥ºÎèÑÌïòÍ≤å ÎÜíÏïÑ Ìñ•ÌõÑ ÏäπÏßÑ Î≥ëÎ™© Ïö∞Î†§Îê©ÎãàÎã§."
                            />
                        </ListItem>
                        <Divider variant="inset" component="li" />
                        <ListItem>
                            <ListItemAvatar>
                                <Avatar sx={{ bgcolor: 'info.main' }}>
                                    <span>üí°</span>
                                </Avatar>
                            </ListItemAvatar>
                            <ListItemText 
                                primary="ÎîîÏßÄÌÑ∏ Ïó≠Îüâ Í∞ïÌôî ÌïÑÏöî"
                                secondary="IT Î∂ÄÏÑú Ïù∏Î†• ÌôïÏ∂©Í≥º Ï†ÑÏÇ¨ ÎîîÏßÄÌÑ∏ ÍµêÏú° ÌîÑÎ°úÍ∑∏Îû® ÎèÑÏûÖÏùÑ Í∂åÏû•Ìï©ÎãàÎã§."
                            />
                        </ListItem>
                    </List>
                </CardContent>
            </Card>
        </Box>
    );
};

// React Ïª¥Ìè¨ÎÑåÌä∏ Î†åÎçîÎßÅ
const root = ReactDOM.createRoot(document.getElementById('airiss-react-root'));
root.render(<ExecutiveDashboard />);
</script>
{% endblock %}