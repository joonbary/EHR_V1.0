{% extends 'base.html' %}
{% load static %}

{% block title %}기여도 평가 - {{ employee.name }}{% endblock %}

{% block extra_css %}
<style>
    /* Scoring Chart 스타일 */
    .scoring-chart {
        display: grid;
        grid-template-columns: 150px repeat(4, 1fr);
        gap: 1px;
        background-color: #e5e7eb;
        border-radius: 8px;
        overflow: hidden;
    }
    
    .scoring-chart > div {
        background-color: white;
        padding: 12px;
        text-align: center;
        font-size: 14px;
    }
    
    .scoring-chart .header {
        background-color: #f3f4f6;
        font-weight: 600;
    }
    
    .scoring-chart .row-header {
        background-color: #f9fafb;
        font-weight: 500;
        text-align: left;
    }
    
    .scoring-chart .score-cell {
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .scoring-chart .score-cell:hover {
        background-color: #fff5eb;
        transform: scale(1.05);
    }
    
    .scoring-chart .score-cell.selected {
        background-color: #ff6b00;
        color: white;
        font-weight: 600;
    }
    
    /* Task 카드 스타일 */
    .task-card {
        transition: all 0.3s;
    }
    
    .task-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    }
    
    /* 진행률 바 */
    .progress-bar {
        transition: width 0.3s ease;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- 헤더 -->
    <div class="mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">기여도 평가</h1>
                <p class="text-gray-600 mt-2">{{ employee.name }} ({{ employee.employee_id }}) | {{ active_period }}</p>
            </div>
            <div class="flex space-x-3">
                <button onclick="saveEvaluation()" class="px-6 py-3 bg-primary text-white rounded-xl hover:bg-primary-hover transition-colors">
                    <i data-lucide="save" class="w-5 h-5 inline mr-2"></i>
                    저장하기
                </button>
                <a href="{% url 'evaluations:dashboard' %}" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-xl hover:bg-gray-300 transition-colors">
                    <i data-lucide="arrow-left" class="w-5 h-5 inline mr-2"></i>
                    돌아가기
                </a>
            </div>
        </div>
    </div>

    <!-- 평가 진행 상황 -->
    <div class="bg-white rounded-2xl shadow-sm p-6 mb-6">
        <h2 class="text-lg font-semibold mb-4">평가 진행 현황</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="text-center">
                <div class="text-3xl font-bold text-primary">{{ tasks.count }}</div>
                <div class="text-sm text-gray-600">등록된 Task</div>
            </div>
            <div class="text-center">
                <div class="text-3xl font-bold text-green-600">{{ completed_tasks }}</div>
                <div class="text-sm text-gray-600">완료된 Task</div>
            </div>
            <div class="text-center">
                <div class="text-3xl font-bold text-blue-600">{{ total_weight }}%</div>
                <div class="text-sm text-gray-600">총 가중치</div>
            </div>
        </div>
    </div>

    <!-- Scoring Chart -->
    <div class="bg-white rounded-2xl shadow-sm p-6 mb-6">
        <h2 class="text-lg font-semibold mb-4">기여도 Scoring Chart</h2>
        <div class="scoring-chart mb-4">
            <!-- 헤더 행 -->
            <div class="header">기여 범위 \ 기여 방식</div>
            <div class="header">총괄</div>
            <div class="header">리딩</div>
            <div class="header">실무</div>
            <div class="header">지원</div>
            
            <!-- 전략적 -->
            <div class="row-header">전략적</div>
            <div class="score-cell" data-scope="strategic" data-method="directing" data-score="4">4점</div>
            <div class="score-cell" data-scope="strategic" data-method="leading" data-score="4">4점</div>
            <div class="score-cell" data-scope="strategic" data-method="individual" data-score="3">3점</div>
            <div class="score-cell" data-scope="strategic" data-method="support" data-score="2">2점</div>
            
            <!-- 상호적 -->
            <div class="row-header">상호적</div>
            <div class="score-cell" data-scope="mutual" data-method="directing" data-score="3">3점</div>
            <div class="score-cell" data-scope="mutual" data-method="leading" data-score="3">3점</div>
            <div class="score-cell" data-scope="mutual" data-method="individual" data-score="3">3점</div>
            <div class="score-cell" data-scope="mutual" data-method="support" data-score="2">2점</div>
            
            <!-- 독립적 -->
            <div class="row-header">독립적</div>
            <div class="score-cell" data-scope="independent" data-method="directing" data-score="2">2점</div>
            <div class="score-cell" data-scope="independent" data-method="leading" data-score="3">3점</div>
            <div class="score-cell" data-scope="independent" data-method="individual" data-score="2">2점</div>
            <div class="score-cell" data-scope="independent" data-method="support" data-score="1">1점</div>
            
            <!-- 의존적 -->
            <div class="row-header">의존적</div>
            <div class="score-cell" data-scope="dependent" data-method="directing" data-score="2">2점</div>
            <div class="score-cell" data-scope="dependent" data-method="leading" data-score="2">2점</div>
            <div class="score-cell" data-scope="dependent" data-method="individual" data-score="1">1점</div>
            <div class="score-cell" data-scope="dependent" data-method="support" data-score="1">1점</div>
        </div>
        <p class="text-sm text-gray-600">* 각 Task의 기여 범위와 방식을 선택하면 자동으로 점수가 계산됩니다.</p>
    </div>

    <!-- Task 목록 -->
    <div class="bg-white rounded-2xl shadow-sm p-6">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-lg font-semibold">Task 목록</h2>
            <button onclick="addTask()" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-hover transition-colors">
                <i data-lucide="plus" class="w-4 h-4 inline mr-1"></i>
                Task 추가
            </button>
        </div>

        <form id="evaluationForm" method="post">
            {% csrf_token %}
            <div class="space-y-4">
                {% for task in tasks %}
                <div class="task-card border border-gray-200 rounded-xl p-6">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                        <!-- Task 정보 -->
                        <div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Task 명</label>
                                <input type="text" 
                                       name="task_{{ task.id }}_title" 
                                       value="{{ task.title }}"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-1">설명</label>
                                <textarea name="task_{{ task.id }}_description" 
                                          rows="2"
                                          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">{{ task.description }}</textarea>
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Task 유형</label>
                                <select name="task_{{ task.id }}_type" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                                    <option value="strategic" {% if task.contribution_type == 'strategic' %}selected{% endif %}>전략과제</option>
                                    <option value="improvement" {% if task.contribution_type == 'improvement' %}selected{% endif %}>개선과제</option>
                                    <option value="operation" {% if task.contribution_type == 'operation' %}selected{% endif %}>운영과제</option>
                                    <option value="project" {% if task.contribution_type == 'project' %}selected{% endif %}>프로젝트</option>
                                </select>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">가중치 (%)</label>
                                    <input type="number" 
                                           name="task_{{ task.id }}_weight" 
                                           value="{{ task.weight }}"
                                           min="0" max="100"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">단위</label>
                                    <input type="text" 
                                           name="task_{{ task.id }}_unit" 
                                           value="{{ task.target_unit }}"
                                           placeholder="건, %, 시간 등"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                                </div>
                            </div>
                        </div>

                        <!-- 평가 정보 -->
                        <div>
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">기여 방식</label>
                                    <select name="task_{{ task.id }}_method" 
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                                            onchange="updateTaskScore({{ task.id }})">
                                        <option value="directing" {% if task.contribution_method == 'directing' %}selected{% endif %}>총괄</option>
                                        <option value="leading" {% if task.contribution_method == 'leading' %}selected{% endif %}>리딩</option>
                                        <option value="individual" {% if task.contribution_method == 'individual' %}selected{% endif %}>실무</option>
                                        <option value="support" {% if task.contribution_method == 'support' %}selected{% endif %}>지원</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">기여 범위</label>
                                    <select name="task_{{ task.id }}_scope" 
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                                            onchange="updateTaskScore({{ task.id }})">
                                        <option value="strategic" {% if task.contribution_scope == 'strategic' %}selected{% endif %}>전략적</option>
                                        <option value="mutual" {% if task.contribution_scope == 'mutual' %}selected{% endif %}>상호적</option>
                                        <option value="independent" {% if task.contribution_scope == 'independent' %}selected{% endif %}>독립적</option>
                                        <option value="dependent" {% if task.contribution_scope == 'dependent' %}selected{% endif %}>의존적</option>
                                    </select>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">목표값</label>
                                    <input type="number" 
                                           name="task_{{ task.id }}_target" 
                                           value="{{ task.target_value }}"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">실적값</label>
                                    <input type="number" 
                                           name="task_{{ task.id }}_actual" 
                                           value="{{ task.actual_value }}"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                                           onchange="calculateAchievement({{ task.id }})">
                                </div>
                            </div>
                            
                            <!-- 달성률 및 점수 표시 -->
                            <div class="bg-gray-50 rounded-lg p-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">달성률</span>
                                    <span class="text-lg font-semibold" id="achievement_{{ task.id }}">
                                        {% if task.achievement_rate %}{{ task.achievement_rate }}%{% else %}0%{% endif %}
                                    </span>
                                </div>
                                <div class="flex justify-between items-center mt-2">
                                    <span class="text-sm text-gray-600">기여도 점수</span>
                                    <span class="text-lg font-semibold text-primary" id="score_{{ task.id }}">
                                        {{ task.final_score|default:"0" }}점
                                    </span>
                                </div>
                                <div class="flex justify-between items-center mt-3 pt-3 border-t">
                                    <div class="text-xs text-gray-500">
                                        {% if task.last_checkin_date %}
                                            마지막 체크인: {{ task.last_checkin_date|date:"m/d H:i" }}
                                        {% else %}
                                            체크인 기록 없음
                                        {% endif %}
                                    </div>
                                    <button type="button" 
                                            onclick="showCheckinModal({{ task.id }})"
                                            class="px-3 py-1 bg-blue-500 text-white text-sm rounded hover:bg-blue-600 transition-colors">
                                        <i data-lucide="check-circle" class="w-4 h-4 inline mr-1"></i>
                                        Check-in
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="text-center py-12">
                    <i data-lucide="clipboard-list" class="w-16 h-16 text-gray-300 mx-auto mb-4"></i>
                    <p class="text-gray-500">등록된 Task가 없습니다.</p>
                    <button onclick="addTask()" class="mt-4 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-hover transition-colors">
                        첫 Task 추가하기
                    </button>
                </div>
                {% endfor %}
            </div>

            <!-- 총평 -->
            <div class="mt-6 border-t pt-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">평가자 의견</label>
                <textarea name="comments" 
                          rows="4"
                          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                          placeholder="평가 대상자의 기여도에 대한 종합적인 의견을 작성해주세요.">{{ evaluation.comments }}</textarea>
            </div>
        </form>
    </div>
</div>

<!-- Check-in 모달 -->
<div id="checkinModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-xl bg-white">
        <div class="mt-3">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Task Check-in</h3>
            <form id="checkinForm" onsubmit="performCheckin(event)">
                <input type="hidden" id="checkin_task_id" name="task_id">
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">현재 실적값</label>
                    <input type="number" 
                           id="checkin_actual_value"
                           name="actual_value" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                           placeholder="실적값을 입력하세요">
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">진행 상황 메모</label>
                    <textarea id="checkin_progress_note"
                              name="progress_note" 
                              rows="3"
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                              placeholder="진행 상황을 간단히 기록하세요"></textarea>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button type="button" 
                            onclick="hideCheckinModal()"
                            class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                        취소
                    </button>
                    <button type="submit" 
                            class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-hover transition-colors">
                        Check-in 저장
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Check-in 모달 관리
function showCheckinModal(taskId) {
    document.getElementById('checkin_task_id').value = taskId;
    
    // 현재 실적값 가져오기
    const actualInput = document.querySelector(`input[name="task_${taskId}_actual"]`);
    if (actualInput) {
        document.getElementById('checkin_actual_value').value = actualInput.value;
    }
    
    document.getElementById('checkinModal').classList.remove('hidden');
}

function hideCheckinModal() {
    document.getElementById('checkinModal').classList.add('hidden');
    document.getElementById('checkinForm').reset();
}

// Check-in 수행
function performCheckin(event) {
    event.preventDefault();
    
    const taskId = document.getElementById('checkin_task_id').value;
    const actualValue = document.getElementById('checkin_actual_value').value;
    const progressNote = document.getElementById('checkin_progress_note').value;
    
    // AJAX 요청
    fetch(`/evaluations/contribution/checkin/${taskId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: new URLSearchParams({
            'actual_value': actualValue,
            'progress_note': progressNote
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // UI 업데이트
            const actualInput = document.querySelector(`input[name="task_${taskId}_actual"]`);
            if (actualInput && actualValue) {
                actualInput.value = actualValue;
            }
            
            // 달성률 재계산
            calculateAchievement(taskId);
            
            // 성공 메시지
            alert('Check-in이 완료되었습니다.');
            hideCheckinModal();
            
            // 페이지 새로고침 (선택사항)
            // location.reload();
        } else {
            alert('Check-in 중 오류가 발생했습니다: ' + (data.error || '알 수 없는 오류'));
        }
    })
    .catch(error => {
        alert('네트워크 오류가 발생했습니다.');
        console.error('Error:', error);
    });
}

// Scoring Chart 클릭 이벤트
document.addEventListener('DOMContentLoaded', function() {
    // Scoring Chart 셀 클릭 이벤트
    document.querySelectorAll('.score-cell').forEach(cell => {
        cell.addEventListener('click', function() {
            const scope = this.dataset.scope;
            const method = this.dataset.method;
            highlightScoringChart(scope, method);
        });
    });
});
</script>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/contribution_scoring.js' %}"></script>
{% endblock %}