{% extends 'base.html' %}
{% load static %}

{% block title %}성장레벨 대시보드{% endblock %}

{% block extra_css %}
<style>
    /* 성장레벨 카드 스타일 */
    .growth-card {
        transition: all 0.3s;
        border: 2px solid transparent;
    }
    
    .growth-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        border-color: #ff6b00;
    }
    
    /* 레벨 인디케이터 */
    .level-indicator {
        position: relative;
        height: 8px;
        background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);
        border-radius: 4px;
        overflow: hidden;
    }
    
    .level-progress {
        height: 100%;
        background: linear-gradient(135deg, #ff6b00 0%, #ffaa00 100%);
        transition: width 0.5s ease;
        position: relative;
    }
    
    .level-progress::after {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 4px;
        height: 100%;
        background: rgba(255, 255, 255, 0.3);
        animation: shimmer 2s infinite;
    }
    
    @keyframes shimmer {
        0% { opacity: 0; transform: translateX(-4px); }
        50% { opacity: 1; transform: translateX(0); }
        100% { opacity: 0; transform: translateX(4px); }
    }
    
    /* 성과 트렌드 차트 */
    .trend-chart {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-radius: 12px;
        padding: 20px;
    }
    
    /* 승급 자격 상태 */
    .promotion-status {
        border-radius: 12px;
        padding: 16px;
        border-left: 4px solid;
    }
    
    .promotion-eligible {
        background: linear-gradient(135deg, #ecfdf5 0%, #f0fdf4 100%);
        border-left-color: #10b981;
    }
    
    .promotion-pending {
        background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        border-left-color: #f59e0b;
    }
    
    .promotion-not-ready {
        background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
        border-left-color: #ef4444;
    }
    
    /* 성장 히스토리 타임라인 */
    .growth-timeline {
        position: relative;
    }
    
    .growth-timeline::before {
        content: '';
        position: absolute;
        left: 20px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: linear-gradient(135deg, #ff6b00 0%, #ffaa00 100%);
    }
    
    .timeline-item {
        position: relative;
        margin-left: 40px;
        padding-bottom: 24px;
    }
    
    .timeline-dot {
        position: absolute;
        left: -48px;
        top: 8px;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #ff6b00;
        border: 3px solid white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    /* 추천사항 카드 */
    .recommendation-card {
        border-left: 4px solid;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 12px;
    }
    
    .priority-urgent {
        background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
        border-left-color: #ef4444;
    }
    
    .priority-high {
        background: linear-gradient(135deg, #fff7ed 0%, #fed7aa 100%);
        border-left-color: #f97316;
    }
    
    .priority-medium {
        background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        border-left-color: #f59e0b;
    }
    
    .priority-low {
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        border-left-color: #0ea5e9;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- 헤더 -->
    <div class="mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">성장레벨 대시보드</h1>
                <p class="text-gray-600 mt-2">{{ employee.name }}님의 성장 현황 및 승급 준비도</p>
            </div>
            <div class="flex space-x-3">
                <a href="{% url 'evaluations:growth_history' %}" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-xl hover:bg-gray-300 transition-colors">
                    <i data-lucide="history" class="w-5 h-5 inline mr-2"></i>
                    성장 이력
                </a>
                <a href="{% url 'evaluations:dashboard' %}" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-xl hover:bg-gray-300 transition-colors">
                    <i data-lucide="arrow-left" class="w-5 h-5 inline mr-2"></i>
                    돌아가기
                </a>
            </div>
        </div>
    </div>

    <!-- 현재 성장레벨 및 진행상황 -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        <!-- 현재 레벨 -->
        <div class="growth-card bg-white rounded-2xl shadow-sm p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">현재 성장레벨</h3>
                <div class="w-12 h-12 bg-primary-light rounded-full flex items-center justify-center">
                    <span class="text-xl font-bold text-primary">{{ current_level.level|default:"1" }}</span>
                </div>
            </div>
            
            <div class="mb-4">
                <h4 class="font-semibold text-gray-800">{{ current_level.name|default:"초급" }}</h4>
                <p class="text-sm text-gray-600 mt-1">{{ current_level.description|default:"성장레벨 정보가 없습니다." }}</p>
            </div>
            
            <div class="flex items-center justify-between text-sm text-gray-500">
                <span>레벨 {{ current_level.level|default:"1" }}</span>
                <span>Level {{ current_level.level|default:"1" }}</span>
            </div>
        </div>
        
        <!-- 다음 레벨까지 진행도 -->
        <div class="growth-card bg-white rounded-2xl shadow-sm p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">다음 레벨까지</h3>
                <i data-lucide="trending-up" class="w-6 h-6 text-primary"></i>
            </div>
            
            <div class="mb-4">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-2xl font-bold text-gray-900">{{ promotion_progress|default:"0" }}%</span>
                    <span class="text-sm text-gray-600">목표: 레벨 {{ next_level.level|default:"2" }}</span>
                </div>
                <div class="level-indicator">
                    <div class="level-progress" style="width: {{ promotion_progress|default:"0" }}%"></div>
                </div>
            </div>
            
            <p class="text-sm text-gray-600">
                {% if next_level %}
                    {{ next_level.name }} 승급까지 {{ promotion_requirements_remaining }}개 요구사항 남음
                {% else %}
                    최고 레벨에 도달했습니다
                {% endif %}
            </p>
        </div>
        
        <!-- 전체 점수 -->
        <div class="growth-card bg-white rounded-2xl shadow-sm p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">종합 점수</h3>
                <i data-lucide="award" class="w-6 h-6 text-primary"></i>
            </div>
            
            <div class="mb-4">
                <div class="text-3xl font-bold text-gray-900 mb-2">{{ latest_history.overall_score|default:"0.0" }}</div>
                <div class="flex items-center space-x-4 text-sm">
                    <div class="flex items-center">
                        <div class="w-3 h-3 bg-blue-500 rounded-full mr-2"></div>
                        <span class="text-gray-600">기여도: {{ latest_history.contribution_score|default:"0.0" }}</span>
                    </div>
                </div>
                <div class="flex items-center space-x-4 text-sm mt-1">
                    <div class="flex items-center">
                        <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
                        <span class="text-gray-600">전문성: {{ latest_history.expertise_score|default:"0.0" }}</span>
                    </div>
                </div>
                <div class="flex items-center space-x-4 text-sm mt-1">
                    <div class="flex items-center">
                        <div class="w-3 h-3 bg-purple-500 rounded-full mr-2"></div>
                        <span class="text-gray-600">영향력: {{ latest_history.impact_score|default:"0.0" }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 승급 자격 및 성과 트렌드 -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- 승급 자격 현황 -->
        <div class="bg-white rounded-2xl shadow-sm p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-6">승급 자격 현황</h3>
            
            <div class="promotion-status 
                    {% if latest_history.is_promotion_eligible %}promotion-eligible
                    {% elif latest_history.meets_score_requirement %}promotion-pending
                    {% else %}promotion-not-ready{% endif %} mb-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h4 class="font-semibold 
                                {% if latest_history.is_promotion_eligible %}text-green-800
                                {% elif latest_history.meets_score_requirement %}text-yellow-800
                                {% else %}text-red-800{% endif %}">
                            {% if latest_history.is_promotion_eligible %}
                                승급 자격 충족
                            {% elif latest_history.meets_score_requirement %}
                                점수 요구사항 충족
                            {% else %}
                                승급 준비 필요
                            {% endif %}
                        </h4>
                        <p class="text-sm mt-1
                                {% if latest_history.is_promotion_eligible %}text-green-700
                                {% elif latest_history.meets_score_requirement %}text-yellow-700
                                {% else %}text-red-700{% endif %}">
                            {% if latest_history.is_promotion_eligible %}
                                모든 승급 요구사항을 충족했습니다
                            {% elif latest_history.meets_score_requirement %}
                                {{ latest_history.consecutive_achievements }}회 연속 달성 ({{ promotion_consecutive_required }}회 필요)
                            {% else %}
                                성과 점수 개선이 필요합니다
                            {% endif %}
                        </p>
                    </div>
                    <i data-lucide="{% if latest_history.is_promotion_eligible %}check-circle{% elif latest_history.meets_score_requirement %}clock{% else %}alert-circle{% endif %}" 
                       class="w-8 h-8 {% if latest_history.is_promotion_eligible %}text-green-600{% elif latest_history.meets_score_requirement %}text-yellow-600{% else %}text-red-600{% endif %}"></i>
                </div>
            </div>
            
            <!-- 승급 요구사항 체크리스트 -->
            {% if next_level_requirements %}
            <div class="space-y-3">
                <h4 class="font-medium text-gray-700">승급 요구사항</h4>
                {% for requirement in next_level_requirements %}
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center">
                        <i data-lucide="{% if requirement.is_met %}check-circle{% else %}circle{% endif %}" 
                           class="w-5 h-5 mr-3 {% if requirement.is_met %}text-green-600{% else %}text-gray-400{% endif %}"></i>
                        <span class="text-sm {% if requirement.is_met %}text-gray-900{% else %}text-gray-600{% endif %}">
                            {{ requirement.description }}
                        </span>
                    </div>
                    {% if requirement.current_value %}
                    <span class="text-xs text-gray-500">{{ requirement.current_value }}/{{ requirement.required_value }}</span>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        
        <!-- 성과 트렌드 차트 -->
        <div class="bg-white rounded-2xl shadow-sm p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-6">성과 트렌드</h3>
            
            <div class="trend-chart">
                <canvas id="performanceTrendChart" width="400" height="200"></canvas>
            </div>
            
            {% if latest_trend %}
            <div class="mt-4 grid grid-cols-2 gap-4">
                <div class="text-center">
                    <div class="text-lg font-semibold 
                            {% if latest_trend.overall_change_rate > 5 %}text-green-600
                            {% elif latest_trend.overall_change_rate > -5 %}text-gray-600
                            {% else %}text-red-600{% endif %}">
                        {% if latest_trend.overall_change_rate > 0 %}+{% endif %}{{ latest_trend.overall_change_rate|default:"0" }}%
                    </div>
                    <div class="text-xs text-gray-600">전기 대비 변화</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-semibold text-gray-900">{{ latest_trend.get_overall_trend_display|default:"안정" }}</div>
                    <div class="text-xs text-gray-600">전반적 추세</div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- AI 인사이트 및 추천사항 -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- AI 인사이트 -->
        <div class="bg-white rounded-2xl shadow-sm p-6">
            <div class="flex items-center mb-6">
                <i data-lucide="lightbulb" class="w-6 h-6 text-primary mr-3"></i>
                <h3 class="text-lg font-semibold text-gray-900">AI 성과 분석</h3>
            </div>
            
            {% if latest_trend.insights %}
            <div class="space-y-4">
                <div>
                    <h4 class="font-medium text-gray-700 mb-2">성과 요약</h4>
                    <p class="text-sm text-gray-600">{{ latest_trend.insights.performance_summary|default:"성과 데이터를 분석 중입니다." }}</p>
                </div>
                
                {% if latest_trend.insights.strength_areas %}
                <div>
                    <h4 class="font-medium text-gray-700 mb-2">강점 영역</h4>
                    <div class="flex flex-wrap gap-2">
                        {% for strength in latest_trend.insights.strength_areas %}
                        <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm">{{ strength }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                {% if latest_trend.insights.improvement_areas %}
                <div>
                    <h4 class="font-medium text-gray-700 mb-2">개선 영역</h4>
                    <div class="flex flex-wrap gap-2">
                        {% for area in latest_trend.insights.improvement_areas %}
                        <span class="px-3 py-1 bg-orange-100 text-orange-800 rounded-full text-sm">{{ area }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                <div>
                    <h4 class="font-medium text-gray-700 mb-2">승급 준비도</h4>
                    <p class="text-sm text-gray-600">{{ latest_trend.insights.promotion_readiness|default:"승급 준비도를 분석 중입니다." }}</p>
                </div>
            </div>
            {% else %}
            <div class="text-center py-8">
                <i data-lucide="brain" class="w-12 h-12 text-gray-300 mx-auto mb-3"></i>
                <p class="text-gray-500">AI 분석 결과가 준비 중입니다.</p>
            </div>
            {% endif %}
        </div>
        
        <!-- 개선 추천사항 -->
        <div class="bg-white rounded-2xl shadow-sm p-6">
            <div class="flex items-center mb-6">
                <i data-lucide="target" class="w-6 h-6 text-primary mr-3"></i>
                <h3 class="text-lg font-semibold text-gray-900">개선 추천사항</h3>
            </div>
            
            {% if latest_trend.recommendations %}
            <div class="space-y-3">
                {% for recommendation in latest_trend.recommendations %}
                <div class="recommendation-card priority-{{ recommendation.priority }}">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <h4 class="font-medium text-gray-800 mb-1">{{ recommendation.area }}</h4>
                            <p class="text-sm text-gray-700">{{ recommendation.recommendation }}</p>
                        </div>
                        <span class="px-2 py-1 rounded-full text-xs font-medium ml-3
                                {% if recommendation.priority == 'urgent' %}bg-red-100 text-red-800
                                {% elif recommendation.priority == 'high' %}bg-orange-100 text-orange-800
                                {% elif recommendation.priority == 'medium' %}bg-yellow-100 text-yellow-800
                                {% else %}bg-blue-100 text-blue-800{% endif %}">
                            {{ recommendation.priority|upper }}
                        </span>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-8">
                <i data-lucide="check-circle" class="w-12 h-12 text-gray-300 mx-auto mb-3"></i>
                <p class="text-gray-500">현재 개선이 필요한 영역이 없습니다.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- 성장 히스토리 -->
    <div class="bg-white rounded-2xl shadow-sm p-6">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-lg font-semibold text-gray-900">최근 성장 히스토리</h3>
            <a href="{% url 'evaluations:growth_history' %}" class="text-sm text-primary hover:text-primary-hover">
                전체 이력 보기 <i data-lucide="arrow-right" class="w-4 h-4 inline ml-1"></i>
            </a>
        </div>
        
        {% if growth_history %}
        <div class="growth-timeline">
            {% for history in growth_history|slice:":5" %}
            <div class="timeline-item">
                <div class="timeline-dot"></div>
                <div class="bg-gray-50 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-medium text-gray-900">{{ history.evaluation_period }}</h4>
                        <span class="text-sm text-gray-600">{{ history.evaluation_period.end_date|date:"Y.m" }}</span>
                    </div>
                    <div class="grid grid-cols-3 gap-4 text-sm">
                        <div>
                            <span class="text-gray-600">기여도:</span>
                            <span class="font-medium">{{ history.contribution_score|default:"-" }}</span>
                        </div>
                        <div>
                            <span class="text-gray-600">전문성:</span>
                            <span class="font-medium">{{ history.expertise_score|default:"-" }}</span>
                        </div>
                        <div>
                            <span class="text-gray-600">영향력:</span>
                            <span class="font-medium">{{ history.impact_score|default:"-" }}</span>
                        </div>
                    </div>
                    {% if history.change_type != 'MAINTAIN' %}
                    <div class="mt-2">
                        <span class="px-2 py-1 rounded-full text-xs font-medium
                                {% if history.change_type == 'PROMOTION' %}bg-green-100 text-green-800
                                {% elif history.change_type == 'DEMOTION' %}bg-red-100 text-red-800
                                {% else %}bg-blue-100 text-blue-800{% endif %}">
                            {% if history.change_type == 'PROMOTION' %}승급
                            {% elif history.change_type == 'DEMOTION' %}강등
                            {% else %}{{ history.get_change_type_display }}{% endif %}
                        </span>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-8">
            <i data-lucide="history" class="w-12 h-12 text-gray-300 mx-auto mb-3"></i>
            <p class="text-gray-500">성장 히스토리가 없습니다.</p>
        </div>
        {% endif %}
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// 성과 트렌드 차트
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('performanceTrendChart');
    if (ctx) {
        const chartData = {{ trend_chart_data|safe }};
        
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartData.labels,
                datasets: [
                    {
                        label: '기여도',
                        data: chartData.contribution,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4
                    },
                    {
                        label: '전문성',
                        data: chartData.expertise,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4
                    },
                    {
                        label: '영향력',
                        data: chartData.impact,
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 5,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            usePointStyle: true,
                            padding: 20
                        }
                    }
                }
            }
        });
    }
    
    lucide.createIcons();
});
</script>
{% endblock %}