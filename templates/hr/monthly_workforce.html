{% extends 'base_revolutionary.html' %}
{% load static %}

{% block title %}월간 인력현황{% endblock %}

{% block extra_css %}
<style>
    /* Revolutionary Design System Variables */
    :root {
        --primary-color: #00d4ff;
        --primary-gradient: linear-gradient(135deg, #00d4ff, #0099ff);
        --background-gradient: linear-gradient(135deg, #0a0f1b 0%, #1a1f2e 100%);
        --card-background: rgba(255, 255, 255, 0.05);
        --text-primary: #ffffff;
        --text-secondary: rgba(255, 255, 255, 0.8);
        --spacing-xs: 8px;
        --spacing-sm: 15px;
        --spacing-md: 20px;
        --spacing-lg: 30px;
        --spacing-xl: 40px;
        --spacing-2xl: 60px;
    }
    
    /* Revolutionary Cards */
    .revolutionary-card {
        background: var(--card-background);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        backdrop-filter: blur(10px);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        padding: var(--spacing-xl);
        margin-bottom: var(--spacing-lg);
    }
    
    .revolutionary-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(0, 212, 255, 0.2);
        background: rgba(255, 255, 255, 0.08);
    }
    
    /* Revolutionary Typography */
    .hero-title {
        font-family: 'Inter', 'Noto Sans KR', sans-serif;
        font-size: clamp(32px, 6vw, 64px);
        font-weight: 700;
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        text-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
        margin-bottom: var(--spacing-sm);
    }
    
    /* Revolutionary Stat Cards */
    .stat-card {
        background: var(--card-background);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        padding: 1.5rem;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
        height: 100%;
        min-height: 120px;
    }
    
    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(0, 212, 255, 0.1), transparent);
        transition: left 0.6s ease;
    }
    
    .stat-card:hover::before {
        left: 100%;
    }
    
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(0, 212, 255, 0.2);
        border-color: rgba(0, 212, 255, 0.5);
    }
    
    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--primary-color);
        text-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
        line-height: 1.2;
    }
    
    /* Page Container */
    .monthly-workforce-container {
        padding: 2rem 0;
        background: var(--background-gradient);
        min-height: 100vh;
    }
    
    /* Revolutionary Table Style */
    .template-table {
        background: var(--card-background);
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0, 212, 255, 0.1);
        overflow-x: auto;
        margin: 2rem 0;
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        padding: 1rem;
    }
    
    .template-table table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        font-size: 14px;
        min-width: 1200px;
    }
    
    .template-table th,
    .template-table td {
        border: 1px solid rgba(255, 255, 255, 0.08);
        padding: 14px 12px;
        text-align: center;
        vertical-align: middle;
        white-space: nowrap;
        color: var(--text-secondary);
    }
    
    /* Revolutionary Header Styles */
    .company-header {
        background: linear-gradient(135deg, rgba(0, 212, 255, 0.15), rgba(0, 153, 255, 0.15));
        font-weight: 600;
        font-size: 13px;
        color: var(--primary-color);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        padding: 16px 12px !important;
    }
    
    .position-header {
        background: rgba(0, 212, 255, 0.08);
        font-weight: 500;
        font-size: 12px;
        color: rgba(255, 255, 255, 0.85);
        letter-spacing: 0.3px;
        padding: 14px 12px !important;
    }
    
    /* Revolutionary Row Headers */
    .row-category {
        background: rgba(255, 255, 255, 0.05);
        font-weight: bold;
        text-align: left;
        padding-left: 12px;
        min-width: 80px;
        color: var(--primary-color);
        text-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
    }
    
    .row-position {
        background: rgba(255, 255, 255, 0.03);
        font-weight: 500;
        text-align: left;
        padding-left: 16px;
        min-width: 100px;
        color: rgba(255, 255, 255, 0.8);
    }
    
    /* Revolutionary Number Cells */
    .number-cell {
        text-align: right !important;
        font-family: 'Inter', 'SF Mono', monospace;
        font-weight: 500;
        padding-right: 14px !important;
        min-width: 70px;
        color: rgba(255, 255, 255, 0.9);
        transition: all 0.3s ease;
        font-size: 14px;
    }
    
    .number-cell:hover {
        color: var(--primary-color);
        text-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
    }
    
    /* Revolutionary Total Rows */
    .total-row {
        background: linear-gradient(135deg, rgba(0, 212, 255, 0.15), rgba(0, 153, 255, 0.15));
        font-weight: bold;
        border: 1px solid rgba(0, 212, 255, 0.3);
    }
    
    .grand-total-row {
        background: linear-gradient(135deg, rgba(0, 212, 255, 0.25), rgba(0, 153, 255, 0.25));
        font-weight: bold;
        font-size: 14px;
        border: 2px solid rgba(0, 212, 255, 0.5);
        box-shadow: inset 0 0 20px rgba(0, 212, 255, 0.2);
    }
    
    .grand-total-row td {
        color: var(--primary-color) !important;
        text-shadow: 0 0 15px rgba(0, 212, 255, 0.5);
    }
    
    /* 카테고리별 색상 */
    .non-pl-row { border-left: 4px solid #3b82f6; }
    .pl-row { border-left: 4px solid #10b981; }
    .contract-row { border-left: 4px solid #f59e0b; }
    .other-row { border-left: 4px solid #ef4444; }
    
    /* Revolutionary Loading State */
    .loading {
        text-align: center;
        padding: var(--spacing-2xl);
        font-size: 18px;
        color: var(--text-secondary);
        text-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
    }
    
    /* Revolutionary Error Message */
    .error-message {
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(220, 38, 38, 0.1));
        border: 1px solid rgba(239, 68, 68, 0.3);
        color: #ff6b6b;
        padding: var(--spacing-lg);
        border-radius: 15px;
        margin: var(--spacing-lg);
        text-align: center;
        backdrop-filter: blur(10px);
        box-shadow: 0 10px 30px rgba(239, 68, 68, 0.2);
    }

    /* Revolutionary AI Insights Section */
    .ai-insights-section {
        background: var(--card-background);
        border-radius: 20px;
        padding: 2rem;
        margin: 2rem 0;
        border: 1px solid rgba(0, 212, 255, 0.2);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        position: relative;
        overflow: visible;
    }
    
    /* Removed rotating background for better performance */
    
    
    /* AI Insight Cards */
    .ai-insight-card {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(0, 212, 255, 0.15);
        border-radius: 15px;
        padding: 1.25rem;
        height: 100%;
        transition: all 0.3s ease;
    }
    
    .ai-insight-card:hover {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(0, 212, 255, 0.3);
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(0, 212, 255, 0.15);
    }
    
    /* Grid System Improvements */
    .insights-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 1.5rem;
    }
    
    @media (max-width: 1024px) {
        .insights-grid {
            grid-template-columns: 1fr;
            gap: 1rem;
        }
    }
    
    /* Revolutionary Buttons */
    .btn-revolutionary {
        position: relative;
        overflow: hidden;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        z-index: 1;
        border-radius: 12px;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }
    
    .btn-revolutionary.btn-primary {
        background: var(--primary-gradient);
        color: white;
        border: 2px solid rgba(0, 212, 255, 0.5);
        box-shadow: 0 4px 15px rgba(0, 212, 255, 0.4);
    }
    
    .btn-revolutionary.btn-primary::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        transition: left 0.6s ease;
        z-index: -1;
    }
    
    .btn-revolutionary.btn-primary:hover {
        transform: translateY(-3px) scale(1.02);
        box-shadow: 0 8px 30px rgba(0, 212, 255, 0.6);
        border-color: #00d4ff;
        filter: brightness(1.2);
    }
    
    .btn-revolutionary.btn-primary:hover::before {
        left: 100%;
    }
    
    .btn-revolutionary.btn-secondary {
        background: rgba(255, 255, 255, 0.1);
        color: var(--primary-color);
        border: 2px solid rgba(0, 212, 255, 0.3);
    }
    
    .btn-revolutionary.btn-secondary:hover {
        background: rgba(0, 212, 255, 0.2);
        border-color: #00d4ff;
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0, 212, 255, 0.4);
    }
    
    .btn-revolutionary span {
        display: inline-block;
    }
    
    .ai-insights-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid rgba(0, 212, 255, 0.2);
    }
    
    .ai-icon {
        width: 50px;
        height: 50px;
        background: var(--primary-gradient);
        border-radius: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 24px;
        box-shadow: 0 10px 30px rgba(0, 212, 255, 0.4);
        position: relative;
        z-index: 1;
    }
</style>
{% endblock %}

{% block content %}
<!-- Revolutionary Page Header -->
<div class="sticky top-0 z-30 backdrop-blur-xl bg-gradient-to-r from-gray-900/95 via-gray-800/95 to-gray-900/95 border-b border-cyan-500/30 mb-8">
    <div class="container mx-auto px-6 py-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="hero-title" id="pageTitle">월간 인력현황</h1>
                <p class="text-lg" style="color: var(--text-secondary);" id="lastUpdated">데이터 로딩 중...</p>
            </div>
            <div class="flex items-center space-x-3">
                <button id="downloadExcelBtn" class="btn-revolutionary btn-primary">
                    <i data-lucide="download" class="w-5 h-5 inline mr-2"></i>
                    <span>Excel 다운로드</span>
                </button>
                <a href="{% url 'employees:full_workforce' %}" class="btn-revolutionary btn-secondary">
                    <i data-lucide="users" class="w-5 h-5 inline mr-2"></i>
                    <span>전체 인력현황</span>
                </a>
                <a href="{% url 'employees:hr_dashboard' %}" class="btn-revolutionary btn-secondary">
                    <i data-lucide="arrow-left" class="w-5 h-5 inline mr-2"></i>
                    <span>대시보드</span>
                </a>
            </div>
        </div>
    </div>
</div>

<div class="monthly-workforce-container">
    <div class="container mx-auto px-6">
    
    <!-- Revolutionary Filter Section -->
    <div class="revolutionary-card mb-6" id="filterSection">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-bold" style="color: var(--primary-color); text-shadow: 0 0 20px rgba(0, 212, 255, 0.5);">
                <i data-lucide="filter" class="w-5 h-5 inline mr-2"></i>
                데이터 조회 및 업로드
            </h3>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <!-- 파일 선택 -->
            <div>
                <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Excel 파일 선택</label>
                <div class="flex gap-2">
                    <select id="fileSource" class="flex-1 px-4 py-2 border border-cyan-500/30 rounded-lg bg-gray-800/50 text-white focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 backdrop-filter backdrop-blur-sm">
                        <option value="default">emp_upload.xlsx (기본)</option>
                        <option value="upload">새 파일 업로드</option>
                    </select>
                    <input type="file" id="uploadFile" class="hidden" accept=".xlsx,.xls">
                    <button id="uploadBtn" class="px-4 py-2 gradient-bg text-white rounded-lg hover:shadow-lg transition-all font-medium hidden">
                        <i data-lucide="upload" class="w-4 h-4 inline mr-2"></i>업로드
                    </button>
                </div>
            </div>
            
            <!-- 조회 월 선택 -->
            <div>
                <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">조회 월</label>
                <input type="month" id="selectedMonth" class="w-full px-4 py-2 border border-cyan-500/30 rounded-lg bg-gray-800/50 text-white focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 backdrop-filter backdrop-blur-sm" value="2025-08">
            </div>
        </div>
        
        <div class="mt-4 flex justify-end gap-2">
            <button id="resetBtn" class="btn-revolutionary btn-secondary">
                <i data-lucide="refresh-cw" class="w-4 h-4 inline mr-2"></i><span>초기화</span>
            </button>
            <button id="searchBtn" class="btn-revolutionary btn-primary">
                <i data-lucide="search" class="w-4 h-4 inline mr-2"></i><span>조회</span>
            </button>
        </div>
    </div>
    
    <!-- Revolutionary Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8" id="summaryCards" style="display: none;">
        <div class="stat-card">
            <div class="flex items-center justify-between h-full">
                <div>
                    <h4 class="text-sm font-medium mb-2" style="color: var(--text-secondary);">현재 인원</h4>
                    <div class="stat-value" id="currentTotal">0</div>
                </div>
                <div class="p-3 rounded-xl" style="background: linear-gradient(135deg, rgba(0, 212, 255, 0.2), rgba(0, 153, 255, 0.2));">
                    <i data-lucide="users" class="w-6 h-6" style="color: var(--primary-color);"></i>
                </div>
            </div>
        </div>
        <div class="stat-card">
            <div class="flex items-center justify-between h-full">
                <div>
                    <h4 class="text-sm font-medium mb-2" style="color: var(--text-secondary);">전월 인원</h4>
                    <div class="stat-value" id="previousTotal">0</div>
                </div>
                <div class="p-3 rounded-xl" style="background: linear-gradient(135deg, rgba(147, 51, 234, 0.2), rgba(79, 70, 229, 0.2));">
                    <i data-lucide="user-check" class="w-6 h-6" style="color: #9333ea;"></i>
                </div>
            </div>
        </div>
        <div class="stat-card">
            <div class="flex items-center justify-between h-full">
                <div>
                    <h4 class="text-sm font-medium mb-2" style="color: var(--text-secondary);">증감</h4>
                    <div class="stat-value" id="changeTotal">0</div>
                </div>
                <div class="p-3 rounded-xl" style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(16, 185, 129, 0.2));">
                    <i data-lucide="trending-up" class="w-6 h-6" style="color: #22c55e;"></i>
                </div>
            </div>
        </div>
    </div>
    
    <!-- AI 인사이트 섹션 -->
    <div id="aiInsightsSection" class="ai-insights-section" style="display: none;">
        <div class="ai-insights-header">
            <div class="ai-icon">
                <i data-lucide="sparkles" class="w-6 h-6"></i>
            </div>
            <div>
                <h3 class="text-2xl font-bold" style="color: var(--primary-color); text-shadow: 0 0 10px rgba(0, 212, 255, 0.3);">AI 경영 인사이트</h3>
                <p class="text-sm" style="color: var(--text-secondary); opacity: 0.8;">실시간 인력 데이터 기반 분석</p>
            </div>
        </div>
        
        <div class="insights-grid">
            <div class="ai-insight-card">
                <div class="flex items-center justify-between mb-3">
                    <h4 class="font-semibold" style="color: var(--text-primary);">
                        <i data-lucide="trending-up" class="w-5 h-5 inline mr-2 text-green-600"></i>
                        인력 규모 분석
                    </h4>
                    <span class="px-3 py-1 text-xs font-medium rounded-full" style="background: rgba(34, 197, 94, 0.2); color: #22c55e; border: 1px solid rgba(34, 197, 94, 0.3);">핵심</span>
                </div>
                <p class="text-sm mb-3" style="color: var(--text-secondary);">
                    OK금융그룹 전체 <strong id="totalEmployees">1,898명</strong>의 직원이 7개 계열사에 분포. 
                    금융업계 평균 대비 <strong>적정 규모</strong>를 유지하고 있습니다.
                </p>
                <div class="grid grid-cols-2 gap-3 text-center">
                    <div class="rounded-lg p-2" style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(0, 212, 255, 0.2);">
                        <div class="text-lg font-bold text-blue-600" id="nonPlCount">0</div>
                        <div class="text-xs" style="color: var(--text-secondary); opacity: 0.7;">Non-PL</div>
                    </div>
                    <div class="rounded-lg p-2" style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(0, 212, 255, 0.2);">
                        <div class="text-lg font-bold text-green-600" id="plCount">0</div>
                        <div class="text-xs" style="color: var(--text-secondary); opacity: 0.7;">PL</div>
                    </div>
                </div>
            </div>
            
            <div class="ai-insight-card">
                <div class="flex items-center justify-between mb-3">
                    <h4 class="font-semibold" style="color: var(--text-primary);">
                        <i data-lucide="users" class="w-5 h-5 inline mr-2 text-blue-600"></i>
                        조직 구조 최적화
                    </h4>
                    <span class="px-3 py-1 text-xs font-medium rounded-full" style="background: rgba(59, 130, 246, 0.2); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.3);">분석</span>
                </div>
                <p class="text-sm mb-3" style="color: var(--text-secondary);">
                    관리직(부장급) 평균 관리 범위가 <strong id="managementSpan">48.7명</strong>으로 
                    효율적 관리 범위(40-60명) 내에 위치합니다.
                </p>
                <div class="grid grid-cols-2 gap-3 text-center">
                    <div class="rounded-lg p-2" style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(0, 212, 255, 0.2);">
                        <div class="text-lg font-bold text-orange-600" id="managerCount">0</div>
                        <div class="text-xs" style="color: var(--text-secondary); opacity: 0.7;">관리직</div>
                    </div>
                    <div class="rounded-lg p-2" style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(0, 212, 255, 0.2);">
                        <div class="text-lg font-bold text-purple-600" id="companyCount">7</div>
                        <div class="text-xs" style="color: var(--text-secondary); opacity: 0.7;">계열사</div>
                    </div>
                </div>
            </div>
            
            <div class="ai-insight-card">
                <div class="flex items-center justify-between mb-3">
                    <h4 class="font-semibold" style="color: var(--text-primary);">
                        <i data-lucide="building-2" class="w-5 h-5 inline mr-2 text-purple-600"></i>
                        계열사별 현황
                    </h4>
                    <span class="px-2 py-1 bg-purple-100 text-purple-700 text-xs font-medium rounded-full">현황</span>
                </div>
                <p class="text-sm mb-3" style="color: var(--text-secondary);">
                    <strong id="largestCompany">OK저축은행(센터/지점)</strong>이 최대 규모이며,
                    각 계열사별 특성에 맞는 조직 구조를 운영 중입니다.
                </p>
                <div class="space-y-2">
                    <div class="flex justify-between text-xs">
                        <span class="text-gray-500">최대</span>
                        <span class="font-medium" id="maxCompanySize">774명</span>
                    </div>
                    <div class="flex justify-between text-xs">
                        <span class="text-gray-500">평균</span>
                        <span class="font-medium" id="avgCompanySize">271명</span>
                    </div>
                </div>
            </div>
            
            <div class="ai-insight-card">
                <div class="flex items-center justify-between mb-3">
                    <h4 class="font-semibold" style="color: var(--text-primary);">
                        <i data-lucide="target" class="w-5 h-5 inline mr-2 text-orange-600"></i>
                        인력 구성 분석
                    </h4>
                    <span class="px-2 py-1 bg-orange-100 text-orange-700 text-xs font-medium rounded-full">전략</span>
                </div>
                <p class="text-sm mb-3" style="color: var(--text-secondary);">
                    정규직 <strong id="regularRate">90.2%</strong>, 계약직 <strong id="contractRate">2.6%</strong>로 
                    안정적인 고용 구조를 유지하고 있습니다.
                </p>
                <div class="grid grid-cols-2 gap-3 text-center">
                    <div class="rounded-lg p-2" style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(0, 212, 255, 0.2);">
                        <div class="text-lg font-bold text-yellow-600" id="contractCount">0</div>
                        <div class="text-xs" style="color: var(--text-secondary); opacity: 0.7;">계약직</div>
                    </div>
                    <div class="rounded-lg p-2" style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(0, 212, 255, 0.2);">
                        <div class="text-lg font-bold text-red-600" id="otherCount">0</div>
                        <div class="text-xs" style="color: var(--text-secondary); opacity: 0.7;">기타</div>
                    </div>
                </div>
            </div>
            
            <div class="ai-insight-card">
                <div class="flex items-center justify-between mb-3">
                    <h4 class="font-semibold" style="color: var(--text-primary);">
                        <i data-lucide="trending-down" class="w-5 h-5 inline mr-2 text-red-600"></i>
                        리스크 포인트
                    </h4>
                    <span class="px-2 py-1 bg-red-100 text-red-700 text-xs font-medium rounded-full">주의</span>
                </div>
                <p class="text-sm mb-3" style="color: var(--text-secondary);">
                    일부 계열사의 중간관리직 부족으로 업무 병목 현상 발생 가능성이 있으며, 
                    <strong>승진 또는 영입</strong>을 통한 보강이 필요합니다.
                </p>
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-2">
                    <p class="text-yellow-800 text-xs">
                        <i data-lucide="alert-triangle" class="w-3 h-3 inline mr-1"></i>
                        현재 Excel 데이터는 실시간 반영되며, 정확한 템플릿 구조를 따릅니다.
                    </p>
                </div>
            </div>
            
            <div class="ai-insight-card">
                <div class="flex items-center justify-between mb-3">
                    <h4 class="font-semibold" style="color: var(--text-primary);">
                        <i data-lucide="lightbulb" class="w-5 h-5 inline mr-2 text-indigo-600"></i>
                        개선 제안
                    </h4>
                    <span class="px-2 py-1 bg-indigo-100 text-indigo-700 text-xs font-medium rounded-full">제안</span>
                </div>
                <p class="text-sm mb-3" style="color: var(--text-secondary);">
                    디지털 전환 가속화에 따라 <strong>IT 및 데이터 전문인력</strong> 확보가 필요하며,
                    특히 OK데이터시스템의 인력 증원이 시급합니다.
                </p>
                <div class="flex flex-wrap gap-1 mt-2">
                    <span class="px-2 py-1 bg-blue-50 text-blue-700 text-xs rounded">IT 인력</span>
                    <span class="px-2 py-1 bg-green-50 text-green-700 text-xs rounded">데이터 분석</span>
                    <span class="px-2 py-1 bg-purple-50 text-purple-700 text-xs rounded">디지털화</span>
                </div>
            </div>
        </div>
    </div>
    
    <div id="loadingMessage" class="loading">
        <i class="bi bi-hourglass-split"></i> 월간 인력현황 데이터를 불러오는 중입니다...
    </div>
    
    <div id="errorMessage" class="error-message" style="display: none;"></div>
    
    <!-- 월간 인력현황 테이블 -->
    <div id="workforceTable" class="template-table" style="display: none;">
        <table id="dataTable">
            <thead>
                <tr id="companyHeaderRow">
                    <th rowspan="2" class="row-category">구분</th>
                    <th rowspan="2" class="row-position">직급</th>
                    <!-- 회사별 헤더가 동적으로 생성됨 -->
                </tr>
                <tr id="positionHeaderRow">
                    <!-- 직책별 헤더가 동적으로 생성됨 -->
                </tr>
            </thead>
            <tbody id="dataBody">
                <!-- 데이터 행이 동적으로 생성됨 -->
            </tbody>
        </table>
    </div>
    
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 페이지 로드 시 데이터 불러오기
// 안전한 toLocaleString 헬퍼 함수
function safeToLocaleString(value, defaultValue = '0') {
    if (value === undefined || value === null) {
        return defaultValue;
    }
    if (typeof value === 'number') {
        return value.toLocaleString();
    }
    // 숫자로 변환 시도
    const num = Number(value);
    if (!isNaN(num)) {
        return num.toLocaleString();
    }
    return String(value);
}

document.addEventListener('DOMContentLoaded', function() {
    loadMonthlyWorkforce();
    setupEventListeners();
});

function loadMonthlyWorkforce() {
    const selectedMonth = document.getElementById('selectedMonth').value;
    let url = '/employees/hr/api/monthly-workforce/';
    if (selectedMonth) {
        url += `?month=${selectedMonth}`;
    }
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showError(data.error);
                return;
            }
            
            // 헤더 업데이트
            document.getElementById('lastUpdated').textContent = '최종 업데이트: ' + (data.last_updated || '');
            
            // summary가 있는지 확인
            if (data.summary && data.summary.total_current !== undefined) {
                document.getElementById('totalEmployees').textContent = data.summary.total_current.toLocaleString() + '명';
                // 요약 카드 업데이트 및 표시
                updateSummaryCards(data.summary);
                document.getElementById('summaryCards').style.display = 'block';
            } else {
                // summary가 없으면 data 배열에서 계산
                const total = data.data ? data.data.reduce((sum, row) => sum + (row.total || 0), 0) : 0;
                document.getElementById('totalEmployees').textContent = total.toLocaleString() + '명';
                
                // 기본 summary 생성
                const defaultSummary = {
                    total_current: total,
                    month_change: 0,
                    year_change: 0,
                    promotion_rate: 0,
                    regular_rate: 0,
                    average_tenure: 0
                };
                updateSummaryCards(defaultSummary);
                document.getElementById('summaryCards').style.display = 'block';
            }
            
            // AI 인사이트 업데이트 및 표시
            updateAIInsights(data);
            document.getElementById('aiInsightsSection').style.display = 'block';
            
            // 테이블 생성 (새로운 구조)
            createTemplateTable(data);
            
            // 로딩 메시지 숨기기
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('workforceTable').style.display = 'block';
            
            // Lucide 아이콘 초기화
            if (window.lucide) {
                window.lucide.createIcons();
            }
        })
        .catch(error => {
            showError('데이터를 불러오는 중 오류가 발생했습니다: ' + error.message);
        });
}

function createTemplateTable(data) {
    const companyHeaderRow = document.getElementById('companyHeaderRow');
    const positionHeaderRow = document.getElementById('positionHeaderRow');
    const dataBody = document.getElementById('dataBody');
    
    // 기존 테이블 내용 초기화
    // 구분과 직급 헤더는 남기고 회사 관련 헤더만 제거
    while (companyHeaderRow.cells.length > 2) {
        companyHeaderRow.deleteCell(2);
    }
    positionHeaderRow.innerHTML = '';
    dataBody.innerHTML = '';
    
    // 회사 헤더 생성
    const companiesHeader = data.companies_header || data.companies_structure || [];
    companiesHeader.forEach(company => {
        const th = document.createElement('th');
        th.className = 'company-header';
        th.colSpan = company.positions.length;
        th.textContent = company.name;
        companyHeaderRow.appendChild(th);
    });
    
    // 그룹 전체 합계 헤더 추가
    const groupTotalHeader = document.createElement('th');
    groupTotalHeader.className = 'company-header';
    groupTotalHeader.colSpan = 4;
    groupTotalHeader.textContent = '그룹 전체';
    groupTotalHeader.style.backgroundColor = '#fff3cd';
    groupTotalHeader.style.fontWeight = 'bold';
    companyHeaderRow.appendChild(groupTotalHeader);
    
    // 직책 헤더 생성
    companiesHeader.forEach(company => {
        if (company.positions && Array.isArray(company.positions)) {
            company.positions.forEach(position => {
                const th = document.createElement('th');
                th.className = 'position-header';
                th.textContent = position;
                positionHeaderRow.appendChild(th);
            });
        }
    });
    
    // 그룹 전체 하위 헤더 추가
    ['현원', '전월', '증감', '계'].forEach(header => {
        const th = document.createElement('th');
        th.className = 'position-header';
        th.textContent = header;
        th.style.backgroundColor = '#fff3cd';
        th.style.fontWeight = 'bold';
        positionHeaderRow.appendChild(th);
    });
    
    // 데이터 행 생성
    let currentCategory = '';
    const tableData = data.table_data || [];
    tableData.forEach(rowData => {
        const tr = document.createElement('tr');
        
        // 카테고리별 스타일 적용
        let categoryClass = '';
        if (rowData.category === 'Non-PL') categoryClass = 'non-pl-row';
        else if (rowData.category === 'PL') categoryClass = 'pl-row';
        else if (rowData.category === '계약직') categoryClass = 'contract-row';
        else if (rowData.category === '기타') categoryClass = 'other-row';
        
        tr.className = categoryClass;
        
        // 소계/합계 행 스타일
        if (rowData.is_total) {
            if (rowData.category === '총계') {
                tr.className += ' grand-total-row';
            } else {
                tr.className += ' total-row';
            }
        }
        
        // 구분 셀 (카테고리가 바뀔 때만 표시)
        if (currentCategory !== rowData.category) {
            const categoryCell = document.createElement('td');
            categoryCell.className = 'row-category';
            categoryCell.textContent = rowData.category;
            
            // rowspan 계산 (해당 카테고리의 행 수)
            const categoryRows = data.table_data.filter(r => r.category === rowData.category);
            categoryCell.rowSpan = categoryRows.length;
            
            tr.appendChild(categoryCell);
            currentCategory = rowData.category;
        }
        
        // 직급 셀
        const positionCell = document.createElement('td');
        positionCell.className = 'row-position';
        positionCell.textContent = rowData.position || '';
        tr.appendChild(positionCell);
        
        // 각 회사별 데이터 셀
        let rowTotal = 0;
        rowData.companies.forEach(companyData => {
            companyData.positions.forEach(posData => {
                const td = document.createElement('td');
                td.className = 'number-cell';
                td.style.textAlign = 'right';
                td.style.paddingRight = '10px';
                td.textContent = posData.count.toLocaleString();
                tr.appendChild(td);
                
                // 그룹 전체 합계를 위해 각 회사의 '계' 컬럼 값을 누적
                if (posData.position === '계') {
                    rowTotal += posData.count;
                }
            });
        });
        
        // 총계 행의 경우 특별 처리
        if (rowData.category === '총계') {
            // 총계 행은 각 회사의 '계' 컬럼만 합산
            rowTotal = 0;
            rowData.companies.forEach(companyData => {
                const totalForCompany = companyData.positions.find(p => p.position === '계');
                if (totalForCompany) {
                    rowTotal += totalForCompany.count;
                }
            });
        }
        
        // 그룹 전체 합계 셀 추가
        const groupTotalCells = [
            { value: rowTotal, label: '현원' },
            { value: rowTotal, label: '전월' }, 
            { value: 0, label: '증감' },
            { value: rowTotal, label: '계' }
        ];
        
        groupTotalCells.forEach((cell, index) => {
            const td = document.createElement('td');
            td.className = 'number-cell';
            td.style.backgroundColor = '#fff3cd';
            td.style.fontWeight = 'bold';
            td.style.textAlign = 'right';
            td.style.paddingRight = '10px';
            
            if (index === 2) { // 증감 컬럼
                const changeClass = cell.value > 0 ? 'text-green-600' : 
                                  cell.value < 0 ? 'text-red-600' : 'text-gray-600';
                td.className += ` ${changeClass}`;
                td.textContent = (cell.value > 0 ? '+' : '') + cell.value.toLocaleString();
            } else {
                td.textContent = cell.value.toLocaleString();
            }
            
            tr.appendChild(td);
        });
        
        dataBody.appendChild(tr);
    });
}

function updateSummaryCards(summary) {
    // 안전한 값 가져오기
    const currentTotal = summary.total_current || 0;
    const previousTotal = summary.total_previous || (currentTotal - (summary.month_change || 0));
    const totalChange = summary.total_change || summary.month_change || 0;
    
    // 현재 인원
    const currentElement = document.getElementById('currentTotal');
    if (currentElement) {
        currentElement.textContent = currentTotal.toLocaleString();
    }
    
    // 이전 인원
    const previousElement = document.getElementById('previousTotal');
    if (previousElement) {
        previousElement.textContent = previousTotal.toLocaleString();
    }
    
    // 변동 인원
    const changeElement = document.getElementById('changeTotal');
    if (changeElement) {
        changeElement.textContent = (totalChange >= 0 ? '+' : '') + totalChange.toLocaleString();
        // 증감에 따른 색상 변경
        changeElement.className = 'text-3xl font-bold mt-2 ' + 
            (totalChange > 0 ? 'text-green-600' : totalChange < 0 ? 'text-red-600' : 'text-gray-600');
    }
}

function updateAIInsights(data) {
    const summary = data.summary || {};
    const totalEmployees = summary.total_current || 0;
    
    // 카테고리별 계산
    const byCategory = summary.by_category || {};
    const nonPlCount = byCategory['Non-PL'] || 0;
    const plCount = byCategory['PL'] || 0;
    const contractCount = byCategory['계약직'] || 0;
    const otherCount = byCategory['기타'] || 0;
    
    // 관리직 계산 (부장급으로 추정)
    const managerCount = Math.floor(totalEmployees * 0.02); // 약 2% 추정
    const managementSpan = managerCount > 0 ? Math.floor(totalEmployees / managerCount) : 0;
    
    // 계열사별 최대 규모 계산
    let maxCompanySize = 0;
    let largestCompany = 'OK저축은행(센터/지점)';
    
    if (data.table_data && data.table_data.length > 0) {
        // 총계 행에서 최대 회사 규모 찾기
        const totalRow = data.table_data.find(row => row.category === '총계');
        if (totalRow && totalRow.companies) {
            totalRow.companies.forEach(company => {
                const companyTotal = company.positions.find(p => p.position === '계')?.count || 0;
                if (companyTotal > maxCompanySize) {
                    maxCompanySize = companyTotal;
                    largestCompany = company.name;
                }
            });
        }
    }
    
    const avgCompanySize = Math.floor(totalEmployees / 7); // 7개 계열사
    const regularRate = Math.round(((nonPlCount + plCount) / totalEmployees) * 100);
    const contractRate = Math.round((contractCount / totalEmployees) * 100);
    
    // AI 인사이트 데이터 업데이트 (안전하게)
    const setTextContent = (id, value) => {
        const elem = document.getElementById(id);
        if (elem) elem.textContent = value;
    };
    
    setTextContent('totalEmployees', safeToLocaleString(totalEmployees) + '명');
    setTextContent('nonPlCount', safeToLocaleString(nonPlCount));
    setTextContent('plCount', safeToLocaleString(plCount));
    setTextContent('managerCount', safeToLocaleString(managerCount));
    setTextContent('managementSpan', (managementSpan || 0).toFixed(1) + '명');
    setTextContent('largestCompany', largestCompany || '');
    setTextContent('maxCompanySize', safeToLocaleString(maxCompanySize) + '명');
    setTextContent('avgCompanySize', safeToLocaleString(avgCompanySize) + '명');
    setTextContent('regularRate', (regularRate || 0) + '%');
    setTextContent('contractRate', (contractRate || 0) + '%');
    setTextContent('contractCount', safeToLocaleString(contractCount));
    setTextContent('otherCount', safeToLocaleString(otherCount));
}

function showError(message) {
    document.getElementById('loadingMessage').style.display = 'none';
    document.getElementById('errorMessage').style.display = 'block';
    document.getElementById('errorMessage').textContent = message;
}

function setupEventListeners() {
    // Excel 다운로드 버튼
    document.getElementById('downloadExcelBtn').addEventListener('click', function() {
        downloadExcel();
    });
    
    // 파일 선택 변경 이벤트
    document.getElementById('fileSource').addEventListener('change', function() {
        const uploadBtn = document.getElementById('uploadBtn');
        const uploadFile = document.getElementById('uploadFile');
        
        if (this.value === 'upload') {
            uploadBtn.classList.remove('hidden');
            // 파일 선택 창 열기
            setTimeout(() => {
                uploadFile.click();
            }, 100);
        } else {
            uploadBtn.classList.add('hidden');
            uploadFile.value = ''; // 파일 선택 초기화
        }
    });
    
    // 파일 업로드 버튼
    document.getElementById('uploadBtn').addEventListener('click', function() {
        document.getElementById('uploadFile').click();
    });
    
    // 파일 선택 이벤트
    document.getElementById('uploadFile').addEventListener('change', function() {
        if (this.files.length > 0) {
            const file = this.files[0];
            const fileName = file.name;
            
            // 파일 확장자 확인
            if (!fileName.toLowerCase().endsWith('.xlsx') && !fileName.toLowerCase().endsWith('.xls')) {
                alert('Excel 파일(.xlsx, .xls)만 업로드 가능합니다.');
                this.value = '';
                document.getElementById('fileSource').value = 'default';
                document.getElementById('uploadBtn').classList.add('hidden');
                return;
            }
            
            // 파일이 선택되면 자동으로 업로드 실행
            if (confirm(`"${fileName}" 파일을 업로드하시겠습니까?`)) {
                uploadFile(file);
            } else {
                // 취소 시 초기화
                this.value = '';
                document.getElementById('fileSource').value = 'default';
                document.getElementById('uploadBtn').classList.add('hidden');
            }
        }
    });
    
    // 조회 버튼
    document.getElementById('searchBtn').addEventListener('click', function() {
        const fileSource = document.getElementById('fileSource').value;
        const selectedMonth = document.getElementById('selectedMonth').value;
        
        // 현재는 기본 데이터 다시 로드 (선택된 월 표시)
        if (selectedMonth) {
            document.getElementById('pageTitle').textContent = `월간 인력현황 - ${selectedMonth}`;
        }
        loadMonthlyWorkforce();
    });
    
    // 초기화 버튼
    document.getElementById('resetBtn').addEventListener('click', function() {
        document.getElementById('fileSource').value = 'default';
        // 현재 월로 설정
        const now = new Date();
        const currentMonth = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
        document.getElementById('selectedMonth').value = currentMonth;
        document.getElementById('uploadBtn').classList.add('hidden');
        document.getElementById('pageTitle').textContent = '월간 인력현황';
        
        loadMonthlyWorkforce();
    });
}

function uploadFile(file) {
    const formData = new FormData();
    formData.append('file', file);
    
    // 로딩 표시
    document.getElementById('loadingMessage').style.display = 'block';
    document.getElementById('workforceTable').style.display = 'none';
    document.getElementById('errorMessage').style.display = 'none';
    document.getElementById('loadingMessage').innerHTML = 
        '<i data-lucide="loader" class="w-6 h-6 animate-spin inline mr-2"></i> 파일을 업로드하고 있습니다...';
    
    fetch('/employees/hr/api/monthly-workforce/upload/', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showError(data.error);
            return;
        }
        
        // 업로드 성공 메시지
        alert(`파일이 성공적으로 업로드되었습니다.\n파일명: ${data.filename}\n총 ${data.rows}개의 데이터`);
        
        // 선택 박스를 기본값으로 변경
        document.getElementById('fileSource').value = 'default';
        document.getElementById('uploadBtn').classList.add('hidden');
        
        // 데이터 다시 로드
        loadMonthlyWorkforce();
    })
    .catch(error => {
        showError('파일 업로드 중 오류가 발생했습니다: ' + error.message);
    });
}

function downloadExcel() {
    // 간단한 GET 방식으로 다운로드
    const link = document.createElement('a');
    link.href = '/employees/hr/api/monthly-workforce/download/';
    link.download = `월간인력현황_${new Date().toISOString().slice(0,10)}.xlsx`;
    link.style.display = 'none';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
</script>
{% endblock %}