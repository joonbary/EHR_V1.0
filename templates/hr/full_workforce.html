{% extends 'base.html' %}
{% load static %}

{% block title %}전체 인력현황{% endblock %}

{% block extra_css %}
<style>
    .full-workforce-container {
        padding: 20px;
        background-color: #f8f9fa;
        min-height: 100vh;
    }
    
    .excel-table {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        overflow-x: auto;
        margin-bottom: 20px;
    }
    
    .excel-table table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
    }
    
    .excel-table th {
        background-color: #f0f0f0;
        border: 1px solid #ddd;
        padding: 8px;
        text-align: center;
        font-weight: bold;
        white-space: nowrap;
    }
    
    .excel-table td {
        border: 1px solid #ddd;
        padding: 6px;
        text-align: center;
    }
    
    .company-header {
        background-color: #e8f4f8;
        font-weight: bold;
        font-size: 15px;
    }
    
    .position-type {
        background-color: #f5f5f5;
        font-weight: bold;
    }
    
    .total-row {
        background-color: #fffacd;
        font-weight: bold;
    }
    
    .title-section {
        text-align: center;
        margin-bottom: 30px;
    }
    
    .title-section h2 {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 10px;
    }
    
    .summary-cards {
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
        justify-content: center;
    }
    
    .summary-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        text-align: center;
        min-width: 200px;
    }
    
    .summary-card h4 {
        color: #666;
        font-size: 14px;
        margin-bottom: 10px;
    }
    
    .summary-card .value {
        font-size: 32px;
        font-weight: bold;
        color: #333;
    }
    
    .category-summary {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-bottom: 20px;
    }
    
    .category-card {
        background: white;
        border-radius: 8px;
        padding: 15px 25px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        text-align: center;
    }
    
    .category-card h5 {
        color: #666;
        font-size: 13px;
        margin-bottom: 5px;
    }
    
    .category-card .count {
        font-size: 24px;
        font-weight: bold;
        color: #333;
    }
    
    .loading {
        text-align: center;
        padding: 50px;
        font-size: 18px;
        color: #666;
    }
    
    .error-message {
        background-color: #fee;
        border: 1px solid #fcc;
        color: #c33;
        padding: 15px;
        border-radius: 5px;
        margin: 20px;
        text-align: center;
    }
    
    .info-note {
        background-color: #e3f2fd;
        border: 1px solid #1976d2;
        color: #0d47a1;
        padding: 15px;
        border-radius: 5px;
        margin: 20px;
        text-align: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="full-workforce-container">
    <div class="title-section">
        <h2 id="pageTitle">전체 인력현황</h2>
        <p class="text-muted" id="lastUpdated"></p>
        <p><a href="{% url 'employees:monthly_workforce' %}" class="btn btn-secondary">월간 요약 보고서 보기</a></p>
    </div>
    
    <div class="summary-cards" id="summaryCards" style="display: none;">
        <div class="summary-card">
            <h4>전체 인원</h4>
            <div class="value" id="totalCount">0</div>
        </div>
    </div>
    
    <div class="category-summary" id="categorySummary" style="display: none;">
        <div class="category-card">
            <h5>Non-PL</h5>
            <div class="count" id="nonPlCount">0</div>
        </div>
        <div class="category-card">
            <h5>PL</h5>
            <div class="count" id="plCount">0</div>
        </div>
        <div class="category-card">
            <h5>별정직</h5>
            <div class="count" id="specialCount">0</div>
        </div>
        <div class="category-card">
            <h5>기타</h5>
            <div class="count" id="otherCount">0</div>
        </div>
    </div>
    
    <div id="dataNote" class="info-note" style="display: none;">
        <i class="bi bi-info-circle"></i> <span id="noteText"></span>
    </div>
    
    <div id="loadingMessage" class="loading">
        <i class="bi bi-hourglass-split"></i> 데이터를 불러오는 중입니다...
    </div>
    
    <div id="errorMessage" class="error-message" style="display: none;"></div>
    
    <div id="workforceTable" class="excel-table" style="display: none;">
        <table id="dataTable">
            <thead>
                <tr id="headerRow">
                    <!-- 동적으로 생성됨 -->
                </tr>
            </thead>
            <tbody id="dataBody">
                <!-- 동적으로 생성됨 -->
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 페이지 로드 시 데이터 불러오기
document.addEventListener('DOMContentLoaded', function() {
    loadFullWorkforce();
});

function loadFullWorkforce() {
    fetch('/employees/hr/api/full-workforce/')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showError(data.error);
                return;
            }
            
            // 제목 업데이트
            document.getElementById('pageTitle').textContent = data.title || '전체 인력현황';
            document.getElementById('lastUpdated').textContent = '최종 업데이트: ' + data.last_updated;
            
            // 요약 정보 표시
            displaySummary(data.summary);
            
            // 노트 표시
            if (data.summary.note) {
                document.getElementById('noteText').textContent = data.summary.note;
                document.getElementById('dataNote').style.display = 'block';
            }
            
            // 테이블 생성
            createWorkforceTable(data.companies);
            
            // 로딩 메시지 숨기기
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('summaryCards').style.display = 'flex';
            document.getElementById('categorySummary').style.display = 'flex';
            document.getElementById('workforceTable').style.display = 'block';
        })
        .catch(error => {
            showError('데이터를 불러오는 중 오류가 발생했습니다: ' + error.message);
        });
}

function displaySummary(summary) {
    document.getElementById('totalCount').textContent = summary.total_current.toLocaleString();
    
    if (summary.category_summary) {
        document.getElementById('nonPlCount').textContent = summary.category_summary['Non-PL'].toLocaleString();
        document.getElementById('plCount').textContent = summary.category_summary['PL'].toLocaleString();
        document.getElementById('specialCount').textContent = summary.category_summary['별정직'].toLocaleString();
        document.getElementById('otherCount').textContent = summary.category_summary['기타'].toLocaleString();
    }
}

function createWorkforceTable(companies) {
    const headerRow = document.getElementById('headerRow');
    const dataBody = document.getElementById('dataBody');
    
    // 헤더 생성
    headerRow.innerHTML = `
        <th rowspan="2" style="width: 80px;">구분</th>
        <th rowspan="2" style="width: 100px;">직위</th>
    `;
    
    // 회사별 헤더 추가
    companies.forEach(company => {
        headerRow.innerHTML += `
            <th colspan="1" class="company-header">${company.name}</th>
        `;
    });
    
    // 하위 헤더 행 추가
    const subHeaderRow = document.createElement('tr');
    companies.forEach(company => {
        subHeaderRow.innerHTML += `<th>인원</th>`;
    });
    headerRow.parentNode.appendChild(subHeaderRow);
    
    // 데이터 행 생성
    const positionTypes = ['Non-PL', 'PL', '별정직', '기타'];
    const allPositions = new Map();
    
    // 모든 직위 수집
    companies.forEach(company => {
        company.positions.forEach(pos => {
            const key = `${pos.type}_${pos.position}`;
            allPositions.set(key, {type: pos.type, position: pos.position});
        });
    });
    
    // 타입별로 정렬
    const sortedPositions = Array.from(allPositions.values()).sort((a, b) => {
        const typeOrder = {'Non-PL': 0, 'PL': 1, '별정직': 2, '기타': 3};
        if (typeOrder[a.type] !== typeOrder[b.type]) {
            return typeOrder[a.type] - typeOrder[b.type];
        }
        return a.position.localeCompare(b.position);
    });
    
    // 각 카테고리별로 데이터 표시
    let currentType = null;
    let typeRowCount = 0;
    let typeStartRow = null;
    
    sortedPositions.forEach((posInfo, idx) => {
        const row = document.createElement('tr');
        
        // 새로운 타입이 시작될 때
        if (currentType !== posInfo.type) {
            // 이전 타입의 rowspan 업데이트
            if (typeStartRow && typeRowCount > 0) {
                typeStartRow.cells[0].rowSpan = typeRowCount;
            }
            
            currentType = posInfo.type;
            typeRowCount = 0;
            typeStartRow = row;
            
            // 구분 셀 추가
            row.innerHTML = `<td class="position-type">${posInfo.type}</td>`;
        }
        
        typeRowCount++;
        
        // 직위
        row.innerHTML += `<td>${posInfo.position}</td>`;
        
        // 각 회사별 데이터
        companies.forEach(company => {
            const posData = company.positions.find(p => p.type === posInfo.type && p.position === posInfo.position);
            if (posData) {
                row.innerHTML += `<td>${posData.current}</td>`;
            } else {
                row.innerHTML += '<td>0</td>';
            }
        });
        
        dataBody.appendChild(row);
    });
    
    // 마지막 타입의 rowspan 업데이트
    if (typeStartRow && typeRowCount > 0) {
        typeStartRow.cells[0].rowSpan = typeRowCount;
    }
    
    // 전체 합계 행
    const totalRow = document.createElement('tr');
    totalRow.className = 'total-row';
    totalRow.style.backgroundColor = '#ffeb3b';
    totalRow.innerHTML = `<td colspan="2" style="font-size: 16px;">전체 합계</td>`;
    
    companies.forEach(company => {
        const total = company.positions.reduce((acc, pos) => acc + pos.current, 0);
        totalRow.innerHTML += `<td style="font-size: 16px;">${total}</td>`;
    });
    
    dataBody.appendChild(totalRow);
}

function showError(message) {
    document.getElementById('loadingMessage').style.display = 'none';
    document.getElementById('errorMessage').style.display = 'block';
    document.getElementById('errorMessage').textContent = message;
}
</script>
{% endblock %}