{% extends 'selfservice/base.html' %}
{% load static %}
{% load humanize %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .salary-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 10px 20px rgba(0,0,0,0.2);
    }
    .salary-amount {
        font-size: 2.5rem;
        font-weight: bold;
    }
    .breakdown-table td {
        padding: 10px 0;
        border-bottom: 1px solid #f0f0f0;
    }
    .deduction-item {
        color: #dc3545;
    }
    .addition-item {
        color: #28a745;
    }
    .net-pay {
        font-size: 1.5rem;
        font-weight: bold;
        color: #007bff;
    }
    .comparison-card {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
    }
</style>
{% endblock %}

{% block selfservice_content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-md-8">
            <h2>보상 명세서</h2>
        </div>
        <div class="col-md-4 text-right">
            <!-- 연월 선택 -->
            <select id="yearSelect" class="form-control d-inline-block w-auto">
                {% for y in years %}
                <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}년</option>
                {% endfor %}
            </select>
            <select id="monthSelect" class="form-control d-inline-block w-auto">
                {% for m, name in months %}
                <option value="{{ m }}" {% if m == month %}selected{% endif %}>{{ m }}월</option>
                {% endfor %}
            </select>
        </div>
    </div>
    
    {% if monthly_breakdown %}
    <!-- 월 급여 요약 카드 -->
    <div class="salary-card">
        <div class="row">
            <div class="col-md-6">
                <h4>{{ year }}년 {{ month }}월 급여</h4>
                <div class="salary-amount">
                    ₩{{ monthly_breakdown.net_pay|floatformat:0|intcomma }}
                </div>
                <small>실수령액</small>
            </div>
            <div class="col-md-6 text-right">
                <div class="mt-3">
                    <div>지급총액: ₩{{ monthly_breakdown.gross_total|floatformat:0|intcomma }}</div>
                    <div>공제총액: ₩{{ monthly_breakdown.total_deductions|floatformat:0|intcomma }}</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 상세 내역 -->
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">지급 내역</h5>
                </div>
                <div class="card-body">
                    <table class="table breakdown-table">
                        <tbody>
                            <tr>
                                <td>기본급</td>
                                <td class="text-right">₩{{ monthly_breakdown.base_salary|floatformat:0|intcomma }}</td>
                            </tr>
                            <tr>
                                <td>고정OT (20시간)</td>
                                <td class="text-right">₩{{ monthly_breakdown.fixed_ot|floatformat:0|intcomma }}</td>
                            </tr>
                            <tr>
                                <td>역량급</td>
                                <td class="text-right">₩{{ monthly_breakdown.capability_pay|floatformat:0|intcomma }}</td>
                            </tr>
                            {% if monthly_breakdown.position_pay > 0 %}
                            <tr>
                                <td>직책급</td>
                                <td class="text-right">₩{{ monthly_breakdown.position_pay|floatformat:0|intcomma }}</td>
                            </tr>
                            {% endif %}
                            {% if monthly_breakdown.pi_amount > 0 %}
                            <tr class="addition-item">
                                <td><strong>성과급(PI)</strong></td>
                                <td class="text-right"><strong>₩{{ monthly_breakdown.pi_amount|floatformat:0|intcomma }}</strong></td>
                            </tr>
                            {% endif %}
                            {% if monthly_breakdown.chuseok_bonus > 0 %}
                            <tr class="addition-item">
                                <td><strong>추석상여</strong></td>
                                <td class="text-right"><strong>₩{{ monthly_breakdown.chuseok_bonus|floatformat:0|intcomma }}</strong></td>
                            </tr>
                            {% endif %}
                            <tr class="table-info">
                                <td><strong>지급총액</strong></td>
                                <td class="text-right"><strong>₩{{ monthly_breakdown.gross_total|floatformat:0|intcomma }}</strong></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">공제 내역</h5>
                </div>
                <div class="card-body">
                    <table class="table breakdown-table">
                        <tbody>
                            <tr class="deduction-item">
                                <td>소득세</td>
                                <td class="text-right">-₩{{ monthly_breakdown.income_tax|floatformat:0|intcomma }}</td>
                            </tr>
                            <tr class="deduction-item">
                                <td>지방소득세</td>
                                <td class="text-right">-₩{{ monthly_breakdown.local_tax|floatformat:0|intcomma }}</td>
                            </tr>
                            <tr class="deduction-item">
                                <td>국민연금</td>
                                <td class="text-right">-₩{{ monthly_breakdown.pension|floatformat:0|intcomma }}</td>
                            </tr>
                            <tr class="deduction-item">
                                <td>건강보험</td>
                                <td class="text-right">-₩{{ monthly_breakdown.health|floatformat:0|intcomma }}</td>
                            </tr>
                            <tr class="deduction-item">
                                <td>고용보험</td>
                                <td class="text-right">-₩{{ monthly_breakdown.employment|floatformat:0|intcomma }}</td>
                            </tr>
                            <tr class="table-danger">
                                <td><strong>공제총액</strong></td>
                                <td class="text-right"><strong>-₩{{ monthly_breakdown.total_deductions|floatformat:0|intcomma }}</strong></td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="mt-3 p-3 bg-light rounded">
                        <div class="net-pay text-center">
                            실수령액: ₩{{ monthly_breakdown.net_pay|floatformat:0|intcomma }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- 연간 요약 -->
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">{{ year }}년 연간 보상 요약</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <h6>연봉</h6>
                            <h4>₩{{ annual_summary.annual_salary|floatformat:0|intcomma }}</h4>
                        </div>
                        <div class="col-md-3">
                            <h6>성과급(PI)</h6>
                            <h4 class="text-success">₩{{ annual_summary.total_pi|floatformat:0|intcomma }}</h4>
                        </div>
                        <div class="col-md-3">
                            <h6>추가 보상</h6>
                            <h4 class="text-info">₩{{ annual_summary.other_compensation|floatformat:0|intcomma }}</h4>
                        </div>
                        <div class="col-md-3">
                            <h6>총 보상</h6>
                            <h4 class="text-primary">₩{{ annual_summary.total_compensation|floatformat:0|intcomma }}</h4>
                        </div>
                    </div>
                    
                    <!-- 월별 추이 차트 -->
                    <div class="mt-4">
                        <canvas id="monthlyTrendChart" height="100"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 동료 대비 분석 -->
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="comparison-card">
                <h5>동일 레벨 대비 보상 수준</h5>
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <div class="progress" style="height: 30px;">
                            <div class="progress-bar" role="progressbar" 
                                 style="width: {{ peer_comparison.percentile }}%"
                                 aria-valuenow="{{ peer_comparison.percentile }}" 
                                 aria-valuemin="0" aria-valuemax="100">
                                상위 {{ peer_comparison.percentile }}%
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 text-center">
                        <h6>나의 연봉</h6>
                        <h5>₩{{ peer_comparison.my_salary|floatformat:0|intcomma }}</h5>
                        <small>평균: ₩{{ peer_comparison.avg_salary|floatformat:0|intcomma }}</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 다운로드 버튼 -->
    <div class="text-center mt-4">
        <button class="btn btn-primary" onclick="downloadPDF()">
            <i class="fas fa-download"></i> PDF 다운로드
        </button>
        <button class="btn btn-secondary" onclick="printStatement()">
            <i class="fas fa-print"></i> 인쇄
        </button>
    </div>
</div>

<script>
// 연월 변경 시 페이지 새로고침
const yearSelect = document.getElementById('yearSelect');
const monthSelect = document.getElementById('monthSelect');
if (yearSelect && monthSelect) {
    yearSelect.addEventListener('change', updateStatement);
    monthSelect.addEventListener('change', updateStatement);
}
function updateStatement() {
    const year = document.getElementById('yearSelect').value;
    const month = document.getElementById('monthSelect').value;
    window.location.href = `/selfservice/compensation/${year}/${month}/`;
}
// 월별 추이 차트
const ctx = document.getElementById('monthlyTrendChart').getContext('2d');
const monthlyData = {{ monthly_trend|safe }};
new Chart(ctx, {
    type: 'bar',
    data: {
        labels: monthlyData.labels,
        datasets: [{
            label: '월 실수령액',
            data: monthlyData.net_pay,
            backgroundColor: 'rgba(54, 162, 235, 0.5)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
        }, {
            label: '특별 보상',
            data: monthlyData.special_pay,
            backgroundColor: 'rgba(255, 206, 86, 0.5)',
            borderColor: 'rgba(255, 206, 86, 1)',
            borderWidth: 1
        }]
    },
    options: {
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return '₩' + value.toLocaleString();
                    }
                }
            }
        },
        plugins: {
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return context.dataset.label + ': ₩' + context.parsed.y.toLocaleString();
                    }
                }
            }
        }
    }
});
</script>
{% endblock %} 