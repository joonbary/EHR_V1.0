{% extends 'base_revolutionary.html' %}
{% load static %}

{% block title %}보상 계산기 - Revolutionary Design{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/revolutionary-design-system.css' %}">
<style>
/* Calculator Specific Styles */
.calculator-page {
    min-height: 100vh;
    position: relative;
}

.calculator-hero {
    background: 
        linear-gradient(135deg, rgba(0, 212, 255, 0.1) 0%, rgba(0, 153, 255, 0.05) 100%),
        var(--bg-gradient);
    border-radius: var(--radius-xl);
    padding: var(--spacing-2xl);
    margin-bottom: var(--spacing-2xl);
    position: relative;
    overflow: hidden;
}

.calculator-hero::before {
    content: '';
    position: absolute;
    width: 150%;
    height: 150%;
    background: radial-gradient(circle, rgba(0, 212, 255, 0.2) 0%, transparent 70%);
    animation: rotate-slow 20s linear infinite;
    top: -25%;
    left: -25%;
}

.employee-select-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    padding: var(--spacing-lg);
    backdrop-filter: blur(10px);
    transition: var(--transition-smooth);
}

.employee-select-card:hover {
    border-color: var(--primary-color);
    box-shadow: 0 0 30px rgba(0, 212, 255, 0.2);
}

.employee-item {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.05);
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
    margin-bottom: var(--spacing-sm);
    cursor: pointer;
    transition: var(--transition-fast);
}

.employee-item:hover {
    background: rgba(0, 212, 255, 0.1);
    border-color: var(--primary-color);
    transform: translateX(5px);
}

.employee-item.active {
    background: linear-gradient(135deg, rgba(0, 212, 255, 0.2) 0%, rgba(0, 153, 255, 0.1) 100%);
    border-color: var(--primary-color);
    box-shadow: inset 0 0 20px rgba(0, 212, 255, 0.1);
}

.calculation-display {
    background: linear-gradient(135deg, var(--card-bg) 0%, rgba(255, 255, 255, 0.02) 100%);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-xl);
    padding: var(--spacing-xl);
    position: relative;
    overflow: hidden;
}

.total-compensation {
    font-size: clamp(36px, 5vw, 56px);
    font-weight: 900;
    background: linear-gradient(135deg, #00d4ff, #00ff88);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    text-shadow: 0 0 40px rgba(0, 212, 255, 0.5);
    margin-bottom: var(--spacing-md);
}

.compensation-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-md);
    background: rgba(255, 255, 255, 0.02);
    border-radius: var(--radius-md);
    margin-bottom: var(--spacing-sm);
    border: 1px solid rgba(255, 255, 255, 0.05);
    transition: var(--transition-fast);
}

.compensation-item:hover {
    background: rgba(0, 212, 255, 0.05);
    border-color: var(--primary-color);
    transform: scale(1.02);
}

.compensation-label {
    font-size: 14px;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 1px;
}

.compensation-value {
    font-size: 20px;
    font-weight: 700;
    color: var(--primary-color);
}

.formula-display {
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(0, 212, 255, 0.2);
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
    font-family: 'Courier New', monospace;
    color: var(--primary-color);
    margin-top: var(--spacing-md);
}

/* Animated Background */
.calc-pattern {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0.02;
    pointer-events: none;
    background-image: repeating-linear-gradient(
        45deg,
        transparent,
        transparent 35px,
        rgba(0, 212, 255, 0.1) 35px,
        rgba(0, 212, 255, 0.1) 70px
    );
    animation: slide 20s linear infinite;
}

@keyframes slide {
    0% { transform: translateX(0); }
    100% { transform: translateX(70px); }
}
</style>
{% endblock %}

{% block content %}
<div class="calculator-page">
    <div class="calc-pattern"></div>
    
    <div class="container-fluid px-4 main-content">
        <!-- Hero Section -->
        <div class="calculator-hero fade-in">
            <div class="hero-content" style="position: relative; z-index: 2;">
                <h1 class="hero-title gradient-text text-center">
                    <i class="fas fa-calculator"></i> AI 보상 계산기
                </h1>
                <p class="hero-subtitle text-center" style="color: var(--text-secondary); margin-top: var(--spacing-md); letter-spacing: 2px; text-transform: uppercase;">
                    Smart Compensation Calculator
                </p>
                <div class="text-center mt-4">
                    <button class="btn-revolutionary" onclick="runCalculation()">
                        <i class="fas fa-play"></i> 실시간 계산 실행
                    </button>
                    <button class="btn-outline-revolutionary ms-3" onclick="exportResults()">
                        <i class="fas fa-download"></i> 결과 내보내기
                    </button>
                </div>
            </div>
        </div>

        <!-- Calculator Section -->
        <div class="row mt-4">
            <!-- Employee Selection -->
            <div class="col-lg-4">
                <div class="employee-select-card animate-slide-up animate-delay-1">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3 class="section-title" style="font-size: 20px; margin-bottom: 0;">직원 선택</h3>
                        <span class="pulse-dot"></span>
                    </div>
                    <form id="calculatorForm">
                        <div class="mb-3">
                            <label for="employeeSearch" class="form-label-revolutionary">직원 검색</label>
                            <input type="text" class="form-control-revolutionary" id="employeeSearch" 
                                   placeholder="이름 또는 사번으로 검색">
                        </div>
                        <div class="mb-3">
                            <label for="payPeriod" class="form-label-revolutionary">급여 기간</label>
                            <input type="month" class="form-control-revolutionary" id="payPeriod" 
                                   value="{{ current_period }}">
                        </div>
                        <div class="mb-3">
                            <label for="employmentType" class="form-label-revolutionary">고용 형태</label>
                            <select class="form-control-revolutionary" id="employmentType">
                                <option value="">전체</option>
                                <option value="정규직">정규직</option>
                                <option value="Non-PL">Non-PL</option>
                                <option value="PL">PL</option>
                                <option value="별정직">별정직</option>
                            </select>
                        </div>
                    </form>

                    <!-- Employee List -->
                    <div class="employee-list mt-4" style="max-height: 400px; overflow-y: auto;">
                        <div id="employeeList">
                            <!-- Sample Employee Items -->
                            <div class="employee-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong style="color: var(--text-primary);">김철수</strong>
                                        <small class="d-block" style="color: var(--text-muted);">개발팀 · S등급</small>
                                    </div>
                                    <div class="text-end">
                                        <small class="gradient-text">₩7.5M</small>
                                    </div>
                                </div>
                            </div>
                            <div class="employee-item active">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong style="color: var(--text-primary);">이영희</strong>
                                        <small class="d-block" style="color: var(--text-muted);">영업팀 · A등급</small>
                                    </div>
                                    <div class="text-end">
                                        <small class="gradient-text">₩6.2M</small>
                                    </div>
                                </div>
                            </div>
                            <!-- More employee items will be dynamically added -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calculation Details -->
            <div class="col-lg-8">
                <div class="calculation-display animate-slide-up animate-delay-2">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3 class="section-title" style="font-size: 20px; margin-bottom: 0;">보상 계산 상세</h3>
                        <div>
                            <span class="badge" style="background: var(--primary-gradient); padding: 8px 16px; border-radius: 20px;">
                                <i class="fas fa-check-circle"></i> 실시간 계산
                            </span>
                        </div>
                    </div>
                    
                    <div id="calculationDetails">
                        <!-- Total Compensation Display -->
                        <div class="text-center mb-4">
                            <p class="text-muted mb-2">총 보상액</p>
                            <div class="total-compensation">
                                ₩ 6,200,000
                            </div>
                            <div class="metric-change positive" style="display: inline-flex;">
                                <i class="fas fa-arrow-up"></i>
                                <span>전월 대비 +3.2%</span>
                            </div>
                        </div>
                        
                        <!-- Compensation Breakdown -->
                        <div class="compensation-breakdown mt-5">
                            <h4 style="color: var(--text-primary); font-size: 18px; margin-bottom: var(--spacing-lg);">구성 항목</h4>
                            
                            <div class="compensation-item">
                                <div>
                                    <div class="compensation-label">기본급</div>
                                    <small style="color: var(--text-muted);">Base Salary</small>
                                </div>
                                <div class="compensation-value">₩3,720,000</div>
                            </div>
                            
                            <div class="compensation-item">
                                <div>
                                    <div class="compensation-label">고정 OT</div>
                                    <small style="color: var(--text-muted);">Fixed Overtime</small>
                                </div>
                                <div class="compensation-value">₩744,000</div>
                            </div>
                            
                            <div class="compensation-item">
                                <div>
                                    <div class="compensation-label">직책급</div>
                                    <small style="color: var(--text-muted);">Position Allowance</small>
                                </div>
                                <div class="compensation-value">₩496,000</div>
                            </div>
                            
                            <div class="compensation-item">
                                <div>
                                    <div class="compensation-label">역량급</div>
                                    <small style="color: var(--text-muted);">Skill Allowance</small>
                                </div>
                                <div class="compensation-value">₩310,000</div>
                            </div>
                            
                            <div class="compensation-item">
                                <div>
                                    <div class="compensation-label">성과급</div>
                                    <small style="color: var(--text-muted);">Performance Incentive</small>
                                </div>
                                <div class="compensation-value">₩930,000</div>
                            </div>
                        </div>
                        
                        <!-- Formula Display -->
                        <div class="formula-display">
                            <strong>계산식:</strong><br>
                            기본급(3,720,000) × 1.0 + 고정OT(20%) + 직책급(496,000) + 역량급(310,000) + PI(25%)
                        </div>
                    </div>
                </div>

                
                <!-- Additional Stats -->
                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="metric-card" style="height: 100%;">
                            <div class="metric-icon" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                                <i class="fas fa-percentage"></i>
                            </div>
                            <div class="metric-value">62.5%</div>
                            <div class="metric-label">기본급 비율</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="metric-card" style="height: 100%;">
                            <div class="metric-icon" style="background: linear-gradient(135deg, #f093fb, #f5576c);">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <div class="metric-value">15%</div>
                            <div class="metric-label">성과급 비율</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Simulation Section -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="revolutionary-card animate-slide-up animate-delay-3">
                    <h3 class="section-title" style="font-size: 20px;">
                        <i class="fas fa-chart-line" style="color: var(--primary-color);"></i> 보상 시뮬레이션
                    </h3>
                    <div class="mt-4">
                        <div class="row">
                            <div class="col-md-3">
                                <label class="form-label-revolutionary">성장레벨 변경</label>
                                <select class="form-control-revolutionary" id="simGrowthLevel">
                                    <option value="">현재 유지</option>
                                    <option value="1">레벨 1</option>
                                    <option value="2">레벨 2</option>
                                    <option value="3">레벨 3</option>
                                    <option value="4">레벨 4</option>
                                    <option value="5">레벨 5</option>
                                    <option value="6">레벨 6</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label-revolutionary">평가등급 변경</label>
                                <select class="form-control-revolutionary" id="simEvalGrade">
                                    <option value="">현재 유지</option>
                                    <option value="S">S</option>
                                    <option value="A+">A+</option>
                                    <option value="A">A</option>
                                    <option value="B+">B+</option>
                                    <option value="B">B</option>
                                    <option value="C">C</option>
                                    <option value="D">D</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label-revolutionary">직책 변경</label>
                                <select class="form-control-revolutionary" id="simPosition">
                                    <option value="">현재 유지</option>
                                    <option value="POS01">팀장</option>
                                    <option value="POS02">부문장</option>
                                    <option value="POS03">본부장</option>
                                </select>
                            </div>
                            <div class="col-md-3 d-flex align-items-end">
                                <button class="btn-revolutionary w-100" onclick="runSimulation()">
                                    <i class="fas fa-sync"></i> 시뮬레이션 실행
                                </button>
                            </div>
                        </div>

                        <!-- Simulation Results -->
                        <div class="mt-4" id="simulationResults">
                            <!-- Dynamic simulation results -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.employee-list .list-group-item {
    cursor: pointer;
    transition: all 0.3s;
}

.employee-list .list-group-item:hover {
    background-color: rgba(0, 212, 255, 0.1);
    border-left: 3px solid #00d4ff;
}

.employee-list .list-group-item.active {
    background-color: rgba(0, 212, 255, 0.2);
    border-color: #00d4ff;
}

.calculation-row {
    transition: all 0.3s;
}

.calculation-row:hover {
    background-color: rgba(0, 212, 255, 0.05);
}

.amount-positive {
    color: #28a745;
    font-weight: 600;
}

.amount-negative {
    color: #dc3545;
    font-weight: 600;
}

/* Select Option Style Fix for Dark Theme */
.form-control-revolutionary option {
    background: #1a1f2e;
    color: #ffffff;
}

.form-control-revolutionary:focus option {
    background: #1a1f2e;
    color: #ffffff;
}

/* Simulation Result Styles - Enhanced Readability */
.simulation-result-card {
    background: linear-gradient(135deg, rgba(0, 212, 255, 0.15) 0%, rgba(0, 153, 255, 0.08) 100%);
    border: 2px solid rgba(0, 212, 255, 0.4);
    border-radius: var(--radius-lg);
    padding: var(--spacing-xl);
    margin-top: var(--spacing-md);
    box-shadow: 0 10px 40px rgba(0, 212, 255, 0.15);
}

.simulation-metric {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 8px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.15);
    background: rgba(255, 255, 255, 0.02);
    margin-bottom: 4px;
    border-radius: 6px;
    transition: all 0.2s ease;
}

.simulation-metric:hover {
    background: rgba(0, 212, 255, 0.08);
    transform: translateX(5px);
}

.simulation-metric:last-child {
    border-bottom: none;
}

/* 텍스트 가독성 개선 */
.simulation-metric span:first-child {
    color: rgba(255, 255, 255, 0.95);
    font-weight: 500;
    font-size: 15px;
    letter-spacing: 0.3px;
}

.simulation-metric span:last-child {
    color: #ffffff;
    font-weight: 600;
    font-size: 16px;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

.simulation-section-title {
    color: #00d4ff;
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 16px;
    text-transform: uppercase;
    letter-spacing: 1px;
    text-shadow: 0 2px 8px rgba(0, 212, 255, 0.4);
}

.simulation-total {
    background: linear-gradient(135deg, rgba(0, 212, 255, 0.2) 0%, rgba(0, 255, 136, 0.1) 100%);
    border: 2px solid var(--primary-color);
    border-radius: 8px;
    padding: 12px;
    margin-top: 12px;
}

.simulation-change-positive {
    color: #00ff88;
    font-weight: 700;
    text-shadow: 0 0 20px rgba(0, 255, 136, 0.6);
}

.simulation-change-negative {
    color: #ff4757;
    font-weight: 700;
    text-shadow: 0 0 20px rgba(255, 71, 87, 0.6);
}

.simulation-change-box {
    background: linear-gradient(135deg, rgba(0, 212, 255, 0.2) 0%, rgba(0, 153, 255, 0.1) 100%);
    border: 2px solid rgba(0, 212, 255, 0.5);
    border-radius: var(--radius-md);
    padding: 20px;
    box-shadow: inset 0 2px 10px rgba(0, 212, 255, 0.2);
}

.simulation-change-box h5 {
    color: #ffffff;
    font-weight: 600;
    margin-bottom: 16px;
    font-size: 18px;
}
</style>

<script>
let selectedEmployee = null;

// 초기화
document.addEventListener('DOMContentLoaded', function() {
    const currentDate = new Date();
    const yearMonth = currentDate.toISOString().slice(0, 7);
    document.getElementById('payPeriod').value = yearMonth;
    
    loadEmployees();
});

// 직원 목록 로드
function loadEmployees() {
    const searchTerm = document.getElementById('employeeSearch').value;
    const employmentType = document.getElementById('employmentType').value;
    
    // API 호출하여 직원 목록 가져오기
    fetch(`/employees/api/employees/?search=${searchTerm}&employment_type=${employmentType}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            const listContainer = document.getElementById('employeeList');
            listContainer.innerHTML = '';
            
            // 페이지네이션된 응답 처리
            const employees = data.results || data;
            
            // 배열인지 확인
            if (!Array.isArray(employees)) {
                console.error('Unexpected data format:', data);
                displayDummyEmployees();
                return;
            }
            
            employees.forEach(employee => {
                const item = document.createElement('div');
                item.className = 'employee-item';
                item.onclick = () => selectEmployee(employee);
                item.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong style="color: var(--text-primary);">${employee.name}</strong>
                            <small class="d-block" style="color: var(--text-muted);">${employee.employee_id || ''} · ${employee.department || ''}</small>
                        </div>
                        <div class="text-end">
                            <small class="gradient-text">${employee.employment_type || ''}</small>
                        </div>
                    </div>
                `;
                listContainer.appendChild(item);
            });
        })
        .catch(error => {
            console.error('Error loading employees:', error);
            // 더미 데이터로 테스트
            displayDummyEmployees();
        });
}

// 직원 선택
function selectEmployee(employee) {
    selectedEmployee = employee;
    
    // UI 업데이트
    document.querySelectorAll('#employeeList .employee-item').forEach(item => {
        item.classList.remove('active');
    });
    event.currentTarget.classList.add('active');
    
    // 보상 계산 실행
    calculateCompensation();
}

// 보상 계산
function calculateCompensation() {
    if (!selectedEmployee) return;
    
    const payPeriod = document.getElementById('payPeriod').value;
    
    fetch(`/compensation/api/employee/${selectedEmployee.id}/statement/?period=${payPeriod}`)
        .then(response => response.json())
        .then(data => {
            displayCalculationBreakdown(data);
        })
        .catch(error => {
            console.error('Error calculating compensation:', error);
            displayDummyCalculation();
        });
}

// 계산 상세 표시 - displayCalculationBreakdown으로 통합

// 계산 내역 표시
function displayCalculationBreakdown(data) {
    const comp = data.compensation || {};
    
    // calculationDetails 요소에 직접 업데이트
    const detailsContainer = document.getElementById('calculationDetails');
    if (!detailsContainer) return;
    
    detailsContainer.innerHTML = `
        <!-- Total Compensation Display -->
        <div class="text-center mb-4">
            <p class="text-muted mb-2">총 보상액</p>
            <div class="total-compensation">
                ₩ ${(comp.total_compensation || 0).toLocaleString()}
            </div>
            <div class="metric-change positive" style="display: inline-flex;">
                <i class="fas fa-arrow-up"></i>
                <span>데이터 로드 완료</span>
            </div>
        </div>
        
        <!-- Compensation Breakdown -->
        <div class="compensation-breakdown mt-5">
            <h4 style="color: var(--text-primary); font-size: 18px; margin-bottom: var(--spacing-lg);">구성 항목</h4>
            
            <div class="compensation-item">
                <div>
                    <div class="compensation-label">기본급</div>
                    <small style="color: var(--text-muted);">Base Salary</small>
                </div>
                <div class="compensation-value">₩${(comp.base_salary || 0).toLocaleString()}</div>
            </div>
            
            <div class="compensation-item">
                <div>
                    <div class="compensation-label">고정 OT</div>
                    <small style="color: var(--text-muted);">Fixed Overtime</small>
                </div>
                <div class="compensation-value">₩${(comp.fixed_ot || 0).toLocaleString()}</div>
            </div>
            
            <div class="compensation-item">
                <div>
                    <div class="compensation-label">직책급</div>
                    <small style="color: var(--text-muted);">Position Allowance</small>
                </div>
                <div class="compensation-value">₩${(comp.position_allowance || 0).toLocaleString()}</div>
            </div>
            
            <div class="compensation-item">
                <div>
                    <div class="compensation-label">역량급</div>
                    <small style="color: var(--text-muted);">Skill Allowance</small>
                </div>
                <div class="compensation-value">₩${(comp.competency_allowance || 0).toLocaleString()}</div>
            </div>
            
            <div class="compensation-item">
                <div>
                    <div class="compensation-label">성과급</div>
                    <small style="color: var(--text-muted);">Performance Incentive</small>
                </div>
                <div class="compensation-value">₩${(comp.pi_amount || 0).toLocaleString()}</div>
            </div>
        </div>
        
        <!-- Formula Display -->
        <div class="formula-display">
            <strong>계산식:</strong><br>
            기본급(${(comp.base_salary || 0).toLocaleString()}) + 고정OT(${(comp.fixed_ot || 0).toLocaleString()}) + 직책급(${(comp.position_allowance || 0).toLocaleString()}) + 역량급(${(comp.competency_allowance || 0).toLocaleString()}) + PI(${(comp.pi_amount || 0).toLocaleString()})
        </div>
    `;
}

// 시뮬레이션 실행
function runSimulation() {
    if (!selectedEmployee) {
        alert('먼저 직원을 선택해주세요.');
        return;
    }
    
    // 시뮬레이션 파라미터
    const params = {
        employee_id: selectedEmployee.id,
        growth_level: document.getElementById('simGrowthLevel').value,
        eval_grade: document.getElementById('simEvalGrade').value,
        position: document.getElementById('simPosition').value,
        period: document.getElementById('payPeriod').value
    };
    
    // 로딩 표시
    const resultsContainer = document.getElementById('simulationResults');
    resultsContainer.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">시뮬레이션 중...</span>
            </div>
            <p class="mt-2 text-muted">시뮬레이션 계산 중...</p>
        </div>
    `;
    
    // API 호출 (실제 API가 없으면 더미 데이터 사용)
    fetch('/compensation/api/simulation/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify(params)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('API not available');
        }
        return response.json();
    })
    .then(data => {
        displaySimulationResults(data);
    })
    .catch(error => {
        console.log('Using dummy simulation data:', error);
        // 더미 데이터로 시뮬레이션 결과 생성
        const currentComp = calculateCurrentCompensation();
        const simulatedComp = calculateSimulatedCompensation(currentComp, params);
        displaySimulationResults({
            current: currentComp,
            simulated: simulatedComp,
            params: params
        });
    });
}

// 현재 보상 계산
function calculateCurrentCompensation() {
    // 현재 표시된 보상 정보 가져오기
    const totalCompElement = document.querySelector('.total-compensation');
    let currentTotal = 6200000; // 기본값
    
    if (totalCompElement) {
        const text = totalCompElement.textContent.replace(/[^0-9]/g, '');
        if (text) {
            currentTotal = parseInt(text);
        }
    }
    
    return {
        base_salary: Math.floor(currentTotal * 0.6),
        fixed_ot: Math.floor(currentTotal * 0.12),
        position_allowance: Math.floor(currentTotal * 0.08),
        competency_allowance: Math.floor(currentTotal * 0.05),
        pi_amount: Math.floor(currentTotal * 0.15),
        total_compensation: currentTotal
    };
}

// 시뮬레이션 보상 계산
function calculateSimulatedCompensation(current, params) {
    let multiplier = 1.0;
    
    // 성장레벨에 따른 조정
    if (params.growth_level) {
        const levelMultipliers = {
            '1': 0.9, '2': 0.95, '3': 1.0, 
            '4': 1.05, '5': 1.1, '6': 1.15
        };
        multiplier *= levelMultipliers[params.growth_level] || 1.0;
    }
    
    // 평가등급에 따른 조정
    if (params.eval_grade) {
        const gradeMultipliers = {
            'S': 1.2, 'A+': 1.15, 'A': 1.1,
            'B+': 1.05, 'B': 1.0, 'C': 0.95, 'D': 0.9
        };
        multiplier *= gradeMultipliers[params.eval_grade] || 1.0;
    }
    
    // 직책에 따른 조정
    if (params.position) {
        const positionBonuses = {
            'POS01': 500000,  // 팀장
            'POS02': 1000000, // 부문장
            'POS03': 2000000  // 본부장
        };
        current.position_allowance = positionBonuses[params.position] || current.position_allowance;
    }
    
    // 새로운 보상 계산
    const simulated = {
        base_salary: Math.floor(current.base_salary * multiplier),
        fixed_ot: Math.floor(current.fixed_ot * multiplier),
        position_allowance: current.position_allowance,
        competency_allowance: Math.floor(current.competency_allowance * multiplier),
        pi_amount: Math.floor(current.pi_amount * multiplier * 1.1), // PI는 추가 10% 보너스
        total_compensation: 0
    };
    
    simulated.total_compensation = simulated.base_salary + simulated.fixed_ot + 
                                   simulated.position_allowance + simulated.competency_allowance + 
                                   simulated.pi_amount;
    
    return simulated;
}

// 시뮬레이션 결과 표시
function displaySimulationResults(data) {
    const resultsContainer = document.getElementById('simulationResults');
    const current = data.current;
    const simulated = data.simulated;
    const difference = simulated.total_compensation - current.total_compensation;
    const percentChange = ((difference / current.total_compensation) * 100).toFixed(1);
    
    resultsContainer.innerHTML = `
        <div class="simulation-result-card">
            <h5 class="mb-4" style="color: #ffffff; font-weight: 700; font-size: 22px; text-shadow: 0 2px 10px rgba(0, 212, 255, 0.5);">
                <i class="fas fa-chart-line" style="color: #00d4ff;"></i> 시뮬레이션 결과
            </h5>
            
            <div class="row mb-4">
                <div class="col-md-6 mb-3">
                    <h6 class="simulation-section-title">
                        <i class="fas fa-wallet"></i> 현재 보상
                    </h6>
                    <div class="simulation-metric">
                        <span>기본급</span>
                        <span>₩${current.base_salary.toLocaleString()}</span>
                    </div>
                    <div class="simulation-metric">
                        <span>고정 OT</span>
                        <span>₩${current.fixed_ot.toLocaleString()}</span>
                    </div>
                    <div class="simulation-metric">
                        <span>직책급</span>
                        <span>₩${current.position_allowance.toLocaleString()}</span>
                    </div>
                    <div class="simulation-metric">
                        <span>역량급</span>
                        <span>₩${current.competency_allowance.toLocaleString()}</span>
                    </div>
                    <div class="simulation-metric">
                        <span>성과급</span>
                        <span>₩${current.pi_amount.toLocaleString()}</span>
                    </div>
                    <div class="simulation-total">
                        <div class="d-flex justify-content-between align-items-center">
                            <strong style="color: #ffffff; font-size: 16px;">총 보상</strong>
                            <strong style="color: #00d4ff; font-size: 20px; text-shadow: 0 0 10px rgba(0, 212, 255, 0.5);">
                                ₩${current.total_compensation.toLocaleString()}
                            </strong>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6 mb-3">
                    <h6 class="simulation-section-title">
                        <i class="fas fa-rocket"></i> 예상 보상
                    </h6>
                    <div class="simulation-metric">
                        <span>기본급</span>
                        <span ${simulated.base_salary > current.base_salary ? 'style="color: #00ff88;"' : simulated.base_salary < current.base_salary ? 'style="color: #ff4757;"' : ''}>
                            ₩${simulated.base_salary.toLocaleString()}
                            ${simulated.base_salary > current.base_salary ? ' ↑' : simulated.base_salary < current.base_salary ? ' ↓' : ''}
                        </span>
                    </div>
                    <div class="simulation-metric">
                        <span>고정 OT</span>
                        <span ${simulated.fixed_ot > current.fixed_ot ? 'style="color: #00ff88;"' : simulated.fixed_ot < current.fixed_ot ? 'style="color: #ff4757;"' : ''}>
                            ₩${simulated.fixed_ot.toLocaleString()}
                            ${simulated.fixed_ot > current.fixed_ot ? ' ↑' : simulated.fixed_ot < current.fixed_ot ? ' ↓' : ''}
                        </span>
                    </div>
                    <div class="simulation-metric">
                        <span>직책급</span>
                        <span ${simulated.position_allowance > current.position_allowance ? 'style="color: #00ff88;"' : simulated.position_allowance < current.position_allowance ? 'style="color: #ff4757;"' : ''}>
                            ₩${simulated.position_allowance.toLocaleString()}
                            ${simulated.position_allowance > current.position_allowance ? ' ↑' : simulated.position_allowance < current.position_allowance ? ' ↓' : ''}
                        </span>
                    </div>
                    <div class="simulation-metric">
                        <span>역량급</span>
                        <span ${simulated.competency_allowance > current.competency_allowance ? 'style="color: #00ff88;"' : simulated.competency_allowance < current.competency_allowance ? 'style="color: #ff4757;"' : ''}>
                            ₩${simulated.competency_allowance.toLocaleString()}
                            ${simulated.competency_allowance > current.competency_allowance ? ' ↑' : simulated.competency_allowance < current.competency_allowance ? ' ↓' : ''}
                        </span>
                    </div>
                    <div class="simulation-metric">
                        <span>성과급</span>
                        <span ${simulated.pi_amount > current.pi_amount ? 'style="color: #00ff88;"' : simulated.pi_amount < current.pi_amount ? 'style="color: #ff4757;"' : ''}>
                            ₩${simulated.pi_amount.toLocaleString()}
                            ${simulated.pi_amount > current.pi_amount ? ' ↑' : simulated.pi_amount < current.pi_amount ? ' ↓' : ''}
                        </span>
                    </div>
                    <div class="simulation-total">
                        <div class="d-flex justify-content-between align-items-center">
                            <strong style="color: #ffffff; font-size: 16px;">총 보상</strong>
                            <strong style="color: #00ff88; font-size: 20px; text-shadow: 0 0 10px rgba(0, 255, 136, 0.5);">
                                ₩${simulated.total_compensation.toLocaleString()}
                            </strong>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="simulation-change-box text-center">
                <h5 style="color: #ffffff; font-weight: 600;">
                    <i class="fas fa-exchange-alt" style="color: #00d4ff;"></i> 보상 변화량
                </h5>
                <div class="d-flex justify-content-center align-items-center gap-4">
                    <span class="${difference >= 0 ? 'simulation-change-positive' : 'simulation-change-negative'}" style="font-size: 28px;">
                        ${difference >= 0 ? '↑' : '↓'} ${difference >= 0 ? '+' : ''}₩${Math.abs(difference).toLocaleString()}
                    </span>
                    <span class="${difference >= 0 ? 'simulation-change-positive' : 'simulation-change-negative'}" style="font-size: 24px;">
                        (${difference >= 0 ? '+' : ''}${percentChange}%)
                    </span>
                </div>
                ${difference !== 0 ? `
                <div class="mt-3">
                    <span style="color: rgba(255, 255, 255, 0.8); font-size: 14px;">
                        ${difference > 0 ? '🎆 예상 보상이 증가합니다!' : '📉 예상 보상이 감소합니다.'}
                    </span>
                </div>
                ` : ''}
            </div>
        </div>
    `;
}

// CSRF 토큰 가져오기
function getCsrfToken() {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfToken) {
        return csrfToken.value;
    }
    // 쿠키에서 가져오기
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'csrftoken') {
            return value;
        }
    }
    return '{{ csrf_token }}';
}

// 계산 실행
function runCalculation() {
    const payPeriod = document.getElementById('payPeriod').value;
    
    if (!payPeriod) {
        alert('급여 기간을 선택해주세요.');
        return;
    }
    
    // 전체 계산 실행
    fetch('/compensation/api/snapshot/run/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            period: payPeriod,
            employee_ids: selectedEmployee ? [selectedEmployee.id] : null
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'completed') {
            alert('계산이 완료되었습니다.');
            if (selectedEmployee) {
                calculateCompensation();
            }
        } else {
            alert('계산 중 오류가 발생했습니다.');
        }
    })
    .catch(error => {
        console.error('Error running calculation:', error);
        alert('계산 실행에 실패했습니다.');
    });
}

// 더미 데이터 표시 (API 연결 전 테스트용)
function displayDummyEmployees() {
    const employees = [
        {id: 1, name: '김철수', employee_id: 'E001', department: '개발팀', employment_type: '정규직'},
        {id: 2, name: '이영희', employee_id: 'E002', department: '영업팀', employment_type: 'Non-PL'},
        {id: 3, name: '박민수', employee_id: 'E003', department: '기획팀', employment_type: 'PL'},
    ];
    
    const listContainer = document.getElementById('employeeList');
    listContainer.innerHTML = '';
    
    employees.forEach(employee => {
        const item = document.createElement('div');
        item.className = 'employee-item';
        item.onclick = () => selectEmployee(employee);
        item.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <strong style="color: var(--text-primary);">${employee.name}</strong>
                    <small class="d-block" style="color: var(--text-muted);">${employee.employee_id} · ${employee.department}</small>
                </div>
                <div class="text-end">
                    <small class="gradient-text">${employee.employment_type}</small>
                </div>
            </div>
        `;
        listContainer.appendChild(item);
    });
}

function displayDummyCalculation() {
    const dummyData = {
        employee: {
            name: selectedEmployee?.name || '김철수',
            department: selectedEmployee?.department || '개발팀',
            position: '팀장',
            employment_type: selectedEmployee?.employment_type || '정규직'
        },
        compensation: {
            base_salary: 4500000,
            fixed_ot: 645933,
            position_allowance: 800000,
            competency_allowance: 450000,
            pi_amount: 0,
            monthly_pi_amount: 0,
            holiday_bonus: 0,
            ordinary_wage: 5750000,
            total_compensation: 6395933
        }
    };
    
    displayCalculationBreakdown(dummyData);
}

// 검색 이벤트
document.getElementById('employeeSearch').addEventListener('input', loadEmployees);
document.getElementById('employmentType').addEventListener('change', loadEmployees);
</script>
{% endblock %}