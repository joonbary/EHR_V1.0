{% extends 'base_revolutionary.html' %}
{% load static %}

{% block title %}ë³´ìƒ ê³„ì‚°ê¸° - Revolutionary Design{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/revolutionary-design-system.css' %}">
<style>
/* Calculator Specific Styles */
.calculator-page {
    min-height: 100vh;
    position: relative;
}

.calculator-hero {
    background: 
        linear-gradient(135deg, rgba(0, 212, 255, 0.1) 0%, rgba(0, 153, 255, 0.05) 100%),
        var(--bg-gradient);
    border-radius: var(--radius-xl);
    padding: var(--spacing-2xl);
    margin-bottom: var(--spacing-2xl);
    position: relative;
    overflow: hidden;
}

.calculator-hero::before {
    content: '';
    position: absolute;
    width: 150%;
    height: 150%;
    background: radial-gradient(circle, rgba(0, 212, 255, 0.2) 0%, transparent 70%);
    animation: rotate-slow 20s linear infinite;
    top: -25%;
    left: -25%;
}

.employee-select-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    padding: var(--spacing-lg);
    backdrop-filter: blur(10px);
    transition: var(--transition-smooth);
}

.employee-select-card:hover {
    border-color: var(--primary-color);
    box-shadow: 0 0 30px rgba(0, 212, 255, 0.2);
}

.employee-item {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.05);
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
    margin-bottom: var(--spacing-sm);
    cursor: pointer;
    transition: var(--transition-fast);
}

.employee-item:hover {
    background: rgba(0, 212, 255, 0.1);
    border-color: var(--primary-color);
    transform: translateX(5px);
}

.employee-item.active {
    background: linear-gradient(135deg, rgba(0, 212, 255, 0.2) 0%, rgba(0, 153, 255, 0.1) 100%);
    border-color: var(--primary-color);
    box-shadow: inset 0 0 20px rgba(0, 212, 255, 0.1);
}

.calculation-display {
    background: linear-gradient(135deg, var(--card-bg) 0%, rgba(255, 255, 255, 0.02) 100%);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-xl);
    padding: var(--spacing-xl);
    position: relative;
    overflow: hidden;
}

.total-compensation {
    font-size: clamp(36px, 5vw, 56px);
    font-weight: 900;
    background: linear-gradient(135deg, #00d4ff, #00ff88);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    text-shadow: 0 0 40px rgba(0, 212, 255, 0.5);
    margin-bottom: var(--spacing-md);
}

.compensation-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-md);
    background: rgba(255, 255, 255, 0.02);
    border-radius: var(--radius-md);
    margin-bottom: var(--spacing-sm);
    border: 1px solid rgba(255, 255, 255, 0.05);
    transition: var(--transition-fast);
}

.compensation-item:hover {
    background: rgba(0, 212, 255, 0.05);
    border-color: var(--primary-color);
    transform: scale(1.02);
}

.compensation-label {
    font-size: 14px;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 1px;
}

.compensation-value {
    font-size: 20px;
    font-weight: 700;
    color: var(--primary-color);
}

.formula-display {
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(0, 212, 255, 0.2);
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
    font-family: 'Courier New', monospace;
    color: var(--primary-color);
    margin-top: var(--spacing-md);
}

/* Animated Background */
.calc-pattern {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0.02;
    pointer-events: none;
    background-image: repeating-linear-gradient(
        45deg,
        transparent,
        transparent 35px,
        rgba(0, 212, 255, 0.1) 35px,
        rgba(0, 212, 255, 0.1) 70px
    );
    animation: slide 20s linear infinite;
}

@keyframes slide {
    0% { transform: translateX(0); }
    100% { transform: translateX(70px); }
}
</style>
{% endblock %}

{% block content %}
<div class="calculator-page">
    <div class="calc-pattern"></div>
    
    <div class="container-fluid px-4 main-content">
        <!-- Hero Section -->
        <div class="calculator-hero fade-in">
            <div class="hero-content" style="position: relative; z-index: 2;">
                <h1 class="hero-title gradient-text text-center">
                    <i class="fas fa-calculator"></i> AI ë³´ìƒ ê³„ì‚°ê¸°
                </h1>
                <p class="hero-subtitle text-center" style="color: var(--text-secondary); margin-top: var(--spacing-md); letter-spacing: 2px; text-transform: uppercase;">
                    Smart Compensation Calculator
                </p>
                <div class="text-center mt-4">
                    <button class="btn-revolutionary" onclick="runCalculation()">
                        <i class="fas fa-play"></i> ì‹¤ì‹œê°„ ê³„ì‚° ì‹¤í–‰
                    </button>
                    <button class="btn-outline-revolutionary ms-3" onclick="exportResults()">
                        <i class="fas fa-download"></i> ê²°ê³¼ ë‚´ë³´ë‚´ê¸°
                    </button>
                </div>
            </div>
        </div>

        <!-- Calculator Section -->
        <div class="row mt-4">
            <!-- Employee Selection -->
            <div class="col-lg-4">
                <div class="employee-select-card animate-slide-up animate-delay-1">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3 class="section-title" style="font-size: 20px; margin-bottom: 0;">ì§ì› ì„ íƒ</h3>
                        <span class="pulse-dot"></span>
                    </div>
                    <form id="calculatorForm">
                        <div class="mb-3">
                            <label for="employeeSearch" class="form-label-revolutionary">ì§ì› ê²€ìƒ‰</label>
                            <input type="text" class="form-control-revolutionary" id="employeeSearch" 
                                   placeholder="ì´ë¦„ ë˜ëŠ” ì‚¬ë²ˆìœ¼ë¡œ ê²€ìƒ‰">
                        </div>
                        <div class="mb-3">
                            <label for="payPeriod" class="form-label-revolutionary">ê¸‰ì—¬ ê¸°ê°„</label>
                            <input type="month" class="form-control-revolutionary" id="payPeriod" 
                                   value="{{ current_period }}">
                        </div>
                        <div class="mb-3">
                            <label for="employmentType" class="form-label-revolutionary">ê³ ìš© í˜•íƒœ</label>
                            <select class="form-control-revolutionary" id="employmentType">
                                <option value="">ì „ì²´</option>
                                <option value="ì •ê·œì§">ì •ê·œì§</option>
                                <option value="Non-PL">Non-PL</option>
                                <option value="PL">PL</option>
                                <option value="ë³„ì •ì§">ë³„ì •ì§</option>
                            </select>
                        </div>
                    </form>

                    <!-- Employee List -->
                    <div class="employee-list mt-4" style="max-height: 400px; overflow-y: auto;">
                        <div id="employeeList">
                            <!-- Sample Employee Items -->
                            <div class="employee-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong style="color: var(--text-primary);">ê¹€ì² ìˆ˜</strong>
                                        <small class="d-block" style="color: var(--text-muted);">ê°œë°œíŒ€ Â· Së“±ê¸‰</small>
                                    </div>
                                    <div class="text-end">
                                        <small class="gradient-text">â‚©7.5M</small>
                                    </div>
                                </div>
                            </div>
                            <div class="employee-item active">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong style="color: var(--text-primary);">ì´ì˜í¬</strong>
                                        <small class="d-block" style="color: var(--text-muted);">ì˜ì—…íŒ€ Â· Aë“±ê¸‰</small>
                                    </div>
                                    <div class="text-end">
                                        <small class="gradient-text">â‚©6.2M</small>
                                    </div>
                                </div>
                            </div>
                            <!-- More employee items will be dynamically added -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calculation Details -->
            <div class="col-lg-8">
                <div class="calculation-display animate-slide-up animate-delay-2">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3 class="section-title" style="font-size: 20px; margin-bottom: 0;">ë³´ìƒ ê³„ì‚° ìƒì„¸</h3>
                        <div>
                            <span class="badge" style="background: var(--primary-gradient); padding: 8px 16px; border-radius: 20px;">
                                <i class="fas fa-check-circle"></i> ì‹¤ì‹œê°„ ê³„ì‚°
                            </span>
                        </div>
                    </div>
                    
                    <div id="calculationDetails">
                        <!-- Total Compensation Display -->
                        <div class="text-center mb-4">
                            <p class="text-muted mb-2">ì´ ë³´ìƒì•¡</p>
                            <div class="total-compensation">
                                â‚© 6,200,000
                            </div>
                            <div class="metric-change positive" style="display: inline-flex;">
                                <i class="fas fa-arrow-up"></i>
                                <span>ì „ì›” ëŒ€ë¹„ +3.2%</span>
                            </div>
                        </div>
                        
                        <!-- Compensation Breakdown -->
                        <div class="compensation-breakdown mt-5">
                            <h4 style="color: var(--text-primary); font-size: 18px; margin-bottom: var(--spacing-lg);">êµ¬ì„± í•­ëª©</h4>
                            
                            <div class="compensation-item">
                                <div>
                                    <div class="compensation-label">ê¸°ë³¸ê¸‰</div>
                                    <small style="color: var(--text-muted);">Base Salary</small>
                                </div>
                                <div class="compensation-value">â‚©3,720,000</div>
                            </div>
                            
                            <div class="compensation-item">
                                <div>
                                    <div class="compensation-label">ê³ ì • OT</div>
                                    <small style="color: var(--text-muted);">Fixed Overtime</small>
                                </div>
                                <div class="compensation-value">â‚©744,000</div>
                            </div>
                            
                            <div class="compensation-item">
                                <div>
                                    <div class="compensation-label">ì§ì±…ê¸‰</div>
                                    <small style="color: var(--text-muted);">Position Allowance</small>
                                </div>
                                <div class="compensation-value">â‚©496,000</div>
                            </div>
                            
                            <div class="compensation-item">
                                <div>
                                    <div class="compensation-label">ì—­ëŸ‰ê¸‰</div>
                                    <small style="color: var(--text-muted);">Skill Allowance</small>
                                </div>
                                <div class="compensation-value">â‚©310,000</div>
                            </div>
                            
                            <div class="compensation-item">
                                <div>
                                    <div class="compensation-label">ì„±ê³¼ê¸‰</div>
                                    <small style="color: var(--text-muted);">Performance Incentive</small>
                                </div>
                                <div class="compensation-value">â‚©930,000</div>
                            </div>
                        </div>
                        
                        <!-- Formula Display -->
                        <div class="formula-display">
                            <strong>ê³„ì‚°ì‹:</strong><br>
                            ê¸°ë³¸ê¸‰(3,720,000) Ã— 1.0 + ê³ ì •OT(20%) + ì§ì±…ê¸‰(496,000) + ì—­ëŸ‰ê¸‰(310,000) + PI(25%)
                        </div>
                    </div>
                </div>

                
                <!-- Additional Stats -->
                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="metric-card" style="height: 100%;">
                            <div class="metric-icon" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                                <i class="fas fa-percentage"></i>
                            </div>
                            <div class="metric-value">62.5%</div>
                            <div class="metric-label">ê¸°ë³¸ê¸‰ ë¹„ìœ¨</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="metric-card" style="height: 100%;">
                            <div class="metric-icon" style="background: linear-gradient(135deg, #f093fb, #f5576c);">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <div class="metric-value">15%</div>
                            <div class="metric-label">ì„±ê³¼ê¸‰ ë¹„ìœ¨</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Simulation Section -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="revolutionary-card animate-slide-up animate-delay-3">
                    <h3 class="section-title" style="font-size: 20px;">
                        <i class="fas fa-chart-line" style="color: var(--primary-color);"></i> ë³´ìƒ ì‹œë®¬ë ˆì´ì…˜
                    </h3>
                    <div class="mt-4">
                        <div class="row">
                            <div class="col-md-3">
                                <label class="form-label-revolutionary">ì„±ì¥ë ˆë²¨ ë³€ê²½</label>
                                <select class="form-control-revolutionary" id="simGrowthLevel">
                                    <option value="">í˜„ì¬ ìœ ì§€</option>
                                    <option value="1">ë ˆë²¨ 1</option>
                                    <option value="2">ë ˆë²¨ 2</option>
                                    <option value="3">ë ˆë²¨ 3</option>
                                    <option value="4">ë ˆë²¨ 4</option>
                                    <option value="5">ë ˆë²¨ 5</option>
                                    <option value="6">ë ˆë²¨ 6</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label-revolutionary">í‰ê°€ë“±ê¸‰ ë³€ê²½</label>
                                <select class="form-control-revolutionary" id="simEvalGrade">
                                    <option value="">í˜„ì¬ ìœ ì§€</option>
                                    <option value="S">S</option>
                                    <option value="A+">A+</option>
                                    <option value="A">A</option>
                                    <option value="B+">B+</option>
                                    <option value="B">B</option>
                                    <option value="C">C</option>
                                    <option value="D">D</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label-revolutionary">ì§ì±… ë³€ê²½</label>
                                <select class="form-control-revolutionary" id="simPosition">
                                    <option value="">í˜„ì¬ ìœ ì§€</option>
                                    <option value="POS01">íŒ€ì¥</option>
                                    <option value="POS02">ë¶€ë¬¸ì¥</option>
                                    <option value="POS03">ë³¸ë¶€ì¥</option>
                                </select>
                            </div>
                            <div class="col-md-3 d-flex align-items-end">
                                <button class="btn-revolutionary w-100" onclick="runSimulation()">
                                    <i class="fas fa-sync"></i> ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰
                                </button>
                            </div>
                        </div>

                        <!-- Simulation Results -->
                        <div class="mt-4" id="simulationResults">
                            <!-- Dynamic simulation results -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.employee-list .list-group-item {
    cursor: pointer;
    transition: all 0.3s;
}

.employee-list .list-group-item:hover {
    background-color: rgba(0, 212, 255, 0.1);
    border-left: 3px solid #00d4ff;
}

.employee-list .list-group-item.active {
    background-color: rgba(0, 212, 255, 0.2);
    border-color: #00d4ff;
}

.calculation-row {
    transition: all 0.3s;
}

.calculation-row:hover {
    background-color: rgba(0, 212, 255, 0.05);
}

.amount-positive {
    color: #28a745;
    font-weight: 600;
}

.amount-negative {
    color: #dc3545;
    font-weight: 600;
}

/* Select Option Style Fix for Dark Theme */
.form-control-revolutionary option {
    background: #1a1f2e;
    color: #ffffff;
}

.form-control-revolutionary:focus option {
    background: #1a1f2e;
    color: #ffffff;
}

/* Simulation Result Styles - Enhanced Readability */
.simulation-result-card {
    background: linear-gradient(135deg, rgba(0, 212, 255, 0.15) 0%, rgba(0, 153, 255, 0.08) 100%);
    border: 2px solid rgba(0, 212, 255, 0.4);
    border-radius: var(--radius-lg);
    padding: var(--spacing-xl);
    margin-top: var(--spacing-md);
    box-shadow: 0 10px 40px rgba(0, 212, 255, 0.15);
}

.simulation-metric {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 8px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.15);
    background: rgba(255, 255, 255, 0.02);
    margin-bottom: 4px;
    border-radius: 6px;
    transition: all 0.2s ease;
}

.simulation-metric:hover {
    background: rgba(0, 212, 255, 0.08);
    transform: translateX(5px);
}

.simulation-metric:last-child {
    border-bottom: none;
}

/* í…ìŠ¤íŠ¸ ê°€ë…ì„± ê°œì„  */
.simulation-metric span:first-child {
    color: rgba(255, 255, 255, 0.95);
    font-weight: 500;
    font-size: 15px;
    letter-spacing: 0.3px;
}

.simulation-metric span:last-child {
    color: #ffffff;
    font-weight: 600;
    font-size: 16px;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

.simulation-section-title {
    color: #00d4ff;
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 16px;
    text-transform: uppercase;
    letter-spacing: 1px;
    text-shadow: 0 2px 8px rgba(0, 212, 255, 0.4);
}

.simulation-total {
    background: linear-gradient(135deg, rgba(0, 212, 255, 0.2) 0%, rgba(0, 255, 136, 0.1) 100%);
    border: 2px solid var(--primary-color);
    border-radius: 8px;
    padding: 12px;
    margin-top: 12px;
}

.simulation-change-positive {
    color: #00ff88;
    font-weight: 700;
    text-shadow: 0 0 20px rgba(0, 255, 136, 0.6);
}

.simulation-change-negative {
    color: #ff4757;
    font-weight: 700;
    text-shadow: 0 0 20px rgba(255, 71, 87, 0.6);
}

.simulation-change-box {
    background: linear-gradient(135deg, rgba(0, 212, 255, 0.2) 0%, rgba(0, 153, 255, 0.1) 100%);
    border: 2px solid rgba(0, 212, 255, 0.5);
    border-radius: var(--radius-md);
    padding: 20px;
    box-shadow: inset 0 2px 10px rgba(0, 212, 255, 0.2);
}

.simulation-change-box h5 {
    color: #ffffff;
    font-weight: 600;
    margin-bottom: 16px;
    font-size: 18px;
}
</style>

<script>
let selectedEmployee = null;

// ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
    const currentDate = new Date();
    const yearMonth = currentDate.toISOString().slice(0, 7);
    document.getElementById('payPeriod').value = yearMonth;
    
    loadEmployees();
});

// ì§ì› ëª©ë¡ ë¡œë“œ
function loadEmployees() {
    const searchTerm = document.getElementById('employeeSearch').value;
    const employmentType = document.getElementById('employmentType').value;
    
    // API í˜¸ì¶œí•˜ì—¬ ì§ì› ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    fetch(`/employees/api/employees/?search=${searchTerm}&employment_type=${employmentType}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            const listContainer = document.getElementById('employeeList');
            listContainer.innerHTML = '';
            
            // í˜ì´ì§€ë„¤ì´ì…˜ëœ ì‘ë‹µ ì²˜ë¦¬
            const employees = data.results || data;
            
            // ë°°ì—´ì¸ì§€ í™•ì¸
            if (!Array.isArray(employees)) {
                console.error('Unexpected data format:', data);
                displayDummyEmployees();
                return;
            }
            
            employees.forEach(employee => {
                const item = document.createElement('div');
                item.className = 'employee-item';
                item.onclick = () => selectEmployee(employee);
                item.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong style="color: var(--text-primary);">${employee.name}</strong>
                            <small class="d-block" style="color: var(--text-muted);">${employee.employee_id || ''} Â· ${employee.department || ''}</small>
                        </div>
                        <div class="text-end">
                            <small class="gradient-text">${employee.employment_type || ''}</small>
                        </div>
                    </div>
                `;
                listContainer.appendChild(item);
            });
        })
        .catch(error => {
            console.error('Error loading employees:', error);
            // ë”ë¯¸ ë°ì´í„°ë¡œ í…ŒìŠ¤íŠ¸
            displayDummyEmployees();
        });
}

// ì§ì› ì„ íƒ
function selectEmployee(employee) {
    selectedEmployee = employee;
    
    // UI ì—…ë°ì´íŠ¸
    document.querySelectorAll('#employeeList .employee-item').forEach(item => {
        item.classList.remove('active');
    });
    event.currentTarget.classList.add('active');
    
    // ë³´ìƒ ê³„ì‚° ì‹¤í–‰
    calculateCompensation();
}

// ë³´ìƒ ê³„ì‚°
function calculateCompensation() {
    if (!selectedEmployee) return;
    
    const payPeriod = document.getElementById('payPeriod').value;
    
    fetch(`/compensation/api/employee/${selectedEmployee.id}/statement/?period=${payPeriod}`)
        .then(response => response.json())
        .then(data => {
            displayCalculationBreakdown(data);
        })
        .catch(error => {
            console.error('Error calculating compensation:', error);
            displayDummyCalculation();
        });
}

// ê³„ì‚° ìƒì„¸ í‘œì‹œ - displayCalculationBreakdownìœ¼ë¡œ í†µí•©

// ê³„ì‚° ë‚´ì—­ í‘œì‹œ
function displayCalculationBreakdown(data) {
    const comp = data.compensation || {};
    
    // calculationDetails ìš”ì†Œì— ì§ì ‘ ì—…ë°ì´íŠ¸
    const detailsContainer = document.getElementById('calculationDetails');
    if (!detailsContainer) return;
    
    detailsContainer.innerHTML = `
        <!-- Total Compensation Display -->
        <div class="text-center mb-4">
            <p class="text-muted mb-2">ì´ ë³´ìƒì•¡</p>
            <div class="total-compensation">
                â‚© ${(comp.total_compensation || 0).toLocaleString()}
            </div>
            <div class="metric-change positive" style="display: inline-flex;">
                <i class="fas fa-arrow-up"></i>
                <span>ë°ì´í„° ë¡œë“œ ì™„ë£Œ</span>
            </div>
        </div>
        
        <!-- Compensation Breakdown -->
        <div class="compensation-breakdown mt-5">
            <h4 style="color: var(--text-primary); font-size: 18px; margin-bottom: var(--spacing-lg);">êµ¬ì„± í•­ëª©</h4>
            
            <div class="compensation-item">
                <div>
                    <div class="compensation-label">ê¸°ë³¸ê¸‰</div>
                    <small style="color: var(--text-muted);">Base Salary</small>
                </div>
                <div class="compensation-value">â‚©${(comp.base_salary || 0).toLocaleString()}</div>
            </div>
            
            <div class="compensation-item">
                <div>
                    <div class="compensation-label">ê³ ì • OT</div>
                    <small style="color: var(--text-muted);">Fixed Overtime</small>
                </div>
                <div class="compensation-value">â‚©${(comp.fixed_ot || 0).toLocaleString()}</div>
            </div>
            
            <div class="compensation-item">
                <div>
                    <div class="compensation-label">ì§ì±…ê¸‰</div>
                    <small style="color: var(--text-muted);">Position Allowance</small>
                </div>
                <div class="compensation-value">â‚©${(comp.position_allowance || 0).toLocaleString()}</div>
            </div>
            
            <div class="compensation-item">
                <div>
                    <div class="compensation-label">ì—­ëŸ‰ê¸‰</div>
                    <small style="color: var(--text-muted);">Skill Allowance</small>
                </div>
                <div class="compensation-value">â‚©${(comp.competency_allowance || 0).toLocaleString()}</div>
            </div>
            
            <div class="compensation-item">
                <div>
                    <div class="compensation-label">ì„±ê³¼ê¸‰</div>
                    <small style="color: var(--text-muted);">Performance Incentive</small>
                </div>
                <div class="compensation-value">â‚©${(comp.pi_amount || 0).toLocaleString()}</div>
            </div>
        </div>
        
        <!-- Formula Display -->
        <div class="formula-display">
            <strong>ê³„ì‚°ì‹:</strong><br>
            ê¸°ë³¸ê¸‰(${(comp.base_salary || 0).toLocaleString()}) + ê³ ì •OT(${(comp.fixed_ot || 0).toLocaleString()}) + ì§ì±…ê¸‰(${(comp.position_allowance || 0).toLocaleString()}) + ì—­ëŸ‰ê¸‰(${(comp.competency_allowance || 0).toLocaleString()}) + PI(${(comp.pi_amount || 0).toLocaleString()})
        </div>
    `;
}

// ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰
function runSimulation() {
    if (!selectedEmployee) {
        alert('ë¨¼ì € ì§ì›ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }
    
    // ì‹œë®¬ë ˆì´ì…˜ íŒŒë¼ë¯¸í„°
    const params = {
        employee_id: selectedEmployee.id,
        growth_level: document.getElementById('simGrowthLevel').value,
        eval_grade: document.getElementById('simEvalGrade').value,
        position: document.getElementById('simPosition').value,
        period: document.getElementById('payPeriod').value
    };
    
    // ë¡œë”© í‘œì‹œ
    const resultsContainer = document.getElementById('simulationResults');
    resultsContainer.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">ì‹œë®¬ë ˆì´ì…˜ ì¤‘...</span>
            </div>
            <p class="mt-2 text-muted">ì‹œë®¬ë ˆì´ì…˜ ê³„ì‚° ì¤‘...</p>
        </div>
    `;
    
    // API í˜¸ì¶œ (ì‹¤ì œ APIê°€ ì—†ìœ¼ë©´ ë”ë¯¸ ë°ì´í„° ì‚¬ìš©)
    fetch('/compensation/api/simulation/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify(params)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('API not available');
        }
        return response.json();
    })
    .then(data => {
        displaySimulationResults(data);
    })
    .catch(error => {
        console.log('Using dummy simulation data:', error);
        // ë”ë¯¸ ë°ì´í„°ë¡œ ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼ ìƒì„±
        const currentComp = calculateCurrentCompensation();
        const simulatedComp = calculateSimulatedCompensation(currentComp, params);
        displaySimulationResults({
            current: currentComp,
            simulated: simulatedComp,
            params: params
        });
    });
}

// í˜„ì¬ ë³´ìƒ ê³„ì‚°
function calculateCurrentCompensation() {
    // í˜„ì¬ í‘œì‹œëœ ë³´ìƒ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    const totalCompElement = document.querySelector('.total-compensation');
    let currentTotal = 6200000; // ê¸°ë³¸ê°’
    
    if (totalCompElement) {
        const text = totalCompElement.textContent.replace(/[^0-9]/g, '');
        if (text) {
            currentTotal = parseInt(text);
        }
    }
    
    return {
        base_salary: Math.floor(currentTotal * 0.6),
        fixed_ot: Math.floor(currentTotal * 0.12),
        position_allowance: Math.floor(currentTotal * 0.08),
        competency_allowance: Math.floor(currentTotal * 0.05),
        pi_amount: Math.floor(currentTotal * 0.15),
        total_compensation: currentTotal
    };
}

// ì‹œë®¬ë ˆì´ì…˜ ë³´ìƒ ê³„ì‚°
function calculateSimulatedCompensation(current, params) {
    let multiplier = 1.0;
    
    // ì„±ì¥ë ˆë²¨ì— ë”°ë¥¸ ì¡°ì •
    if (params.growth_level) {
        const levelMultipliers = {
            '1': 0.9, '2': 0.95, '3': 1.0, 
            '4': 1.05, '5': 1.1, '6': 1.15
        };
        multiplier *= levelMultipliers[params.growth_level] || 1.0;
    }
    
    // í‰ê°€ë“±ê¸‰ì— ë”°ë¥¸ ì¡°ì •
    if (params.eval_grade) {
        const gradeMultipliers = {
            'S': 1.2, 'A+': 1.15, 'A': 1.1,
            'B+': 1.05, 'B': 1.0, 'C': 0.95, 'D': 0.9
        };
        multiplier *= gradeMultipliers[params.eval_grade] || 1.0;
    }
    
    // ì§ì±…ì— ë”°ë¥¸ ì¡°ì •
    if (params.position) {
        const positionBonuses = {
            'POS01': 500000,  // íŒ€ì¥
            'POS02': 1000000, // ë¶€ë¬¸ì¥
            'POS03': 2000000  // ë³¸ë¶€ì¥
        };
        current.position_allowance = positionBonuses[params.position] || current.position_allowance;
    }
    
    // ìƒˆë¡œìš´ ë³´ìƒ ê³„ì‚°
    const simulated = {
        base_salary: Math.floor(current.base_salary * multiplier),
        fixed_ot: Math.floor(current.fixed_ot * multiplier),
        position_allowance: current.position_allowance,
        competency_allowance: Math.floor(current.competency_allowance * multiplier),
        pi_amount: Math.floor(current.pi_amount * multiplier * 1.1), // PIëŠ” ì¶”ê°€ 10% ë³´ë„ˆìŠ¤
        total_compensation: 0
    };
    
    simulated.total_compensation = simulated.base_salary + simulated.fixed_ot + 
                                   simulated.position_allowance + simulated.competency_allowance + 
                                   simulated.pi_amount;
    
    return simulated;
}

// ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼ í‘œì‹œ
function displaySimulationResults(data) {
    const resultsContainer = document.getElementById('simulationResults');
    const current = data.current;
    const simulated = data.simulated;
    const difference = simulated.total_compensation - current.total_compensation;
    const percentChange = ((difference / current.total_compensation) * 100).toFixed(1);
    
    resultsContainer.innerHTML = `
        <div class="simulation-result-card">
            <h5 class="mb-4" style="color: #ffffff; font-weight: 700; font-size: 22px; text-shadow: 0 2px 10px rgba(0, 212, 255, 0.5);">
                <i class="fas fa-chart-line" style="color: #00d4ff;"></i> ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼
            </h5>
            
            <div class="row mb-4">
                <div class="col-md-6 mb-3">
                    <h6 class="simulation-section-title">
                        <i class="fas fa-wallet"></i> í˜„ì¬ ë³´ìƒ
                    </h6>
                    <div class="simulation-metric">
                        <span>ê¸°ë³¸ê¸‰</span>
                        <span>â‚©${current.base_salary.toLocaleString()}</span>
                    </div>
                    <div class="simulation-metric">
                        <span>ê³ ì • OT</span>
                        <span>â‚©${current.fixed_ot.toLocaleString()}</span>
                    </div>
                    <div class="simulation-metric">
                        <span>ì§ì±…ê¸‰</span>
                        <span>â‚©${current.position_allowance.toLocaleString()}</span>
                    </div>
                    <div class="simulation-metric">
                        <span>ì—­ëŸ‰ê¸‰</span>
                        <span>â‚©${current.competency_allowance.toLocaleString()}</span>
                    </div>
                    <div class="simulation-metric">
                        <span>ì„±ê³¼ê¸‰</span>
                        <span>â‚©${current.pi_amount.toLocaleString()}</span>
                    </div>
                    <div class="simulation-total">
                        <div class="d-flex justify-content-between align-items-center">
                            <strong style="color: #ffffff; font-size: 16px;">ì´ ë³´ìƒ</strong>
                            <strong style="color: #00d4ff; font-size: 20px; text-shadow: 0 0 10px rgba(0, 212, 255, 0.5);">
                                â‚©${current.total_compensation.toLocaleString()}
                            </strong>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6 mb-3">
                    <h6 class="simulation-section-title">
                        <i class="fas fa-rocket"></i> ì˜ˆìƒ ë³´ìƒ
                    </h6>
                    <div class="simulation-metric">
                        <span>ê¸°ë³¸ê¸‰</span>
                        <span ${simulated.base_salary > current.base_salary ? 'style="color: #00ff88;"' : simulated.base_salary < current.base_salary ? 'style="color: #ff4757;"' : ''}>
                            â‚©${simulated.base_salary.toLocaleString()}
                            ${simulated.base_salary > current.base_salary ? ' â†‘' : simulated.base_salary < current.base_salary ? ' â†“' : ''}
                        </span>
                    </div>
                    <div class="simulation-metric">
                        <span>ê³ ì • OT</span>
                        <span ${simulated.fixed_ot > current.fixed_ot ? 'style="color: #00ff88;"' : simulated.fixed_ot < current.fixed_ot ? 'style="color: #ff4757;"' : ''}>
                            â‚©${simulated.fixed_ot.toLocaleString()}
                            ${simulated.fixed_ot > current.fixed_ot ? ' â†‘' : simulated.fixed_ot < current.fixed_ot ? ' â†“' : ''}
                        </span>
                    </div>
                    <div class="simulation-metric">
                        <span>ì§ì±…ê¸‰</span>
                        <span ${simulated.position_allowance > current.position_allowance ? 'style="color: #00ff88;"' : simulated.position_allowance < current.position_allowance ? 'style="color: #ff4757;"' : ''}>
                            â‚©${simulated.position_allowance.toLocaleString()}
                            ${simulated.position_allowance > current.position_allowance ? ' â†‘' : simulated.position_allowance < current.position_allowance ? ' â†“' : ''}
                        </span>
                    </div>
                    <div class="simulation-metric">
                        <span>ì—­ëŸ‰ê¸‰</span>
                        <span ${simulated.competency_allowance > current.competency_allowance ? 'style="color: #00ff88;"' : simulated.competency_allowance < current.competency_allowance ? 'style="color: #ff4757;"' : ''}>
                            â‚©${simulated.competency_allowance.toLocaleString()}
                            ${simulated.competency_allowance > current.competency_allowance ? ' â†‘' : simulated.competency_allowance < current.competency_allowance ? ' â†“' : ''}
                        </span>
                    </div>
                    <div class="simulation-metric">
                        <span>ì„±ê³¼ê¸‰</span>
                        <span ${simulated.pi_amount > current.pi_amount ? 'style="color: #00ff88;"' : simulated.pi_amount < current.pi_amount ? 'style="color: #ff4757;"' : ''}>
                            â‚©${simulated.pi_amount.toLocaleString()}
                            ${simulated.pi_amount > current.pi_amount ? ' â†‘' : simulated.pi_amount < current.pi_amount ? ' â†“' : ''}
                        </span>
                    </div>
                    <div class="simulation-total">
                        <div class="d-flex justify-content-between align-items-center">
                            <strong style="color: #ffffff; font-size: 16px;">ì´ ë³´ìƒ</strong>
                            <strong style="color: #00ff88; font-size: 20px; text-shadow: 0 0 10px rgba(0, 255, 136, 0.5);">
                                â‚©${simulated.total_compensation.toLocaleString()}
                            </strong>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="simulation-change-box text-center">
                <h5 style="color: #ffffff; font-weight: 600;">
                    <i class="fas fa-exchange-alt" style="color: #00d4ff;"></i> ë³´ìƒ ë³€í™”ëŸ‰
                </h5>
                <div class="d-flex justify-content-center align-items-center gap-4">
                    <span class="${difference >= 0 ? 'simulation-change-positive' : 'simulation-change-negative'}" style="font-size: 28px;">
                        ${difference >= 0 ? 'â†‘' : 'â†“'} ${difference >= 0 ? '+' : ''}â‚©${Math.abs(difference).toLocaleString()}
                    </span>
                    <span class="${difference >= 0 ? 'simulation-change-positive' : 'simulation-change-negative'}" style="font-size: 24px;">
                        (${difference >= 0 ? '+' : ''}${percentChange}%)
                    </span>
                </div>
                ${difference !== 0 ? `
                <div class="mt-3">
                    <span style="color: rgba(255, 255, 255, 0.8); font-size: 14px;">
                        ${difference > 0 ? 'ğŸ† ì˜ˆìƒ ë³´ìƒì´ ì¦ê°€í•©ë‹ˆë‹¤!' : 'ğŸ“‰ ì˜ˆìƒ ë³´ìƒì´ ê°ì†Œí•©ë‹ˆë‹¤.'}
                    </span>
                </div>
                ` : ''}
            </div>
        </div>
    `;
}

// CSRF í† í° ê°€ì ¸ì˜¤ê¸°
function getCsrfToken() {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfToken) {
        return csrfToken.value;
    }
    // ì¿ í‚¤ì—ì„œ ê°€ì ¸ì˜¤ê¸°
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'csrftoken') {
            return value;
        }
    }
    return '{{ csrf_token }}';
}

// ê³„ì‚° ì‹¤í–‰
function runCalculation() {
    const payPeriod = document.getElementById('payPeriod').value;
    
    if (!payPeriod) {
        alert('ê¸‰ì—¬ ê¸°ê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }
    
    // ì „ì²´ ê³„ì‚° ì‹¤í–‰
    fetch('/compensation/api/snapshot/run/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            period: payPeriod,
            employee_ids: selectedEmployee ? [selectedEmployee.id] : null
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'completed') {
            alert('ê³„ì‚°ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
            if (selectedEmployee) {
                calculateCompensation();
            }
        } else {
            alert('ê³„ì‚° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    })
    .catch(error => {
        console.error('Error running calculation:', error);
        alert('ê³„ì‚° ì‹¤í–‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    });
}

// ë”ë¯¸ ë°ì´í„° í‘œì‹œ (API ì—°ê²° ì „ í…ŒìŠ¤íŠ¸ìš©)
function displayDummyEmployees() {
    const employees = [
        {id: 1, name: 'ê¹€ì² ìˆ˜', employee_id: 'E001', department: 'ê°œë°œíŒ€', employment_type: 'ì •ê·œì§'},
        {id: 2, name: 'ì´ì˜í¬', employee_id: 'E002', department: 'ì˜ì—…íŒ€', employment_type: 'Non-PL'},
        {id: 3, name: 'ë°•ë¯¼ìˆ˜', employee_id: 'E003', department: 'ê¸°íšíŒ€', employment_type: 'PL'},
    ];
    
    const listContainer = document.getElementById('employeeList');
    listContainer.innerHTML = '';
    
    employees.forEach(employee => {
        const item = document.createElement('div');
        item.className = 'employee-item';
        item.onclick = () => selectEmployee(employee);
        item.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <strong style="color: var(--text-primary);">${employee.name}</strong>
                    <small class="d-block" style="color: var(--text-muted);">${employee.employee_id} Â· ${employee.department}</small>
                </div>
                <div class="text-end">
                    <small class="gradient-text">${employee.employment_type}</small>
                </div>
            </div>
        `;
        listContainer.appendChild(item);
    });
}

function displayDummyCalculation() {
    const dummyData = {
        employee: {
            name: selectedEmployee?.name || 'ê¹€ì² ìˆ˜',
            department: selectedEmployee?.department || 'ê°œë°œíŒ€',
            position: 'íŒ€ì¥',
            employment_type: selectedEmployee?.employment_type || 'ì •ê·œì§'
        },
        compensation: {
            base_salary: 4500000,
            fixed_ot: 645933,
            position_allowance: 800000,
            competency_allowance: 450000,
            pi_amount: 0,
            monthly_pi_amount: 0,
            holiday_bonus: 0,
            ordinary_wage: 5750000,
            total_compensation: 6395933
        }
    };
    
    displayCalculationBreakdown(dummyData);
}

// ê²€ìƒ‰ ì´ë²¤íŠ¸
document.getElementById('employeeSearch').addEventListener('input', loadEmployees);
document.getElementById('employmentType').addEventListener('change', loadEmployees);
</script>
{% endblock %}